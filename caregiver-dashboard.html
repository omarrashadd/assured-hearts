<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Caregiver Dashboard - Assured Hearts</title>
    <meta name="description" content="Manage your caregiver dashboard, sessions, and families." />
    <link rel="stylesheet" href="style.css">
  </head>

  <body class="provider-dashboard">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-center-title" aria-hidden="true">Assured Hearts</div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <button id="topProfileBtn" class="provider-top-profile-btn provider-nav-item provider-nav-icon-btn" type="button" data-panel="profile" aria-label="My profile">
          <img class="provider-top-profile-img" alt="" loading="lazy">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-3.314 0-8 1.664-8 5v3h16v-3c0-3.336-4.686-5-8-5z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </nav>

    <div id="mobileMenu" class="mobile-menu-panel hidden" aria-hidden="true">
      <button id="mobileMenuClose" class="mobile-menu-close" aria-label="Close menu">&times;</button>
      <nav class="mobile-nav">
        <a href="find-childcare.html">Find Childcare</a>
        <a href="become-provider.html">Join Our Care Network</a>
        <a href="care-process.html">Our Care Process</a>
        <a href="learning.html">At-Home Learning</a>
        <a href="caregiver-dashboard.html">Dashboard</a>
      </nav>
    </div>

    <main class="provider-shell">
      <aside class="provider-sidebar">
        <div class="provider-sidebar-header">
          <span class="provider-sidebar-eyebrow">Caregiver Portal</span>
          <div class="provider-sidebar-title">Assured Hearts</div>
          <div id="providerSidebarName" class="provider-sidebar-name">Signed in</div>
        </div>

        <nav class="provider-nav" role="tablist" aria-label="Provider dashboard sections">
          <button id="tab-dashboard" class="provider-nav-item is-active" type="button" role="tab" aria-selected="true" aria-controls="panel-dashboard" data-panel="dashboard" aria-label="Home">
            <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M3 11.2 12 4l9 7.2V20a1 1 0 0 1-1 1h-5.5v-6.5h-5V21H4a1 1 0 0 1-1-1z" fill="currentColor"/>
            </svg>
            <span class="nav-label">Home</span>
          </button>
          <button id="tab-calendar" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-calendar" data-panel="calendar" aria-label="Calendar">
            <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v13a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V6a2 2 0 0 1 2-2h1V3a1 1 0 0 1 1-1zm12 8H5v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1z" fill="currentColor"/>
            </svg>
            <span class="nav-label">Calendar</span>
          </button>
          <button id="tab-inbox" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-inbox" data-panel="inbox" aria-label="Messages">
            <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M4 4h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H9l-5 5v-5H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z" fill="currentColor"/>
            </svg>
            <span class="nav-label">Messages</span>
            <span class="provider-nav-badge" aria-live="polite"></span>
          </button>
          <button id="tab-availability" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-availability" data-panel="availability">Availability</button>
          <button id="tab-families" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-families" data-panel="families">My Families</button>
          <button id="tab-curriculum" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-curriculum" data-panel="curriculum">Curriculum Library</button>
          <button id="tab-profile" class="provider-nav-item provider-nav-icon-btn provider-nav-profile" type="button" role="tab" aria-selected="false" aria-controls="panel-profile" data-panel="profile" aria-label="My profile">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-3.314 0-8 1.664-8 5v3h16v-3c0-3.336-4.686-5-8-5z" fill="currentColor"/>
            </svg>
          </button>
        </nav>

        <div class="provider-sidebar-footer">
          <div class="provider-sidebar-actions">
            <button id="providerLogout" class="provider-logout" type="button">Log out</button>
            <button id="providerCurriculumBtn" class="provider-curriculum-btn" type="button">Curriculum Library</button>
          </div>
        </div>
      </aside>

      <section class="provider-content">
        <header class="provider-content-header">
          <div>
            <p class="provider-eyebrow">Dashboard</p>
            <h1 class="provider-title">Welcome back<span id="providerWelcomeName"></span></h1>
            <p class="provider-subtitle">Your caregiver hub for sessions, families, and learning tools.</p>
          </div>
          <div class="provider-header-actions">
            <button id="openProfileBtn" class="provider-header-btn provider-profile-btn" type="button">My Profile</button>
          </div>
        </header>

        <div class="provider-panels">
          <section id="panel-dashboard" class="provider-panel is-active" role="tabpanel" aria-labelledby="tab-dashboard">
            <div class="provider-kpi-grid">
              <div class="provider-kpi-card">
                <p class="provider-kpi-label">Monthly Earnings</p>
                <p id="metricMonthlyEarnings" class="provider-kpi-value">$0</p>
                <p class="provider-kpi-foot">This month</p>
              </div>
              <div class="provider-kpi-card">
                <p class="provider-kpi-label">Total session hours this month</p>
                <p id="metricMonthlyHours" class="provider-kpi-value">0</p>
                <p class="provider-kpi-foot">Completed and scheduled</p>
              </div>
            </div>
            <div class="provider-dashboard-grid">
              <section class="provider-bookings-card">
                <div class="provider-card-head">
                  <div>
                    <h2>Upcoming bookings</h2>
                    <p class="provider-card-sub">Next sessions on your calendar.</p>
                  </div>
                  <span id="upcomingCount" class="provider-card-pill">0 upcoming</span>
                </div>
                <div class="provider-bookings-table">
                  <div class="provider-bookings-row provider-bookings-head">
                    <div class="provider-booking-cell">Child</div>
                    <div class="provider-booking-cell">Family</div>
                    <div class="provider-booking-cell">Hours booked</div>
                    <div class="provider-booking-cell">Estimated earnings</div>
                    <div class="provider-booking-cell">Time scheduled</div>
                  </div>
                  <div id="upcomingBookingsList" class="provider-bookings-body">
                    <div class="provider-bookings-empty">No upcoming bookings yet.</div>
                  </div>
                </div>
              </section>
              <section class="provider-requests-card">
                <div class="provider-card-head">
                  <div>
                    <h2>My requests</h2>
                    <p class="provider-card-sub">Requests sent to you.</p>
                  </div>
                  <div class="provider-card-actions">
                    <button id="providerRequestsToggle" class="provider-requests-toggle" type="button">Cancelled requests</button>
                    <span id="areaRequestsCount" class="provider-card-pill">0 requests</span>
                  </div>
                </div>
                <div class="provider-requests-table">
                  <div class="provider-requests-row provider-requests-head">
                    <div class="provider-requests-cell">Child</div>
                    <div class="provider-requests-cell">Family</div>
                    <div class="provider-requests-cell">Hours requested</div>
                    <div class="provider-requests-cell">Estimated earnings</div>
                    <div class="provider-requests-cell">Status</div>
                  </div>
                  <div id="areaRequestsList" class="provider-requests-body">
                    <div class="provider-requests-empty">No requests yet.</div>
                  </div>
                </div>
              </section>
              <section class="provider-chart-card">
                <div class="provider-card-head">
                  <div>
                    <h2>Insights</h2>
                    <p class="provider-card-sub">Snapshot of the families you serve and your performance.</p>
                  </div>
                </div>
                <div class="provider-pie-grid">
                  <div class="provider-mini-card">
                    <h3>Age ranges booked</h3>
                    <p class="provider-mini-sub">Which ages you work with the most.</p>
                    <div class="provider-chart-wrap">
                      <div id="ageMixPie" class="provider-pie provider-pie-ages" role="img" aria-label="Infants and toddlers 0 percent, early childhood 0 percent, school-age 0 percent">
                        <div class="provider-pie-center">
                          <span id="ageMixPrimary" class="provider-pie-value">0%</span>
                          <span id="ageMixPrimaryLabel" class="provider-pie-label">Top age group</span>
                        </div>
                      </div>
                    </div>
                    <div class="provider-legend">
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-ages-1"></span> Infants &amp; Toddlers 1-3 <strong id="ageMixInfants">0</strong></div>
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-ages-2"></span> Early Childhood 3-6 <strong id="ageMixEarly">0</strong></div>
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-ages-3"></span> School-Age 7-12 <strong id="ageMixSchool">0</strong></div>
                    </div>
                  </div>
                  <div class="provider-mini-card">
                    <h3>Successful bookings</h3>
                    <p class="provider-mini-sub">Tracks cancellations vs completed bookings.</p>
                    <div class="provider-chart-wrap">
                      <div id="successRatePie" class="provider-pie provider-pie-success" role="img" aria-label="Success rate 0 percent, cancellations 0 percent">
                        <div class="provider-pie-center">
                          <span id="successRateValue" class="provider-pie-value">0%</span>
                          <span class="provider-pie-label">Success rate</span>
                        </div>
                      </div>
                    </div>
                    <div class="provider-legend">
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-success"></span> Successful <strong id="successCount">0</strong></div>
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-cancelled"></span> Cancelled <strong id="cancelCount">0</strong></div>
                    </div>
                  </div>
                  <div class="provider-mini-card">
                    <h3>Repeat families</h3>
                    <p class="provider-mini-sub">Families who have booked you again.</p>
                    <div class="provider-chart-wrap">
                      <div id="repeatFamiliesPie" class="provider-pie provider-pie-repeat" role="img" aria-label="Repeat families 0 percent, new families 0 percent">
                        <div class="provider-pie-center">
                          <span id="repeatFamiliesPercent" class="provider-pie-value">0%</span>
                          <span class="provider-pie-label">Repeat families</span>
                        </div>
                      </div>
                    </div>
                    <div class="provider-legend">
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-repeat"></span> Repeat families <strong id="repeatFamiliesCount">0</strong></div>
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-new"></span> New families <strong id="repeatFamiliesNewCount">0</strong></div>
                    </div>
                  </div>
                </div>
                <div class="provider-earnings-block">
                  <div class="provider-card-head">
                    <div>
                      <h2>Earnings breakdown</h2>
                      <p class="provider-card-sub">Where your income is coming from this month.</p>
                    </div>
                    <span id="earningsTotal" class="provider-card-pill">$0 total</span>
                  </div>
                  <div class="provider-earnings-bar" role="img" aria-label="Earnings split across sessions, tips, and bonuses.">
                    <span id="earnSegSessions" class="earn-seg earn-sessions"></span>
                    <span id="earnSegTips" class="earn-seg earn-tips"></span>
                    <span id="earnSegBonuses" class="earn-seg earn-bonuses"></span>
                  </div>
                  <div id="earningsEmpty" class="provider-earnings-empty">No earnings data yet.</div>
                  <div class="provider-earnings-grid">
                    <div class="provider-earnings-item"><span class="provider-dot provider-dot-sessions"></span> Session earnings <strong id="earnSessionsValue">$0</strong></div>
                    <div class="provider-earnings-item"><span class="provider-dot provider-dot-tips"></span> Tips <strong id="earnTipsValue">$0</strong></div>
                    <div class="provider-earnings-item"><span class="provider-dot provider-dot-bonuses"></span> Bonuses <strong id="earnBonusesValue">$0</strong></div>
                  </div>
                </div>
              </section>
            </div>
          </section>

          <section id="panel-calendar" class="provider-panel" role="tabpanel" aria-labelledby="tab-calendar" hidden>
            <div class="provider-panel-card">
              <h2>Calendar</h2>
              <p>View your upcoming sessions and availability here.</p>
            </div>
          </section>

          <section id="panel-inbox" class="provider-panel" role="tabpanel" aria-labelledby="tab-inbox" hidden>
            <div class="provider-panel-card">
              <div class="provider-card-head">
                <div>
                  <h2>Messages</h2>
                  <p class="provider-card-sub">Stay connected with families and support.</p>
                </div>
                <span id="providerMessagesUnread" class="provider-card-pill" style="display:none;">0 unread</span>
              </div>
              <div id="providerMessagesList" class="parent-messages-list">
                <div class="provider-bookings-empty">No messages yet.</div>
              </div>
              <button id="providerMessagesOpenBtn" class="provider-header-btn" type="button">Open messages</button>
            </div>
          </section>

          <section id="panel-availability" class="provider-panel" role="tabpanel" aria-labelledby="tab-availability" hidden>
            <div class="provider-panel-card provider-availability-card">
              <div class="provider-card-head">
                <div>
                  <h2>Set availability</h2>
                  <p class="provider-card-sub">Set the hours when you are available for sessions.</p>
                </div>
              </div>
              <div id="availabilityEditor" class="availability-editor" aria-live="polite"></div>
              <div class="availability-actions">
                <span id="availabilityStatus" class="availability-status">Changes save to your live profile.</span>
                <div class="availability-buttons">
                  <button id="availabilityCancelBtn" class="availability-btn availability-btn-ghost" type="button">Cancel</button>
                  <button id="availabilitySaveBtn" class="availability-btn" type="button">Save</button>
                </div>
              </div>
            </div>
          </section>

          <section id="panel-families" class="provider-panel" role="tabpanel" aria-labelledby="tab-families" hidden>
            <div class="provider-panel-card">
              <h2>My Families</h2>
              <p>Manage family profiles and ongoing sessions here.</p>
            </div>
          </section>

          <section id="panel-curriculum" class="provider-panel" role="tabpanel" aria-labelledby="tab-curriculum" hidden>
            <div class="provider-panel-card">
              <h2>Curriculum Library</h2>
              <p>Access curriculum resources, activities, and learning guides here.</p>
            </div>
          </section>

          <section id="panel-profile" class="provider-panel" role="tabpanel" aria-labelledby="tab-profile" hidden>
            <div class="provider-panel-card provider-profile-card">
              <div class="provider-card-head provider-profile-head">
                <div>
                  <h2>My Profile</h2>
                  <p class="provider-card-sub">Update your contact details, payout preferences, and public info.</p>
                </div>
                <button id="profileBackBtn" class="provider-header-btn provider-header-btn-ghost" type="button">Back to Dashboard</button>
              </div>
              <form id="providerProfileForm" class="provider-profile-form">
                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>First name</span>
                    <input type="text" name="first_name" id="provFirstName" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Last name</span>
                    <input type="text" name="last_name" id="provLastName" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Email (login)</span>
                    <input type="email" name="email" id="provEmail" class="provider-input" readonly>
                  </label>
                  <label class="provider-form-field">
                    <span>Phone</span>
                    <input type="tel" name="phone" id="provPhone" class="provider-input">
                  </label>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Address line 1</span>
                    <input type="text" name="address_line1" id="provAddr1" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>City</span>
                    <input type="text" name="city" id="provCity" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Province/State</span>
                    <input type="text" name="province" id="provProvince" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Postal/ZIP</span>
                    <input type="text" name="postal_code" id="provPostal" class="provider-input">
                  </label>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Payout method</span>
                    <select name="payout_method" id="provPayoutMethod" class="provider-input">
                      <option value="">Select</option>
                      <option value="etransfer">Interac e-Transfer</option>
                      <option value="direct_deposit">Direct deposit</option>
                      <option value="paypal">PayPal</option>
                    </select>
                  </label>
                  <label class="provider-form-field">
                    <span>Languages spoken</span>
                    <div class="language-input">
                      <div id="provLanguagesChips" class="language-chips" aria-live="polite"></div>
                      <div class="language-entry">
                        <input type="text" id="provLanguageInput" class="provider-input" list="languageOptions" placeholder="Start typing a language">
                        <button type="button" id="provLanguageAdd" class="language-add-btn">Add</button>
                      </div>
                      <input type="hidden" name="languages" id="provLanguages">
                      <datalist id="languageOptions">
                        <option value="Arabic"></option>
                        <option value="Burmese"></option>
                        <option value="Bengali"></option>
                        <option value="Cantonese"></option>
                        <option value="Czech"></option>
                        <option value="Dari"></option>
                        <option value="Dutch"></option>
                        <option value="English"></option>
                        <option value="Farsi"></option>
                        <option value="French"></option>
                        <option value="German"></option>
                        <option value="Greek"></option>
                        <option value="Gujarati"></option>
                        <option value="Hausa"></option>
                        <option value="Hebrew"></option>
                        <option value="Hindi"></option>
                        <option value="Italian"></option>
                        <option value="Japanese"></option>
                        <option value="Korean"></option>
                        <option value="Malay"></option>
                        <option value="Malayalam"></option>
                        <option value="Mandarin"></option>
                        <option value="Marathi"></option>
                        <option value="Nepali"></option>
                        <option value="Polish"></option>
                        <option value="Portuguese"></option>
                        <option value="Punjabi"></option>
                        <option value="Romanian"></option>
                        <option value="Russian"></option>
                        <option value="Spanish"></option>
                        <option value="Swedish"></option>
                        <option value="Somali"></option>
                        <option value="Swahili"></option>
                        <option value="Tagalog"></option>
                        <option value="Tamil"></option>
                        <option value="Telugu"></option>
                        <option value="Thai"></option>
                        <option value="Turkish"></option>
                        <option value="Ukrainian"></option>
                        <option value="Urdu"></option>
                        <option value="Vietnamese"></option>
                        <option value="Yoruba"></option>
                      </datalist>
                    </div>
                    <small>Shown on your public profile. Start typing and press Enter to add.</small>
                  </label>
                  <label class="provider-form-field provider-photo-field">
                    <span>Profile photo</span>
                    <div class="profile-photo-row">
                      <div id="provPhotoPreview" class="profile-photo-preview">
                        <img id="provPhotoImg" alt="" loading="lazy">
                        <span id="provPhotoInitials">AH</span>
                      </div>
                      <div class="profile-photo-actions">
                        <input type="file" id="provPhotoInput" class="profile-photo-input" accept="image/*" capture="user">
                        <button type="button" id="provPhotoUploadBtn" class="provider-header-btn provider-header-btn-ghost">Upload photo</button>
                        <div id="provPhotoStatus" class="profile-photo-status">PNG or JPG up to 5MB.</div>
                      </div>
                    </div>
                    <input type="hidden" name="photo_url" id="provPhotoUrl">
                  </label>
                </div>

                <div class="provider-form-grid">
                  <div class="provider-form-field">
                    <span>Verification (read only)</span>
                    <div class="provider-verify-row" id="provVerifyRow">
                      <!-- badges injected via script -->
                    </div>
                    <small style="color:#9ca3af;">Updated by Assured Hearts after manual verification.</small>
                  </div>
                  <label class="provider-form-field provider-form-field-wide">
                    <span>About</span>
                    <textarea name="about" id="provAbout" class="provider-textarea" rows="4" placeholder="Share a short introduction for families..."></textarea>
                  </label>
                </div>

                <div class="provider-form-actions">
                  <button type="submit" class="provider-primary-btn">Save changes</button>
                  <button type="button" id="provDelete" class="provider-secondary-btn">Delete account</button>
                  <div id="provStatus" class="provider-form-status"></div>
                </div>
              </form>
              <div class="dashboard-profile-links">
                <a href="care-process.html">Our Care Process</a>
                <a href="become-provider.html">Join Our Care Network</a>
                <a href="learning.html">At-Home Learning</a>
                <a href="terms-of-service.html">Terms of Service</a>
                <a href="privacy-policy.html">Privacy Policy</a>
                <a href="disclaimers.html">Disclaimers</a>
              </div>
            </div>
          </section>
        </div>
      </section>
    </main>

    <footer style="background: #06464E; color: white; padding: 32px 24px; text-align: center; margin-top: 48px;">
      <p style="margin: 0;">Â© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
      const activateProviderPanel = (panelId) => {
        const navItems = Array.from(document.querySelectorAll('.provider-nav-item'));
        const panels = Array.from(document.querySelectorAll('.provider-panel'));
        const navTarget = panelId;
        navItems.forEach((btn) => {
          const isActive = btn.dataset.panel === navTarget;
          btn.classList.toggle('is-active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        panels.forEach((panel) => {
          const isActive = panel.id === `panel-${panelId}`;
          panel.classList.toggle('is-active', isActive);
          panel.hidden = !isActive;
        });
      };

      document.querySelectorAll('.provider-nav-item').forEach((btn) => {
        btn.addEventListener('click', () => {
          const panel = btn.dataset.panel;
          if(!panel) return;
          const isMobile = window.matchMedia('(max-width: 719px)').matches;
          if(panel === 'inbox' && isMobile && typeof window.showChatWidget === 'function'){
            activateProviderPanel(panel);
            window.showChatWidget();
            return;
          }
          if(isMobile && panel !== 'inbox' && typeof window.hideChatWidget === 'function'){
            window.hideChatWidget();
          }
          activateProviderPanel(panel);
        });
        btn.addEventListener('keydown', (event) => {
          if(event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            btn.click();
          }
        });
      });

      const initialPanel = window.location.hash.replace('#', '');
      activateProviderPanel(initialPanel || 'dashboard');

      document.getElementById('openProfileBtn')?.addEventListener('click', () => {
        window.location.hash = 'profile';
        activateProviderPanel('profile');
      });
      document.getElementById('topProfileBtn')?.addEventListener('click', () => {
        window.location.hash = 'profile';
        activateProviderPanel('profile');
      });
      document.getElementById('profileBackBtn')?.addEventListener('click', () => {
        window.location.hash = 'dashboard';
        activateProviderPanel('dashboard');
      });

      const logoutHandler = () => {
        if(confirm('Are you sure you want to log out?')) {
          localStorage.removeItem('user_id');
          localStorage.removeItem('user_type');
          window.location.href = 'index.html';
        }
      };
      document.getElementById('providerLogout')?.addEventListener('click', logoutHandler);
      document.getElementById('providerCurriculumBtn')?.addEventListener('click', () => {
        window.location.hash = 'curriculum';
        activateProviderPanel('curriculum');
      });

      const formatCurrency = (value) => {
        const num = Number(value);
        if(Number.isNaN(num)) return '$0';
        return `$${num.toLocaleString('en-CA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };

      const formatHours = (value) => {
        const num = Number(value);
        if(Number.isNaN(num)) return '0';
        return num.toFixed(1).replace(/\.0$/, '');
      };

      const toDate = (value) => {
        if(!value) return null;
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? null : date;
      };

      const minutesFromTime = (timeStr) => {
        if(!timeStr) return null;
        const parts = timeStr.split(':').map(Number);
        if(parts.length < 2 || parts.some((p) => Number.isNaN(p))) return null;
        return (parts[0] * 60) + parts[1];
      };

      const durationHours = (entry) => {
        if(entry.start_time && entry.end_time) {
          const start = minutesFromTime(entry.start_time);
          const end = minutesFromTime(entry.end_time);
          if(start === null || end === null) return 0;
          return Math.max(0, (end - start) / 60);
        }
        if(entry.start_at && entry.end_at) {
          const start = new Date(entry.start_at);
          const end = new Date(entry.end_at);
          if(Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return 0;
          return Math.max(0, (end - start) / (1000 * 60 * 60));
        }
        return 0;
      };

      const computeMonthlyHours = (requests) => {
        const monthKey = new Date().toISOString().slice(0, 7);
        const acceptedRequests = (requests || []).filter((req) => {
          const status = String(req.status || '').toLowerCase();
          return status === 'accepted' || status === 'confirmed';
        });
        return acceptedRequests.reduce((total, entry) => {
          const dateValue = entry.session_date || entry.date || entry.start_at;
          const entryDate = toDate(dateValue);
          if(!entryDate) return total;
          if(entryDate.toISOString().slice(0, 7) !== monthKey) return total;
          return total + durationHours(entry);
        }, 0);
      };

      const formatDateLabel = (date) => date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });

      const formatTimeLabel = (timeStr) => {
        if(!timeStr) return '';
        const parts = timeStr.split(':').map(Number);
        if(parts.length < 2 || parts.some((p) => Number.isNaN(p))) return timeStr;
        const base = new Date();
        base.setHours(parts[0], parts[1], 0, 0);
        return base.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' });
      };

      const getStartDate = (entry) => {
        if(entry.start_at) return toDate(entry.start_at);
        const dateValue = entry.session_date || entry.date;
        if(!dateValue) return null;
        const timeValue = entry.start_time || '00:00';
        return toDate(`${dateValue}T${timeValue}`);
      };

      const formatScheduleLabel = (entry) => {
        if(entry.start_at && entry.end_at) {
          const start = toDate(entry.start_at);
          const end = toDate(entry.end_at);
          if(!start || !end) return 'TBD';
          return `${formatDateLabel(start)} ${start.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })} - ${end.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })}`;
        }
        if(entry.session_date) {
          const date = toDate(entry.session_date);
          if(!date) return 'TBD';
          if(entry.start_time && entry.end_time) {
            return `${formatDateLabel(date)} ${formatTimeLabel(entry.start_time)} - ${formatTimeLabel(entry.end_time)}`;
          }
          return `${formatDateLabel(date)}`;
        }
        return 'TBD';
      };

      const resolveEstimatedEarningsCents = (entry) => {
        const hours = durationHours(entry) || entry.pricing_snapshot?.hours || 0;
        const snapshot = typeof entry.pricing_snapshot === 'string'
          ? (() => {
              try { return JSON.parse(entry.pricing_snapshot); } catch(_e){ return null; }
            })()
          : entry.pricing_snapshot;
        const direct = Number(snapshot?.provider_earnings_cents ?? 0);
        if(Number.isFinite(direct) && direct > 0) return Math.round(direct);
        const providerPerHour = Number(snapshot?.provider_fee_cents ?? 0);
        if(Number.isFinite(providerPerHour) && providerPerHour > 0) {
          return Math.round(providerPerHour * (hours || 1));
        }
        let hourlyRate = Number(
          snapshot?.hourly_rate_cents ??
          entry.hourly_rate_cents ??
          0
        );
        const providerShare = 0.7;
        const totalBookingCents = Number(
          entry.payment_amount_cents ??
          entry.total_booking_cents ??
          snapshot?.total_booking_cents ??
          0
        );
        if((!Number.isFinite(hourlyRate) || hourlyRate <= 0) && Number.isFinite(totalBookingCents) && totalBookingCents > 0) {
          return Math.round(totalBookingCents * providerShare);
        }
        if(!Number.isFinite(hourlyRate) || hourlyRate <= 0) return 0;
        return Math.round(hourlyRate * providerShare * (hours || 1));
      };

      const formatChildDisplay = (entry) => {
        const raw = entry.child_names || entry.child_name || entry.childName || entry.child || '';
        let names = [];
        if(Array.isArray(raw)) {
          names = raw;
        } else {
          names = String(raw || '').split(',').map((name) => name.trim()).filter(Boolean);
        }
        if(names.length === 0) {
          const first = entry.child_first_name || entry.childFirstName || '';
          const last = entry.child_last_name || entry.childLastName || '';
          const fallback = `${first} ${last}`.trim();
          return { label: fallback || 'Child', count: fallback ? 1 : 0 };
        }
        if(names.length === 1) return { label: names[0], count: 1 };
        return { label: `${names[0]} +${names.length - 1}`, count: names.length };
      };

      const resolveFamilyLabel = (entry) => {
        let lastName = entry.family_last_name || entry.child_last_name || entry.childLastName || '';
        if(!lastName) {
          const parentName = entry.parent_name || entry.parentName || entry.family_name || entry.family || '';
          const parts = String(parentName || '').trim().split(/\s+/);
          lastName = parts.length ? parts[parts.length - 1] : '';
        }
        if(!lastName) return 'Family';
        return lastName;
      };

      const resolveBookingAddress = (entry) => {
        return entry.location || entry.address || entry.booking_address || entry.address_line1 || '';
      };

      let providerRequestsCache = [];
      let providerStatsCache = {};
      let providerApiBase = '';
      let providerRequestsView = 'pending';

      const updateProviderMetrics = (requests) => {
        const acceptedRequests = (requests || []).filter((req) => {
          const status = String(req.status || '').toLowerCase();
          return status === 'accepted' || status === 'confirmed';
        });
        const earnings = acceptedRequests.reduce((total, entry) => {
          const cents = resolveEstimatedEarningsCents(entry);
          return total + (cents ? cents / 100 : 0);
        }, 0);
        const monthHours = computeMonthlyHours(requests || []);
        const earningsEl = document.getElementById('metricMonthlyEarnings');
        if(earningsEl) earningsEl.textContent = formatCurrency(earnings);
        const hoursEl = document.getElementById('metricMonthlyHours');
        if(hoursEl) hoursEl.textContent = formatHours(monthHours);
      };

      const buildUpcomingBookings = (requests) => {
        const acceptedRequests = (requests || [])
          .filter((req) => {
            const status = String(req.status || '').toLowerCase();
            return status === 'accepted' || status === 'confirmed';
          })
          .map((req) => ({
            id: req.id || `req-${Math.random().toString(36).slice(2)}`,
            request_id: req.id || null,
            child_name: req.child_name || req.childName || req.child,
            child_first_name: req.child_first_name || req.childFirstName,
            child_last_name: req.child_last_name || req.childLastName,
            family_last_name: req.family_last_name || req.child_last_name || req.childLastName,
            parent_name: req.parent_name || req.parentName || req.family_name || req.family,
            parent_id: req.parent_id || req.parentId || req.parent_user_id || req.parent,
            start_at: req.start_at,
            end_at: req.end_at,
            session_date: req.session_date || req.date || (req.start_at ? String(req.start_at).slice(0, 10) : null),
            start_time: req.start_time,
            end_time: req.end_time,
            pricing_snapshot: req.pricing_snapshot || req.pricingSnapshot || null,
            hourly_rate_cents: req.hourly_rate_cents || null,
            payment_amount_cents: req.payment_amount_cents || null,
            payment_currency: req.payment_currency || null,
            status: req.status || 'accepted',
            location: req.location || req.address || req.booking_address || null
          }));
        const upcoming = acceptedRequests.filter((entry) => {
          if(isCancelled(entry)) return false;
          const start = getStartDate(entry);
          if(!start) return true;
          return start >= new Date();
        });
        return upcoming.sort((a, b) => {
          const aStart = getStartDate(a);
          const bStart = getStartDate(b);
          if(!aStart && !bStart) return 0;
          if(!aStart) return 1;
          if(!bStart) return -1;
          return aStart - bStart;
        });
      };

      const renderUpcomingBookings = (requests) => {
        const upcoming = buildUpcomingBookings(requests);
        const listEl = document.getElementById('upcomingBookingsList');
        const countEl = document.getElementById('upcomingCount');
        if(countEl) countEl.textContent = `${upcoming.length} upcoming`;
        if(listEl) {
          if(upcoming.length === 0) {
            listEl.innerHTML = '<div class="provider-bookings-empty">No upcoming bookings yet.</div>';
          } else {
            listEl.innerHTML = upcoming.map((entry) => {
              const childDisplay = formatChildDisplay(entry);
              const familyLabel = resolveFamilyLabel(entry);
              const hoursValue = durationHours(entry);
              const hoursLabel = hoursValue ? `${formatHours(hoursValue)} hrs` : 'TBD';
              const earningsCents = resolveEstimatedEarningsCents(entry);
              const earningsLabel = earningsCents ? formatCurrency(earningsCents / 100) : '$0';
              const timeLabel = formatScheduleLabel(entry);
              const addressLabel = resolveBookingAddress(entry) || 'Address not provided';
              const requestId = entry.request_id || entry.id || '';
              return `
                <div class="provider-bookings-row provider-bookings-item" data-request-id="${requestId}">
                  <div class="provider-booking-cell" data-label="Child">
                    <div class="booking-child">
                      <span>${childDisplay.label}</span>
                      <button class="booking-address-btn" type="button">View address</button>
                    </div>
                  </div>
                  <div class="provider-booking-cell" data-label="Family">${familyLabel}</div>
                  <div class="provider-booking-cell" data-label="Hours booked">${hoursLabel}</div>
                  <div class="provider-booking-cell" data-label="Estimated earnings">${earningsLabel}</div>
                  <div class="provider-booking-cell" data-label="Time scheduled">
                    <div class="booking-time-row">
                      <span>${timeLabel}</span>
                      ${requestId ? `<button class="provider-cancel-btn" type="button" data-request-id="${requestId}">Cancel</button>` : ''}
                    </div>
                  </div>
                  <div class="provider-booking-cell provider-booking-address" data-label="Address">
                    <span class="booking-address-text">${addressLabel}</span>
                    <button class="booking-back-btn" type="button">Go back</button>
                  </div>
                </div>
              `;
            }).join('');
          }
        }
        if(listEl && !listEl.dataset.addressBound) {
          listEl.addEventListener('click', (event) => {
            const viewBtn = event.target.closest('.booking-address-btn');
            if(viewBtn) {
              const row = viewBtn.closest('.provider-bookings-item');
              if(row) row.classList.add('is-address');
              return;
            }
            const backBtn = event.target.closest('.booking-back-btn');
            if(backBtn) {
              const row = backBtn.closest('.provider-bookings-item');
              if(row) row.classList.remove('is-address');
              return;
            }
            const cancelBtn = event.target.closest('.provider-cancel-btn');
            if(cancelBtn) {
              const requestId = cancelBtn.getAttribute('data-request-id');
              const reason = prompt('Reason for cancellation?');
              if(reason === null) return;
              cancelProviderRequest(requestId, reason.trim());
            }
          });
          listEl.dataset.addressBound = 'true';
        }
      };

      const cancelProviderRequest = async (requestId, reason) => {
        const id = parseInt(requestId, 10);
        if(!id) return;
        try{
          if(!providerApiBase){
            throw new Error('Booking service is unavailable. Please refresh and try again.');
          }
          const resp = await fetch(`${providerApiBase}/forms/request/${id}/cancel`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason, cancelled_by: 'provider' })
          });
          const data = await resp.json().catch(() => ({}));
          if(!resp.ok) throw new Error(data.error || `Cancel failed (${resp.status})`);
          const idx = providerRequestsCache.findIndex((req) => Number(req.id) === id);
          if(idx > -1) {
            providerRequestsCache[idx] = {
              ...providerRequestsCache[idx],
              status: 'cancelled_by_you'
            };
          }
          renderUpcomingBookings(providerRequestsCache);
          renderAreaRequests(providerRequestsCache);
          renderDashboardInsights(providerRequestsCache, providerStatsCache);
        } catch (err) {
          console.error('Cancel booking failed:', err);
          alert(err.message || 'Could not cancel the booking. Please try again.');
        }
      };

      const isCancelled = (entry) => {
        const status = String(entry?.status || '').toLowerCase();
        return status.includes('cancel');
      };

      const isCancelledByProvider = (entry) => {
        const status = String(entry?.status || '').toLowerCase();
        return status === 'cancelled_by_you' || status === 'cancelled_by_provider';
      };

      const parseAgeGroup = (entry) => {
        const rawGroup = entry.child_age_group || entry.childAgeGroup || entry.age_group || entry.ageGroup || entry.age || entry.child_age;
        if(rawGroup === undefined || rawGroup === null) return null;
        const asNumber = Number(rawGroup);
        if(!Number.isNaN(asNumber)) {
          if(asNumber <= 3) return 'infants';
          if(asNumber <= 6) return 'early';
          if(asNumber <= 12) return 'school';
          return null;
        }
        const text = String(rawGroup).toLowerCase();
        if(text.includes('infant') || text.includes('toddler')) return 'infants';
        if(text.includes('early')) return 'early';
        if(text.includes('school')) return 'school';
        return null;
      };

      const updatePie = (element, seg1, seg2, seg3, label) => {
        if(!element) return;
        const s1 = Math.max(0, Math.min(100, seg1));
        const s2 = Math.max(0, Math.min(100, seg2));
        const s3 = Math.max(0, Math.min(100, seg3));
        element.style.setProperty('--seg-1', s1);
        element.style.setProperty('--seg-2', s2);
        element.style.setProperty('--seg-3', s3);
        if(label) element.setAttribute('aria-label', label);
      };

      const renderDashboardInsights = (requests, stats = {}) => {
        const requestList = requests || [];
        const acceptedRequests = requestList.filter((entry) => {
          const status = String(entry.status || '').toLowerCase();
          return status === 'accepted' || status === 'confirmed';
        });
        const ageCounts = { infants: 0, early: 0, school: 0 };
        acceptedRequests.forEach((entry) => {
          const group = parseAgeGroup(entry);
          if(group && ageCounts[group] !== undefined) ageCounts[group] += 1;
        });
        const ageTotal = ageCounts.infants + ageCounts.early + ageCounts.school;
        const infantsPct = ageTotal ? Math.round((ageCounts.infants / ageTotal) * 100) : 0;
        const earlyPct = ageTotal ? Math.round((ageCounts.early / ageTotal) * 100) : 0;
        const schoolPct = ageTotal ? Math.max(0, 100 - infantsPct - earlyPct) : 0;
        updatePie(
          document.getElementById('ageMixPie'),
          infantsPct,
          earlyPct,
          schoolPct,
          `Infants and toddlers ${infantsPct} percent, early childhood ${earlyPct} percent, school-age ${schoolPct} percent`
        );
        const ageTop = Object.entries(ageCounts).sort((a, b) => b[1] - a[1])[0];
        const topLabelMap = { infants: 'Infants & Toddlers', early: 'Early Childhood', school: 'School-Age' };
        const topLabel = ageTop && ageTop[1] > 0 ? topLabelMap[ageTop[0]] : 'No data yet';
        const topPercent = ageTotal && ageTop ? Math.round((ageTop[1] / ageTotal) * 100) : 0;
        const agePrimary = document.getElementById('ageMixPrimary');
        if(agePrimary) agePrimary.textContent = `${topPercent}%`;
        const agePrimaryLabel = document.getElementById('ageMixPrimaryLabel');
        if(agePrimaryLabel) agePrimaryLabel.textContent = topLabel;
        const ageInfantsEl = document.getElementById('ageMixInfants');
        if(ageInfantsEl) ageInfantsEl.textContent = `${ageCounts.infants}`;
        const ageEarlyEl = document.getElementById('ageMixEarly');
        if(ageEarlyEl) ageEarlyEl.textContent = `${ageCounts.early}`;
        const ageSchoolEl = document.getElementById('ageMixSchool');
        if(ageSchoolEl) ageSchoolEl.textContent = `${ageCounts.school}`;

        const resolved = requestList.filter((entry) => {
          const status = String(entry.status || '').toLowerCase();
          return status === 'accepted' || status === 'confirmed' || status === 'declined' || status.includes('cancel');
        });
        const successCount = resolved.filter((entry) => {
          const status = String(entry.status || '').toLowerCase();
          return status === 'accepted' || status === 'confirmed';
        }).length;
        const cancelledCount = resolved.filter((entry) => {
          const status = String(entry.status || '').toLowerCase();
          return !(status === 'accepted' || status === 'confirmed');
        }).length;
        const totalSessions = successCount + cancelledCount;
        const successPct = totalSessions ? Math.round((successCount / totalSessions) * 100) : 0;
        updatePie(
          document.getElementById('successRatePie'),
          successPct,
          Math.max(0, 100 - successPct),
          0,
          `Success rate ${successPct} percent, cancellations ${Math.max(0, 100 - successPct)} percent`
        );
        const successValueEl = document.getElementById('successRateValue');
        if(successValueEl) successValueEl.textContent = `${successPct}%`;
        const successCountEl = document.getElementById('successCount');
        if(successCountEl) successCountEl.textContent = `${successCount}`;
        const cancelCountEl = document.getElementById('cancelCount');
        if(cancelCountEl) cancelCountEl.textContent = `${cancelledCount}`;

        const familyCounts = new Map();
        acceptedRequests.forEach((entry) => {
          const key = entry.parent_id || entry.parentId || entry.parent_user_id || entry.parent || entry.parent_name || entry.family_name || entry.family || entry.email || entry.id;
          if(!key) return;
          familyCounts.set(key, (familyCounts.get(key) || 0) + 1);
        });
        const repeatFamilies = Array.from(familyCounts.values()).filter((count) => count > 1).length;
        const newFamilies = Array.from(familyCounts.values()).filter((count) => count === 1).length;
        const totalFamilies = repeatFamilies + newFamilies;
        const repeatPct = totalFamilies ? Math.round((repeatFamilies / totalFamilies) * 100) : 0;
        updatePie(
          document.getElementById('repeatFamiliesPie'),
          repeatPct,
          Math.max(0, 100 - repeatPct),
          0,
          `Repeat families ${repeatPct} percent, new families ${Math.max(0, 100 - repeatPct)} percent`
        );
        const repeatValueEl = document.getElementById('repeatFamiliesPercent');
        if(repeatValueEl) repeatValueEl.textContent = `${repeatPct}%`;
        const repeatCountEl = document.getElementById('repeatFamiliesCount');
        if(repeatCountEl) repeatCountEl.textContent = `${repeatFamilies}`;
        const newCountEl = document.getElementById('repeatFamiliesNewCount');
        if(newCountEl) newCountEl.textContent = `${newFamilies}`;

        const toNumber = (value) => {
          const num = Number(value);
          return Number.isNaN(num) ? 0 : num;
        };
        const resolveEarnings = (entry) => {
          const cents = resolveEstimatedEarningsCents(entry);
          return cents ? cents / 100 : toNumber(entry.provider_earnings || entry.earnings || entry.amount || entry.total || 0);
        };
        const resolveTip = (entry) => {
          if(entry.tip_cents) return toNumber(entry.tip_cents) / 100;
          return toNumber(entry.tip || entry.tips || 0);
        };
        const resolveBonus = (entry) => {
          if(entry.bonus_cents) return toNumber(entry.bonus_cents) / 100;
          return toNumber(entry.bonus || entry.bonus_amount || 0);
        };
        let sessionTotal = 0;
        let tipsTotal = 0;
        let bonusesTotal = 0;
        acceptedRequests.forEach((entry) => {
          const amount = resolveEarnings(entry);
          const tip = resolveTip(entry);
          const bonus = resolveBonus(entry);
          if(amount > 0) sessionTotal += amount;
          if(tip > 0) tipsTotal += tip;
          if(bonus > 0) bonusesTotal += bonus;
        });
        const totalEarnings = sessionTotal + tipsTotal + bonusesTotal;
        const setSegWidth = (id, value) => {
          const el = document.getElementById(id);
          if(!el) return;
          const pct = totalEarnings ? Math.round((value / totalEarnings) * 100) : 0;
          el.style.setProperty('--w', `${pct}%`);
        };
        setSegWidth('earnSegSessions', sessionTotal);
        setSegWidth('earnSegTips', tipsTotal);
        setSegWidth('earnSegBonuses', bonusesTotal);
        const totalEl = document.getElementById('earningsTotal');
        if(totalEl) totalEl.textContent = `${formatCurrency(totalEarnings)} total`;
        const sessionsEl = document.getElementById('earnSessionsValue');
        if(sessionsEl) sessionsEl.textContent = formatCurrency(sessionTotal);
        const tipsEl = document.getElementById('earnTipsValue');
        if(tipsEl) tipsEl.textContent = formatCurrency(tipsTotal);
        const bonusEl = document.getElementById('earnBonusesValue');
        if(bonusEl) bonusEl.textContent = formatCurrency(bonusesTotal);
        const emptyEl = document.getElementById('earningsEmpty');
        if(emptyEl) emptyEl.style.display = totalEarnings > 0 ? 'none' : 'block';
      };

      const requestIsActionable = (status) => {
        const normalized = String(status || '').toLowerCase();
        return normalized === '' || normalized === 'pending' || normalized === 'requested';
      };

      const filterRequestsForView = (requests) => {
        if(providerRequestsView === 'cancelled') {
          return (requests || []).filter((entry) => isCancelledByProvider(entry));
        }
        return (requests || []).filter((entry) => requestIsActionable(entry.status));
      };

      const renderAreaRequests = (requests) => {
        const listEl = document.getElementById('areaRequestsList');
        const countEl = document.getElementById('areaRequestsCount');
        const rows = filterRequestsForView(requests);
        const countLabel = providerRequestsView === 'cancelled' ? 'cancelled' : 'pending';
        if(countEl) countEl.textContent = `${rows.length} ${countLabel}`;
        if(!listEl) return;
        if(rows.length === 0) {
          const emptyLabel = providerRequestsView === 'cancelled'
            ? 'No cancelled requests yet.'
            : 'No pending requests yet.';
          listEl.innerHTML = `<div class="provider-requests-empty">${emptyLabel}</div>`;
          return;
        }
        listEl.innerHTML = rows.map((entry) => {
          const childDisplay = formatChildDisplay(entry);
          const familyLabel = resolveFamilyLabel(entry);
          const hoursValue = durationHours(entry);
          const hoursLabel = hoursValue ? `${formatHours(hoursValue)} hrs` : 'TBD';
          const earningsCents = resolveEstimatedEarningsCents(entry);
          const earningsLabel = earningsCents ? formatCurrency(earningsCents / 100) : '$0';
          const statusRaw = String(entry.status || 'pending').replace(/_/g, ' ');
          const statusLabel = statusRaw.replace(/_/g, ' ').replace(/\b\w/g, (ch) => ch.toUpperCase());
          const canRespond = requestIsActionable(entry.status);
          const requestId = entry.id || '';
          const actionMarkup = canRespond ? `
            <div class="provider-requests-action">
              <button class="provider-request-btn accept" type="button" data-action="accept" data-request-id="${requestId}">Accept</button>
              <button class="provider-request-btn decline" type="button" data-action="decline" data-request-id="${requestId}">Decline</button>
            </div>
          ` : '';
          return `
            <div class="provider-requests-row provider-requests-item" data-request-id="${requestId}">
              <div class="provider-requests-cell" data-label="Child">${childDisplay.label}</div>
              <div class="provider-requests-cell" data-label="Family">${familyLabel}</div>
              <div class="provider-requests-cell" data-label="Hours requested">${hoursLabel}</div>
              <div class="provider-requests-cell" data-label="Estimated earnings">${earningsLabel}</div>
              <div class="provider-requests-cell provider-requests-status" data-label="Status">
                ${actionMarkup}
                <span>${statusLabel}</span>
              </div>
            </div>
          `;
        }).join('');
        if(!listEl.dataset.actionsBound) {
          listEl.addEventListener('click', (event) => {
            const btn = event.target.closest('.provider-request-btn');
            if(!btn || btn.disabled) return;
            const action = btn.getAttribute('data-action');
            const requestId = btn.getAttribute('data-request-id');
            if(!requestId || !action) return;
            respondToRequest(requestId, action, btn);
          });
          listEl.dataset.actionsBound = 'true';
        }
      };

      const updateRequestsToggle = () => {
        const toggleBtn = document.getElementById('providerRequestsToggle');
        if(!toggleBtn) return;
        if(providerRequestsView === 'cancelled') {
          toggleBtn.textContent = 'Pending requests';
          toggleBtn.setAttribute('aria-pressed', 'true');
        } else {
          toggleBtn.textContent = 'Cancelled requests';
          toggleBtn.setAttribute('aria-pressed', 'false');
        }
      };

      const bindRequestsToggle = () => {
        const toggleBtn = document.getElementById('providerRequestsToggle');
        if(!toggleBtn || toggleBtn.dataset.bound === 'true') return;
        toggleBtn.dataset.bound = 'true';
        toggleBtn.addEventListener('click', () => {
          providerRequestsView = providerRequestsView === 'cancelled' ? 'pending' : 'cancelled';
          updateRequestsToggle();
          renderAreaRequests(providerRequestsCache);
        });
        updateRequestsToggle();
      };

      const respondToRequest = async (requestId, action, buttonEl) => {
        const id = parseInt(requestId, 10);
        if(!id) return;
        if(buttonEl) buttonEl.disabled = true;
        try{
          const resp = await fetch(`${providerApiBase}/forms/request/${id}/respond`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, provider_id: parseInt(localStorage.getItem('user_id'), 10) })
          });
          const data = await resp.json().catch(() => ({}));
          if(!resp.ok) throw new Error(data.error || 'Unable to update request');
          const status = data.status || (action === 'accept' ? 'accepted' : 'declined');
          const idx = providerRequestsCache.findIndex((entry) => Number(entry.id) === id);
          if(idx > -1) {
            providerRequestsCache[idx] = { ...providerRequestsCache[idx], status };
          }
          renderUpcomingBookings(providerRequestsCache);
          renderAreaRequests(providerRequestsCache);
          renderDashboardInsights(providerRequestsCache, providerStatsCache);
          updateProviderMetrics(providerRequestsCache);
        }catch(err){
          alert(err.message || 'Unable to respond to request.');
        }finally{
          if(buttonEl) buttonEl.disabled = false;
        }
      };

      const formatMessageTime = (value) => {
        if(!value) return '';
        const date = new Date(value);
        if(Number.isNaN(date.getTime())) return '';
        const now = new Date();
        const sameDay = date.toDateString() === now.toDateString();
        return sameDay
          ? date.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })
          : date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
      };

      const hookProviderMessages = () => {
        const listEl = document.getElementById('providerMessagesList');
        const unreadEl = document.getElementById('providerMessagesUnread');
        const openBtn = document.getElementById('providerMessagesOpenBtn');
        const apply = () => {
          const threads = window.latestThreads || {};
          const unread = window.latestUnread || 0;
          if(unreadEl){
            unreadEl.style.display = unread > 0 ? 'inline-flex' : 'none';
            unreadEl.textContent = `${unread} unread`;
          }
          if(!listEl) return;
          const uid = parseInt(localStorage.getItem('user_id'), 10);
          const entries = Object.values(threads).map((thread) => {
            const last = thread.messages[thread.messages.length - 1];
            const time = last?.created_at || last?.createdAt || null;
            return { thread, last, time };
          }).sort((a, b) => {
            const aTime = a.time ? new Date(a.time).getTime() : 0;
            const bTime = b.time ? new Date(b.time).getTime() : 0;
            return bTime - aTime;
          });
          if(entries.length === 0){
            listEl.innerHTML = '<div class="provider-bookings-empty">No messages yet.</div>';
            return;
          }
          listEl.innerHTML = entries.slice(0, 3).map(({ thread, last, time }) => {
            const name = thread.other_name || 'User';
            const initials = name.split(/\s+/).map(part => part[0]).join('').slice(0, 2).toUpperCase();
            const body = last?.body || '';
            const unreadCount = uid
              ? thread.messages.filter(m => m.receiver_id === uid && !m.read_at).length
              : 0;
            return `
              <div class="parent-message-item provider-message-item">
                <div class="provider-message-avatar">${initials || 'AH'}</div>
                <div class="provider-message-content">
                  <div class="provider-message-top">
                    <div class="parent-message-name">${name}</div>
                    <div class="provider-message-time">${formatMessageTime(time)}</div>
                  </div>
                  <div class="parent-message-body">${body}</div>
                </div>
                ${unreadCount ? `<span class="provider-message-unread">${unreadCount}</span>` : ''}
              </div>
            `;
          }).join('');
        };
        apply();
        window.addEventListener('chat-updated', apply);
        if(openBtn){
          openBtn.addEventListener('click', () => {
            if(window.showChatWidget) window.showChatWidget();
          });
        }
      };

      const availabilityDays = [
        { key: 'monday', label: 'Monday' },
        { key: 'tuesday', label: 'Tuesday' },
        { key: 'wednesday', label: 'Wednesday' },
        { key: 'thursday', label: 'Thursday' },
        { key: 'friday', label: 'Friday' },
        { key: 'saturday', label: 'Saturday' },
        { key: 'sunday', label: 'Sunday' }
      ];
      const createDefaultSlot = () => ({ start: '08:00', end: '17:00' });
      let availabilityState = {};
      let availabilityNotes = null;
      let availabilitySnapshot = null;
      let availabilityUserId = null;
      let availabilityApiBase = null;

      const cloneAvailability = (value) => JSON.parse(JSON.stringify(value));

      const normalizeAvailabilityFromApi = (raw) => {
        const normalized = {};
        availabilityDays.forEach(({ key }) => {
          const dayData = raw && raw[key] ? raw[key] : null;
          let slots = [];
          if(Array.isArray(dayData)) {
            slots = dayData;
          } else if(dayData && Array.isArray(dayData.slots)) {
            slots = dayData.slots;
          } else if(dayData && typeof dayData === 'object') {
            slots = [dayData];
          }
          const slotList = slots.length
            ? slots.map((slot) => ({
              start: slot.start || slot.from || '08:00',
              end: slot.end || slot.to || '17:00'
            }))
            : [createDefaultSlot()];
          const enabled = dayData
            ? (typeof dayData.enabled === 'boolean' ? dayData.enabled : slots.length > 0)
            : false;
          normalized[key] = {
            enabled,
            slots: slotList
          };
        });
        return normalized;
      };

      const setAvailabilityFromProfile = (profile) => {
        const rawAvailability = profile?.availability || {};
        const parsed = typeof rawAvailability === 'string' ? JSON.parse(rawAvailability || '{}') : rawAvailability;
        const scheduleSource = parsed?.schedule && typeof parsed.schedule === 'object' ? parsed.schedule : parsed;
        availabilityNotes = parsed?.notes || null;
        availabilityState = normalizeAvailabilityFromApi(scheduleSource || {});
        availabilitySnapshot = {
          state: cloneAvailability(availabilityState),
          notes: availabilityNotes
        };
      };

      const buildAvailabilityPayload = () => {
        const schedule = {};
        availabilityDays.forEach(({ key }) => {
          const day = availabilityState[key];
          if(!day || !day.enabled) return;
          const slots = (day.slots || []).map((slot) => ({
            from: slot.start || slot.from || '',
            to: slot.end || slot.to || ''
          })).filter((slot) => slot.from || slot.to);
          if(slots.length) schedule[key] = slots;
        });
        return {
          schedule,
          notes: availabilityNotes || null
        };
      };

      const renderAvailabilityEditor = () => {
        const editor = document.getElementById('availabilityEditor');
        if(!editor) return;
        editor.innerHTML = availabilityDays.map(({ key, label }) => {
          const day = availabilityState[key];
          const disabledAttr = day.enabled ? '' : 'disabled';
          const rowClass = day.enabled ? 'availability-day' : 'availability-day is-disabled';
          const slotsMarkup = day.slots.map((slot, index) => {
            return `
              <div class="availability-slot" data-day="${key}" data-slot="${index}">
                <label class="sr-only" for="availability-${key}-start-${index}">Start time</label>
                <input type="time" id="availability-${key}-start-${index}" data-day="${key}" data-slot="${index}" data-field="start" value="${slot.start}" ${disabledAttr}>
                <span class="availability-slot-sep">â</span>
                <label class="sr-only" for="availability-${key}-end-${index}">End time</label>
                <input type="time" id="availability-${key}-end-${index}" data-day="${key}" data-slot="${index}" data-field="end" value="${slot.end}" ${disabledAttr}>
                <button class="availability-icon-btn availability-remove-slot" type="button" data-day="${key}" data-slot="${index}" ${disabledAttr} aria-label="Remove time slot">Ã</button>
              </div>
            `;
          }).join('');
          return `
            <div class="${rowClass}" data-day="${key}">
              <div class="availability-day-toggle">
                <input class="availability-checkbox" type="checkbox" id="availability-${key}" data-day="${key}" ${day.enabled ? 'checked' : ''}>
                <label for="availability-${key}">${label}</label>
              </div>
              <div class="availability-slots">
                ${slotsMarkup}
              </div>
              <div class="availability-day-actions">
                <button class="availability-icon-btn availability-add-slot" type="button" data-day="${key}" ${disabledAttr} aria-label="Add time slot">+</button>
              </div>
            </div>
          `;
        }).join('');
      };

      const initAvailabilityEditor = ({ profile, apiBase, userId } = {}) => {
        const editor = document.getElementById('availabilityEditor');
        if(!editor) return;
        if(apiBase) availabilityApiBase = apiBase;
        if(userId) availabilityUserId = userId;
        setAvailabilityFromProfile(profile || {});
        renderAvailabilityEditor();

        if(editor.dataset.ready === 'true') return;
        editor.dataset.ready = 'true';

        editor.addEventListener('change', (event) => {
          const target = event.target;
          if(!(target instanceof HTMLElement)) return;
          if(target.classList.contains('availability-checkbox')) {
            const dayKey = target.dataset.day;
            if(!dayKey) return;
            availabilityState[dayKey].enabled = target.checked;
            if(target.checked && availabilityState[dayKey].slots.length === 0) {
              availabilityState[dayKey].slots = [createDefaultSlot()];
            }
            const row = target.closest('.availability-day');
            if(row) row.classList.toggle('is-disabled', !target.checked);
            row?.querySelectorAll('input[type="time"], .availability-add-slot, .availability-remove-slot').forEach((el) => {
              el.disabled = !target.checked;
            });
          }
          if(target instanceof HTMLInputElement && target.type === 'time') {
            const dayKey = target.dataset.day;
            const slotIndex = Number(target.dataset.slot);
            const field = target.dataset.field;
            if(!dayKey || Number.isNaN(slotIndex) || !field) return;
            if(!availabilityState[dayKey].slots[slotIndex]) return;
            availabilityState[dayKey].slots[slotIndex][field] = target.value;
          }
        });

        editor.addEventListener('click', (event) => {
          const target = event.target;
          if(!(target instanceof HTMLElement)) return;
          const addBtn = target.closest('.availability-add-slot');
          if(addBtn) {
            const dayKey = addBtn.dataset.day;
            if(dayKey && availabilityState[dayKey].enabled) {
              availabilityState[dayKey].slots.push(createDefaultSlot());
              renderAvailabilityEditor();
            }
          }
          const removeBtn = target.closest('.availability-remove-slot');
          if(removeBtn) {
            const dayKey = removeBtn.dataset.day;
            const slotIndex = Number(removeBtn.dataset.slot);
            if(!dayKey || Number.isNaN(slotIndex)) return;
            if(availabilityState[dayKey].slots.length <= 1) {
              availabilityState[dayKey].slots[0] = createDefaultSlot();
            } else {
              availabilityState[dayKey].slots.splice(slotIndex, 1);
            }
            renderAvailabilityEditor();
          }
        });

        document.getElementById('availabilitySaveBtn')?.addEventListener('click', () => {
          const status = document.getElementById('availabilityStatus');
          if(!availabilityUserId || !availabilityApiBase){
            if(status) status.textContent = 'Please sign in to save availability.';
            return;
          }
          if(status) status.textContent = 'Saving...';
          fetch(`${availabilityApiBase}/forms/provider/${availabilityUserId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ availability: buildAvailabilityPayload() })
          })
            .then((res) => {
              if(!res.ok) throw new Error('Save failed');
              availabilitySnapshot = {
                state: cloneAvailability(availabilityState),
                notes: availabilityNotes
              };
              if(status) status.textContent = 'Availability saved to profile.';
            })
            .catch((_err) => {
              if(status) status.textContent = 'Save failed. Try again.';
            });
        });
        document.getElementById('availabilityCancelBtn')?.addEventListener('click', () => {
          if(availabilitySnapshot){
            availabilityState = cloneAvailability(availabilitySnapshot.state);
            availabilityNotes = availabilitySnapshot.notes;
            renderAvailabilityEditor();
          }
          const status = document.getElementById('availabilityStatus');
          if(status) status.textContent = 'Changes reverted.';
        });
      };

      window.addEventListener('DOMContentLoaded', async () => {
        const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';
        const userId = parseInt(localStorage.getItem('user_id'), 10);
        const userType = localStorage.getItem('user_type');
        if(!userId || userType !== 'provider') return;
        providerApiBase = API_BASE;

        initAvailabilityEditor({ apiBase: API_BASE, userId });
        hookProviderMessages();
        bindRequestsToggle();

        try {
          const resp = await fetch(`${API_BASE}/forms/provider/${userId}`);
          if(!resp.ok) throw new Error('Failed to load provider data');
          const data = await resp.json();
          const profile = data.profile || {};
          const name = profile.first_name || profile.name || '';

          if(name) {
            const welcomeName = document.getElementById('providerWelcomeName');
            if(welcomeName) welcomeName.textContent = `, ${name}`;
            const sidebarName = document.getElementById('providerSidebarName');
            if(sidebarName) sidebarName.textContent = `Signed in as ${name}`;
          }

          const stats = data.stats || {};
          const requests = data.requests || [];
          providerRequestsCache = requests;
          providerStatsCache = stats;
          updateProviderMetrics(requests);
          renderUpcomingBookings(requests);
          renderAreaRequests(requests);
          renderDashboardInsights(requests, stats);
          initAvailabilityEditor({ profile, apiBase: API_BASE, userId });
        } catch (err) {
          console.error('Failed to load provider metrics', err);
        }
      });
    </script>
  </body>
</html>
