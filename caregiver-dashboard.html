<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Caregiver Dashboard - Assured Hearts</title>
    <meta name="description" content="Manage your caregiver dashboard, sessions, and families." />
    <link rel="stylesheet" href="style.css">
  </head>

  <body class="provider-dashboard">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <button id="mobileMenuBtn" class="mobile-menu" aria-label="Open menu">
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <div id="mobileMenu" class="mobile-menu-panel hidden" aria-hidden="true">
      <button id="mobileMenuClose" class="mobile-menu-close" aria-label="Close menu">&times;</button>
      <nav class="mobile-nav">
        <a href="find-childcare.html">Find Childcare</a>
        <a href="become-provider.html">Join Our Care Network</a>
        <a href="care-process.html">Our Care Process</a>
        <a href="learning.html">At-Home Learning</a>
        <a href="caregiver-dashboard.html">Dashboard</a>
      </nav>
    </div>

    <main class="provider-shell">
      <aside class="provider-sidebar">
        <div class="provider-sidebar-header">
          <span class="provider-sidebar-eyebrow">Caregiver Portal</span>
          <div class="provider-sidebar-title">Assured Hearts</div>
          <div id="providerSidebarName" class="provider-sidebar-name">Signed in</div>
        </div>

        <nav class="provider-nav" role="tablist" aria-label="Provider dashboard sections">
          <button id="tab-dashboard" class="provider-nav-item is-active" type="button" role="tab" aria-selected="true" aria-controls="panel-dashboard" data-panel="dashboard">Dashboard</button>
          <button id="tab-calendar" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-calendar" data-panel="calendar">Calendar</button>
          <button id="tab-inbox" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-inbox" data-panel="inbox">Inbox</button>
          <button id="tab-availability" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-availability" data-panel="availability">Availability</button>
          <button id="tab-families" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-families" data-panel="families">My Families</button>
          <button id="tab-curriculum" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-curriculum" data-panel="curriculum">Curriculum Library</button>
        </nav>

        <div class="provider-sidebar-footer">
          <div class="provider-upgrade-card">
            <div class="provider-upgrade-title">Upgrade to Care+ Provider Access</div>
            <p class="provider-upgrade-copy">Unlock priority visibility, curriculum tools, and premium scheduling.</p>
            <a class="provider-upgrade-btn" href="shop.html">Upgrade</a>
          </div>
          <button id="providerLogout" class="provider-logout" type="button">Log out</button>
        </div>
      </aside>

      <section class="provider-content">
        <header class="provider-content-header">
          <div>
            <p class="provider-eyebrow">Dashboard</p>
            <h1 class="provider-title">Welcome back<span id="providerWelcomeName"></span></h1>
            <p class="provider-subtitle">Your caregiver hub for sessions, families, and learning tools.</p>
          </div>
          <div class="provider-header-actions">
            <button id="openProfileBtn" class="provider-header-btn" type="button">My Profile</button>
          </div>
        </header>

        <div class="provider-panels">
          <section id="panel-dashboard" class="provider-panel is-active" role="tabpanel" aria-labelledby="tab-dashboard">
            <div class="provider-kpi-grid">
              <div class="provider-kpi-card">
                <p class="provider-kpi-label">Monthly Earnings</p>
                <p id="metricMonthlyEarnings" class="provider-kpi-value">$0</p>
                <p class="provider-kpi-foot">This month</p>
              </div>
              <div class="provider-kpi-card">
                <p class="provider-kpi-label">Total session hours this month</p>
                <p id="metricMonthlyHours" class="provider-kpi-value">0</p>
                <p class="provider-kpi-foot">Completed and scheduled</p>
              </div>
            </div>
            <div class="provider-dashboard-grid">
              <section class="provider-bookings-card">
                <div class="provider-card-head">
                  <div>
                    <h2>Upcoming bookings</h2>
                    <p class="provider-card-sub">Next sessions on your calendar.</p>
                  </div>
                  <span id="upcomingCount" class="provider-card-pill">0 upcoming</span>
                </div>
                <div class="provider-bookings-table">
                  <div class="provider-bookings-row provider-bookings-head">
                    <div class="provider-booking-cell">Child</div>
                    <div class="provider-booking-cell">Family</div>
                    <div class="provider-booking-cell">Hours booked</div>
                    <div class="provider-booking-cell">Care type</div>
                    <div class="provider-booking-cell">Time scheduled</div>
                  </div>
                  <div id="upcomingBookingsList" class="provider-bookings-body">
                    <div class="provider-bookings-empty">No upcoming bookings yet.</div>
                  </div>
                </div>
              </section>
              <section class="provider-requests-card">
                <div class="provider-card-head">
                  <div>
                    <h2>Requests in your area</h2>
                    <p class="provider-card-sub">Browse new family requests near you.</p>
                  </div>
                  <span id="areaRequestsCount" class="provider-card-pill">0 requests</span>
                </div>
                <div class="provider-requests-table">
                  <div class="provider-requests-row provider-requests-head">
                    <div class="provider-requests-cell">Request type</div>
                    <div class="provider-requests-cell">Child age</div>
                    <div class="provider-requests-cell">Hours / week</div>
                    <div class="provider-requests-cell">Care type</div>
                    <div class="provider-requests-cell">Time of day</div>
                    <div class="provider-requests-cell provider-requests-action">Action</div>
                  </div>
                  <div id="areaRequestsList" class="provider-requests-body">
                    <div class="provider-requests-empty">No requests in your area yet.</div>
                  </div>
                </div>
              </section>
              <section class="provider-chart-card">
                <div class="provider-card-head">
                  <div>
                    <h2>Insights</h2>
                    <p class="provider-card-sub">Snapshot of the families you serve and your performance.</p>
                  </div>
                </div>
                <div class="provider-pie-grid">
                  <div class="provider-mini-card">
                    <h3>Age ranges booked</h3>
                    <p class="provider-mini-sub">Which ages you work with the most.</p>
                    <div class="provider-chart-wrap">
                      <div id="ageMixPie" class="provider-pie provider-pie-ages" role="img" aria-label="Infants and toddlers 0 percent, early childhood 0 percent, school-age 0 percent">
                        <div class="provider-pie-center">
                          <span id="ageMixPrimary" class="provider-pie-value">0%</span>
                          <span id="ageMixPrimaryLabel" class="provider-pie-label">Top age group</span>
                        </div>
                      </div>
                    </div>
                    <div class="provider-legend">
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-ages-1"></span> Infants &amp; Toddlers 1-3 <strong id="ageMixInfants">0</strong></div>
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-ages-2"></span> Early Childhood 3-6 <strong id="ageMixEarly">0</strong></div>
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-ages-3"></span> School-Age 7-12 <strong id="ageMixSchool">0</strong></div>
                    </div>
                  </div>
                  <div class="provider-mini-card">
                    <h3>Successful bookings</h3>
                    <p class="provider-mini-sub">Tracks cancellations vs completed bookings.</p>
                    <div class="provider-chart-wrap">
                      <div id="successRatePie" class="provider-pie provider-pie-success" role="img" aria-label="Success rate 0 percent, cancellations 0 percent">
                        <div class="provider-pie-center">
                          <span id="successRateValue" class="provider-pie-value">0%</span>
                          <span class="provider-pie-label">Success rate</span>
                        </div>
                      </div>
                    </div>
                    <div class="provider-legend">
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-success"></span> Successful <strong id="successCount">0</strong></div>
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-cancelled"></span> Cancelled <strong id="cancelCount">0</strong></div>
                    </div>
                  </div>
                  <div class="provider-mini-card">
                    <h3>Repeat families</h3>
                    <p class="provider-mini-sub">Families who have booked you again.</p>
                    <div class="provider-chart-wrap">
                      <div id="repeatFamiliesPie" class="provider-pie provider-pie-repeat" role="img" aria-label="Repeat families 0 percent, new families 0 percent">
                        <div class="provider-pie-center">
                          <span id="repeatFamiliesPercent" class="provider-pie-value">0%</span>
                          <span class="provider-pie-label">Repeat families</span>
                        </div>
                      </div>
                    </div>
                    <div class="provider-legend">
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-repeat"></span> Repeat families <strong id="repeatFamiliesCount">0</strong></div>
                      <div class="provider-legend-item"><span class="provider-dot provider-dot-new"></span> New families <strong id="repeatFamiliesNewCount">0</strong></div>
                    </div>
                  </div>
                </div>
                <div class="provider-earnings-block">
                  <div class="provider-card-head">
                    <div>
                      <h2>Earnings breakdown</h2>
                      <p class="provider-card-sub">Where your income is coming from this month.</p>
                    </div>
                    <span id="earningsTotal" class="provider-card-pill">$0 total</span>
                  </div>
                  <div class="provider-earnings-bar" role="img" aria-label="Earnings split across curriculum, standard sessions, tips, and bonuses.">
                    <span id="earnSegCurriculum" class="earn-seg earn-curriculum"></span>
                    <span id="earnSegStandard" class="earn-seg earn-standard"></span>
                    <span id="earnSegTips" class="earn-seg earn-tips"></span>
                    <span id="earnSegBonuses" class="earn-seg earn-bonuses"></span>
                  </div>
                  <div id="earningsEmpty" class="provider-earnings-empty">No earnings data yet.</div>
                  <div class="provider-earnings-grid">
                    <div class="provider-earnings-item"><span class="provider-dot provider-dot-curriculum"></span> Curriculum sessions <strong id="earnCurriculumValue">$0</strong></div>
                    <div class="provider-earnings-item"><span class="provider-dot provider-dot-standard"></span> Standard sessions <strong id="earnStandardValue">$0</strong></div>
                    <div class="provider-earnings-item"><span class="provider-dot provider-dot-tips"></span> Tips <strong id="earnTipsValue">$0</strong></div>
                    <div class="provider-earnings-item"><span class="provider-dot provider-dot-bonuses"></span> Bonuses <strong id="earnBonusesValue">$0</strong></div>
                  </div>
                </div>
              </section>
            </div>
          </section>

          <section id="panel-calendar" class="provider-panel" role="tabpanel" aria-labelledby="tab-calendar" hidden>
            <div class="provider-panel-card">
              <h2>Calendar</h2>
              <p>View your upcoming sessions and availability here.</p>
            </div>
          </section>

          <section id="panel-inbox" class="provider-panel" role="tabpanel" aria-labelledby="tab-inbox" hidden>
            <div class="provider-panel-card">
              <h2>Inbox</h2>
              <p>Your conversations with families will appear here.</p>
            </div>
          </section>

          <section id="panel-availability" class="provider-panel" role="tabpanel" aria-labelledby="tab-availability" hidden>
            <div class="provider-panel-card provider-availability-card">
              <div class="provider-card-head">
                <div>
                  <h2>Set availability</h2>
                  <p class="provider-card-sub">Set the hours when you are available for sessions.</p>
                </div>
              </div>
              <div id="availabilityEditor" class="availability-editor" aria-live="polite"></div>
              <div class="availability-actions">
                <span id="availabilityStatus" class="availability-status">Changes save to your live profile.</span>
                <div class="availability-buttons">
                  <button id="availabilityCancelBtn" class="availability-btn availability-btn-ghost" type="button">Cancel</button>
                  <button id="availabilitySaveBtn" class="availability-btn" type="button">Save</button>
                </div>
              </div>
            </div>
          </section>

          <section id="panel-families" class="provider-panel" role="tabpanel" aria-labelledby="tab-families" hidden>
            <div class="provider-panel-card">
              <h2>My Families</h2>
              <p>Manage family profiles and ongoing sessions here.</p>
            </div>
          </section>

          <section id="panel-curriculum" class="provider-panel" role="tabpanel" aria-labelledby="tab-curriculum" hidden>
            <div class="provider-panel-card">
              <h2>Curriculum Library</h2>
              <p>Access curriculum resources, activities, and learning guides here.</p>
            </div>
          </section>

          <section id="panel-profile" class="provider-panel" role="tabpanel" aria-labelledby="tab-dashboard" hidden>
            <div class="provider-panel-card provider-profile-card">
              <div class="provider-card-head provider-profile-head">
                <div>
                  <h2>My Profile</h2>
                  <p class="provider-card-sub">Update your contact details, payout preferences, and public info.</p>
                </div>
                <button id="profileBackBtn" class="provider-header-btn provider-header-btn-ghost" type="button">Back to Dashboard</button>
              </div>
              <form id="providerProfileForm" class="provider-profile-form">
                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>First name</span>
                    <input type="text" name="first_name" id="provFirstName" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Last name</span>
                    <input type="text" name="last_name" id="provLastName" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Email (login)</span>
                    <input type="email" name="email" id="provEmail" class="provider-input" readonly>
                  </label>
                  <label class="provider-form-field">
                    <span>Phone</span>
                    <input type="tel" name="phone" id="provPhone" class="provider-input">
                  </label>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Address line 1</span>
                    <input type="text" name="address_line1" id="provAddr1" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>City</span>
                    <input type="text" name="city" id="provCity" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Province/State</span>
                    <input type="text" name="province" id="provProvince" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Postal/ZIP</span>
                    <input type="text" name="postal_code" id="provPostal" class="provider-input">
                  </label>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Payout method</span>
                    <select name="payout_method" id="provPayoutMethod" class="provider-input">
                      <option value="">Select</option>
                      <option value="etransfer">Interac e-Transfer</option>
                      <option value="direct_deposit">Direct deposit</option>
                      <option value="paypal">PayPal</option>
                    </select>
                  </label>
                  <label class="provider-form-field">
                    <span>Languages spoken</span>
                    <div class="language-input">
                      <div id="provLanguagesChips" class="language-chips" aria-live="polite"></div>
                      <div class="language-entry">
                        <input type="text" id="provLanguageInput" class="provider-input" list="languageOptions" placeholder="Start typing a language">
                        <button type="button" id="provLanguageAdd" class="language-add-btn">Add</button>
                      </div>
                      <input type="hidden" name="languages" id="provLanguages">
                      <datalist id="languageOptions">
                        <option value="Arabic"></option>
                        <option value="Burmese"></option>
                        <option value="Bengali"></option>
                        <option value="Cantonese"></option>
                        <option value="Czech"></option>
                        <option value="Dari"></option>
                        <option value="Dutch"></option>
                        <option value="English"></option>
                        <option value="Farsi"></option>
                        <option value="French"></option>
                        <option value="German"></option>
                        <option value="Greek"></option>
                        <option value="Gujarati"></option>
                        <option value="Hausa"></option>
                        <option value="Hebrew"></option>
                        <option value="Hindi"></option>
                        <option value="Italian"></option>
                        <option value="Japanese"></option>
                        <option value="Korean"></option>
                        <option value="Malay"></option>
                        <option value="Malayalam"></option>
                        <option value="Mandarin"></option>
                        <option value="Marathi"></option>
                        <option value="Nepali"></option>
                        <option value="Polish"></option>
                        <option value="Portuguese"></option>
                        <option value="Punjabi"></option>
                        <option value="Romanian"></option>
                        <option value="Russian"></option>
                        <option value="Spanish"></option>
                        <option value="Swedish"></option>
                        <option value="Somali"></option>
                        <option value="Swahili"></option>
                        <option value="Tagalog"></option>
                        <option value="Tamil"></option>
                        <option value="Telugu"></option>
                        <option value="Thai"></option>
                        <option value="Turkish"></option>
                        <option value="Ukrainian"></option>
                        <option value="Urdu"></option>
                        <option value="Vietnamese"></option>
                        <option value="Yoruba"></option>
                      </datalist>
                    </div>
                    <small>Shown on your public profile. Start typing and press Enter to add.</small>
                  </label>
                  <label class="provider-form-field">
                    <span>Profile photo URL</span>
                    <input type="url" name="photo_url" id="provPhotoUrl" class="provider-input" placeholder="https://">
                  </label>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>CPR certification</span>
                    <select name="cpr_certified" id="provCprCertified" class="provider-input">
                      <option value="">Select</option>
                      <option value="true">Yes</option>
                      <option value="false">No</option>
                    </select>
                  </label>
                  <label class="provider-form-field">
                    <span>Caregiver insurance</span>
                    <select name="caregiver_insurance" id="provCaregiverInsurance" class="provider-input">
                      <option value="">Select</option>
                      <option value="true">Yes</option>
                      <option value="false">No</option>
                    </select>
                  </label>
                  <label class="provider-form-field provider-form-field-wide">
                    <span>About</span>
                    <textarea name="about" id="provAbout" class="provider-textarea" rows="4" placeholder="Share a short introduction for families..."></textarea>
                  </label>
                </div>

                <div class="provider-form-actions">
                  <button type="submit" class="provider-primary-btn">Save changes</button>
                  <button type="button" id="provDelete" class="provider-secondary-btn">Delete account</button>
                  <div id="provStatus" class="provider-form-status"></div>
                </div>
              </form>
            </div>
          </section>
        </div>
      </section>
    </main>

    <footer style="background: #06464E; color: white; padding: 32px 24px; text-align: center; margin-top: 48px;">
      <p style="margin: 0;">Â© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
      const activateProviderPanel = (panelId) => {
        const navItems = Array.from(document.querySelectorAll('.provider-nav-item'));
        const panels = Array.from(document.querySelectorAll('.provider-panel'));
        const navTarget = panelId === 'profile' ? 'dashboard' : panelId;
        navItems.forEach((btn) => {
          const isActive = btn.dataset.panel === navTarget;
          btn.classList.toggle('is-active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        panels.forEach((panel) => {
          const isActive = panel.id === `panel-${panelId}`;
          panel.classList.toggle('is-active', isActive);
          panel.hidden = !isActive;
        });
      };

      document.querySelectorAll('.provider-nav-item').forEach((btn) => {
        btn.addEventListener('click', () => {
          if(btn.dataset.panel) activateProviderPanel(btn.dataset.panel);
        });
        btn.addEventListener('keydown', (event) => {
          if(event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            btn.click();
          }
        });
      });

      const initialPanel = window.location.hash.replace('#', '');
      activateProviderPanel(initialPanel || 'dashboard');

      document.getElementById('openProfileBtn')?.addEventListener('click', () => {
        window.location.hash = 'profile';
        activateProviderPanel('profile');
      });
      document.getElementById('profileBackBtn')?.addEventListener('click', () => {
        window.location.hash = 'dashboard';
        activateProviderPanel('dashboard');
      });

      const logoutHandler = () => {
        if(confirm('Are you sure you want to log out?')) {
          localStorage.removeItem('user_id');
          localStorage.removeItem('user_type');
          window.location.href = 'index.html';
        }
      };
      document.getElementById('providerLogout')?.addEventListener('click', logoutHandler);

      const formatCurrency = (value) => {
        const num = Number(value);
        if(Number.isNaN(num)) return '$0';
        return `$${num.toLocaleString('en-CA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };

      const formatHours = (value) => {
        const num = Number(value);
        if(Number.isNaN(num)) return '0';
        return num.toFixed(1).replace(/\.0$/, '');
      };

      const toDate = (value) => {
        if(!value) return null;
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? null : date;
      };

      const minutesFromTime = (timeStr) => {
        if(!timeStr) return null;
        const parts = timeStr.split(':').map(Number);
        if(parts.length < 2 || parts.some((p) => Number.isNaN(p))) return null;
        return (parts[0] * 60) + parts[1];
      };

      const durationHours = (entry) => {
        if(entry.start_time && entry.end_time) {
          const start = minutesFromTime(entry.start_time);
          const end = minutesFromTime(entry.end_time);
          if(start === null || end === null) return 0;
          return Math.max(0, (end - start) / 60);
        }
        if(entry.start_at && entry.end_at) {
          const start = new Date(entry.start_at);
          const end = new Date(entry.end_at);
          if(Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return 0;
          return Math.max(0, (end - start) / (1000 * 60 * 60));
        }
        return 0;
      };

      const computeMonthlyHours = (sessions, requests) => {
        const monthKey = new Date().toISOString().slice(0, 7);
        const acceptedRequests = (requests || []).filter((req) => (req.status || '').toLowerCase() === 'accepted');
        const combined = [...(sessions || []), ...acceptedRequests];
        return combined.reduce((total, entry) => {
          const dateValue = entry.session_date || entry.date || entry.start_at;
          const entryDate = toDate(dateValue);
          if(!entryDate) return total;
          if(entryDate.toISOString().slice(0, 7) !== monthKey) return total;
          return total + durationHours(entry);
        }, 0);
      };

      const formatDateLabel = (date) => date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });

      const formatTimeLabel = (timeStr) => {
        if(!timeStr) return '';
        const parts = timeStr.split(':').map(Number);
        if(parts.length < 2 || parts.some((p) => Number.isNaN(p))) return timeStr;
        const base = new Date();
        base.setHours(parts[0], parts[1], 0, 0);
        return base.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' });
      };

      const getStartDate = (entry) => {
        if(entry.start_at) return toDate(entry.start_at);
        const dateValue = entry.session_date || entry.date;
        if(!dateValue) return null;
        const timeValue = entry.start_time || '00:00';
        return toDate(`${dateValue}T${timeValue}`);
      };

      const formatScheduleLabel = (entry) => {
        if(entry.start_at && entry.end_at) {
          const start = toDate(entry.start_at);
          const end = toDate(entry.end_at);
          if(!start || !end) return 'TBD';
          return `${formatDateLabel(start)} ${start.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })} - ${end.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })}`;
        }
        if(entry.session_date) {
          const date = toDate(entry.session_date);
          if(!date) return 'TBD';
          if(entry.start_time && entry.end_time) {
            return `${formatDateLabel(date)} ${formatTimeLabel(entry.start_time)} - ${formatTimeLabel(entry.end_time)}`;
          }
          return `${formatDateLabel(date)}`;
        }
        return 'TBD';
      };

      const resolveCareType = (entry) => {
        const raw = String(entry.care_type || entry.careType || entry.care || '').toLowerCase();
        if(raw.includes('mixed')) return 'Mixed';
        if(entry.curriculum === true || entry.is_curriculum === true || raw.includes('curr')) return 'Curriculum';
        if(raw.includes('standard') || raw.includes('basic')) return 'Standard';
        return 'Standard';
      };

      const buildUpcomingBookings = (sessions, requests) => {
        const acceptedRequests = (requests || [])
          .filter((req) => (req.status || '').toLowerCase() === 'accepted')
          .map((req) => ({
            id: req.id ? `req-${req.id}` : `req-${Math.random().toString(36).slice(2)}`,
            child_name: req.child_name || req.childName || req.child,
            parent_name: req.parent_name || req.parentName || req.family_name || req.family,
            parent_id: req.parent_id || req.parentId || req.parent_user_id || req.parent,
            start_at: req.start_at,
            end_at: req.end_at,
            session_date: req.session_date || req.date || (req.start_at ? String(req.start_at).slice(0, 10) : null),
            start_time: req.start_time,
            end_time: req.end_time,
            care_type: req.care_type || req.careType || req.care,
            status: req.status || 'accepted'
          }));
        const combined = [...(sessions || []), ...acceptedRequests];
        const upcoming = combined.filter((entry) => {
          if((entry.status || '').toLowerCase() === 'cancelled') return false;
          const start = getStartDate(entry);
          if(!start) return true;
          return start >= new Date();
        });
        return upcoming.sort((a, b) => {
          const aStart = getStartDate(a);
          const bStart = getStartDate(b);
          if(!aStart && !bStart) return 0;
          if(!aStart) return 1;
          if(!bStart) return -1;
          return aStart - bStart;
        });
      };

      const renderUpcomingBookings = (sessions, requests) => {
        const upcoming = buildUpcomingBookings(sessions, requests);
        const listEl = document.getElementById('upcomingBookingsList');
        const countEl = document.getElementById('upcomingCount');
        if(countEl) countEl.textContent = `${upcoming.length} upcoming`;
        if(listEl) {
          if(upcoming.length === 0) {
            listEl.innerHTML = '<div class="provider-bookings-empty">No upcoming bookings yet.</div>';
          } else {
            listEl.innerHTML = upcoming.map((entry) => {
              const childName = entry.child_name || entry.childName || entry.child || 'Child';
              const rawFamily = entry.parent_name || entry.family_name || entry.family || 'Family';
              const familyLabel = String(rawFamily).toLowerCase().includes('family') ? rawFamily : `${rawFamily}'s family`;
              const hoursValue = durationHours(entry);
              const hoursLabel = hoursValue ? `${formatHours(hoursValue)} hrs` : 'TBD';
              const careLabel = resolveCareType(entry);
              const careClass = careLabel === 'Curriculum' ? 'care-pill-curriculum' : 'care-pill-standard';
              const timeLabel = formatScheduleLabel(entry);
              return `
                <div class="provider-bookings-row provider-bookings-item">
                  <div class="provider-booking-cell" data-label="Child">${childName}</div>
                  <div class="provider-booking-cell" data-label="Family">${familyLabel}</div>
                  <div class="provider-booking-cell" data-label="Hours booked">${hoursLabel}</div>
                  <div class="provider-booking-cell" data-label="Care type"><span class="care-pill ${careClass}">${careLabel}</span></div>
                  <div class="provider-booking-cell" data-label="Time scheduled">${timeLabel}</div>
                </div>
              `;
            }).join('');
          }
        }
      };

      const isCancelled = (entry) => {
        const status = String(entry?.status || '').toLowerCase();
        return status.includes('cancel');
      };

      const parseAgeGroup = (entry) => {
        const rawGroup = entry.child_age_group || entry.childAgeGroup || entry.age_group || entry.ageGroup || entry.age || entry.child_age;
        if(rawGroup === undefined || rawGroup === null) return null;
        const asNumber = Number(rawGroup);
        if(!Number.isNaN(asNumber)) {
          if(asNumber <= 3) return 'infants';
          if(asNumber <= 6) return 'early';
          if(asNumber <= 12) return 'school';
          return null;
        }
        const text = String(rawGroup).toLowerCase();
        if(text.includes('infant') || text.includes('toddler')) return 'infants';
        if(text.includes('early')) return 'early';
        if(text.includes('school')) return 'school';
        return null;
      };

      const updatePie = (element, seg1, seg2, seg3, label) => {
        if(!element) return;
        const s1 = Math.max(0, Math.min(100, seg1));
        const s2 = Math.max(0, Math.min(100, seg2));
        const s3 = Math.max(0, Math.min(100, seg3));
        element.style.setProperty('--seg-1', s1);
        element.style.setProperty('--seg-2', s2);
        element.style.setProperty('--seg-3', s3);
        if(label) element.setAttribute('aria-label', label);
      };

      const renderDashboardInsights = (sessions, requests, stats = {}, insights = {}) => {
        const ageCounts = { infants: 0, early: 0, school: 0 };
        const ageMix = insights.ageMix;
        if(ageMix){
          ageCounts.infants = Number(ageMix.infants || 0);
          ageCounts.early = Number(ageMix.early || 0);
          ageCounts.school = Number(ageMix.school || 0);
        } else {
          [...(sessions || []), ...(requests || [])].forEach((entry) => {
            const group = parseAgeGroup(entry);
            if(group && ageCounts[group] !== undefined) ageCounts[group] += 1;
          });
        }
        const ageTotal = ageCounts.infants + ageCounts.early + ageCounts.school;
        const infantsPct = ageTotal ? Math.round((ageCounts.infants / ageTotal) * 100) : 0;
        const earlyPct = ageTotal ? Math.round((ageCounts.early / ageTotal) * 100) : 0;
        const schoolPct = ageTotal ? Math.max(0, 100 - infantsPct - earlyPct) : 0;
        updatePie(
          document.getElementById('ageMixPie'),
          infantsPct,
          earlyPct,
          schoolPct,
          `Infants and toddlers ${infantsPct} percent, early childhood ${earlyPct} percent, school-age ${schoolPct} percent`
        );
        const ageTop = Object.entries(ageCounts).sort((a, b) => b[1] - a[1])[0];
        const topLabelMap = { infants: 'Infants & Toddlers', early: 'Early Childhood', school: 'School-Age' };
        const topLabel = ageTop && ageTop[1] > 0 ? topLabelMap[ageTop[0]] : 'No data yet';
        const topPercent = ageTotal && ageTop ? Math.round((ageTop[1] / ageTotal) * 100) : 0;
        const agePrimary = document.getElementById('ageMixPrimary');
        if(agePrimary) agePrimary.textContent = `${topPercent}%`;
        const agePrimaryLabel = document.getElementById('ageMixPrimaryLabel');
        if(agePrimaryLabel) agePrimaryLabel.textContent = topLabel;
        const ageInfantsEl = document.getElementById('ageMixInfants');
        if(ageInfantsEl) ageInfantsEl.textContent = `${ageCounts.infants}`;
        const ageEarlyEl = document.getElementById('ageMixEarly');
        if(ageEarlyEl) ageEarlyEl.textContent = `${ageCounts.early}`;
        const ageSchoolEl = document.getElementById('ageMixSchool');
        if(ageSchoolEl) ageSchoolEl.textContent = `${ageCounts.school}`;

        const allSessions = sessions || [];
        let cancelledCount = allSessions.filter(isCancelled).length;
        let totalSessions = allSessions.length;
        let successCount = Math.max(0, totalSessions - cancelledCount);
        if(insights.success){
          successCount = Number(insights.success.completed || 0);
          cancelledCount = Number(insights.success.cancelled || 0);
          totalSessions = successCount + cancelledCount;
        }
        const successPct = totalSessions ? Math.round((successCount / totalSessions) * 100) : 0;
        updatePie(
          document.getElementById('successRatePie'),
          successPct,
          Math.max(0, 100 - successPct),
          0,
          `Success rate ${successPct} percent, cancellations ${Math.max(0, 100 - successPct)} percent`
        );
        const successValueEl = document.getElementById('successRateValue');
        if(successValueEl) successValueEl.textContent = `${successPct}%`;
        const successCountEl = document.getElementById('successCount');
        if(successCountEl) successCountEl.textContent = `${successCount}`;
        const cancelCountEl = document.getElementById('cancelCount');
        if(cancelCountEl) cancelCountEl.textContent = `${cancelledCount}`;

        let repeatFamilies = 0;
        let newFamilies = 0;
        if(insights.repeatFamilies){
          repeatFamilies = Number(insights.repeatFamilies.repeat || 0);
          newFamilies = Number(insights.repeatFamilies.new || 0);
        } else {
          const familyCounts = new Map();
          allSessions.filter((entry) => !isCancelled(entry)).forEach((entry) => {
            const key = entry.parent_id || entry.parentId || entry.parent_user_id || entry.parent || entry.parent_name || entry.family_name || entry.family || entry.email || entry.id;
            if(!key) return;
            familyCounts.set(key, (familyCounts.get(key) || 0) + 1);
          });
          repeatFamilies = Array.from(familyCounts.values()).filter((count) => count > 1).length;
          newFamilies = Array.from(familyCounts.values()).filter((count) => count === 1).length;
        }
        const totalFamilies = repeatFamilies + newFamilies;
        const repeatPct = totalFamilies ? Math.round((repeatFamilies / totalFamilies) * 100) : 0;
        updatePie(
          document.getElementById('repeatFamiliesPie'),
          repeatPct,
          Math.max(0, 100 - repeatPct),
          0,
          `Repeat families ${repeatPct} percent, new families ${Math.max(0, 100 - repeatPct)} percent`
        );
        const repeatValueEl = document.getElementById('repeatFamiliesPercent');
        if(repeatValueEl) repeatValueEl.textContent = `${repeatPct}%`;
        const repeatCountEl = document.getElementById('repeatFamiliesCount');
        if(repeatCountEl) repeatCountEl.textContent = `${repeatFamilies}`;
        const newCountEl = document.getElementById('repeatFamiliesNewCount');
        if(newCountEl) newCountEl.textContent = `${newFamilies}`;

        const toNumber = (value) => {
          const num = Number(value);
          return Number.isNaN(num) ? 0 : num;
        };
        const resolveEarnings = (entry) => {
          if(entry.provider_earnings_cents) return toNumber(entry.provider_earnings_cents) / 100;
          if(entry.payment_amount_cents) return toNumber(entry.payment_amount_cents) / 100;
          return toNumber(entry.provider_earnings || entry.earnings || entry.amount || entry.total || 0);
        };
        const resolveTip = (entry) => {
          if(entry.tip_cents) return toNumber(entry.tip_cents) / 100;
          return toNumber(entry.tip || entry.tips || 0);
        };
        const resolveBonus = (entry) => {
          if(entry.bonus_cents) return toNumber(entry.bonus_cents) / 100;
          return toNumber(entry.bonus || entry.bonus_amount || 0);
        };
        const resolveCare = (entry) => {
          const raw = String(entry.care_type || entry.careType || entry.care || '').toLowerCase();
          if(raw.includes('curriculum')) return 'curriculum';
          if(raw.includes('mixed')) return 'mixed';
          if(raw.includes('standard')) return 'standard';
          return 'standard';
        };
        let curriculumTotal = 0;
        let standardTotal = 0;
        let tipsTotal = toNumber(stats.tips || 0);
        let bonusesTotal = 0;
        if(insights.earnings){
          curriculumTotal = toNumber(insights.earnings.curriculumCents || 0) / 100;
          standardTotal = toNumber(insights.earnings.standardCents || 0) / 100;
          tipsTotal = toNumber(insights.earnings.tipsCents || 0) / 100;
          bonusesTotal = toNumber(insights.earnings.bonusesCents || 0) / 100;
        } else {
          allSessions.forEach((entry) => {
            const amount = resolveEarnings(entry);
            const tip = resolveTip(entry);
            const bonus = resolveBonus(entry);
            if(amount > 0) {
              const care = resolveCare(entry);
              if(care === 'curriculum') curriculumTotal += amount;
              else standardTotal += amount;
            }
            if(tip > 0) tipsTotal += tip;
            if(bonus > 0) bonusesTotal += bonus;
          });
          if(curriculumTotal + standardTotal === 0 && toNumber(stats.earnings || 0) > 0) {
            standardTotal = toNumber(stats.earnings || 0);
          }
        }
        const totalEarnings = curriculumTotal + standardTotal + tipsTotal + bonusesTotal;
        const setSegWidth = (id, value) => {
          const el = document.getElementById(id);
          if(!el) return;
          const pct = totalEarnings ? Math.round((value / totalEarnings) * 100) : 0;
          el.style.setProperty('--w', `${pct}%`);
        };
        setSegWidth('earnSegCurriculum', curriculumTotal);
        setSegWidth('earnSegStandard', standardTotal);
        setSegWidth('earnSegTips', tipsTotal);
        setSegWidth('earnSegBonuses', bonusesTotal);
        const totalEl = document.getElementById('earningsTotal');
        if(totalEl) totalEl.textContent = `${formatCurrency(totalEarnings)} total`;
        const currEl = document.getElementById('earnCurriculumValue');
        if(currEl) currEl.textContent = formatCurrency(curriculumTotal);
        const stdEl = document.getElementById('earnStandardValue');
        if(stdEl) stdEl.textContent = formatCurrency(standardTotal);
        const tipsEl = document.getElementById('earnTipsValue');
        if(tipsEl) tipsEl.textContent = formatCurrency(tipsTotal);
        const bonusEl = document.getElementById('earnBonusesValue');
        if(bonusEl) bonusEl.textContent = formatCurrency(bonusesTotal);
        const emptyEl = document.getElementById('earningsEmpty');
        if(emptyEl) emptyEl.style.display = totalEarnings > 0 ? 'none' : 'block';
      };

      const resolveRequestType = (entry) => {
        if(entry.is_recurring === true || entry.recurring === true) return 'Recurring';
        const raw = String(entry.request_type || entry.type || '').toLowerCase();
        if(raw.includes('recurring')) return 'Recurring';
        if(raw.includes('one')) return 'One-time';
        return 'One-time';
      };

      const resolveChildAge = (entry) => {
        return entry.child_age || entry.childAge || entry.child_age_group || entry.age || 'Not specified';
      };

      const resolveHoursPerWeek = (entry) => {
        const hours = entry.hours_per_week || entry.hoursPerWeek || entry.weekly_hours || entry.hours;
        if(hours === undefined || hours === null || hours === '') return 'TBD';
        return `${hours} hrs/week`;
      };

      const resolveTimeOfDay = (entry) => {
        const raw = String(entry.time_of_day || entry.timeOfDay || '').toLowerCase();
        if(raw.includes('morning')) return 'Mornings';
        if(raw.includes('afternoon')) return 'Afternoons';
        if(raw.includes('evening')) return 'Evenings';
        if(raw.includes('mixed')) return 'Mixed';
        const startTime = entry.start_time || (entry.start_at ? new Date(entry.start_at).toTimeString().slice(0,5) : '');
        const minutes = minutesFromTime(startTime);
        if(minutes !== null) {
          if(minutes < 12 * 60) return 'Mornings';
          if(minutes < 17 * 60) return 'Afternoons';
          return 'Evenings';
        }
        return 'Mixed';
      };

      const renderAreaRequests = (requests) => {
        const listEl = document.getElementById('areaRequestsList');
        const countEl = document.getElementById('areaRequestsCount');
        const rows = (requests || []);
        if(countEl) countEl.textContent = `${rows.length} requests`;
        if(!listEl) return;
        if(rows.length === 0) {
          listEl.innerHTML = '<div class="provider-requests-empty">No requests in your area yet.</div>';
          return;
        }
        listEl.innerHTML = rows.map((entry) => {
          const requestType = resolveRequestType(entry);
          const childAge = resolveChildAge(entry);
          const hours = resolveHoursPerWeek(entry);
          const careType = resolveCareType(entry);
          const careClass = careType === 'Curriculum' ? 'care-pill-curriculum' : (careType === 'Mixed' ? 'care-pill-mixed' : 'care-pill-standard');
          const timeOfDay = resolveTimeOfDay(entry);
          const detailsLink = entry.details_url || entry.detailsUrl || entry.link || '#';
          return `
            <div class="provider-requests-row provider-requests-item">
              <div class="provider-requests-cell" data-label="Request type">${requestType}</div>
              <div class="provider-requests-cell" data-label="Child age">${childAge}</div>
              <div class="provider-requests-cell" data-label="Hours / week">${hours}</div>
              <div class="provider-requests-cell" data-label="Care type"><span class="care-pill ${careClass}">${careType}</span></div>
              <div class="provider-requests-cell" data-label="Time of day">${timeOfDay}</div>
              <div class="provider-requests-cell provider-requests-action" data-label="Action">
                <button class="provider-reach-btn" type="button">Reach out</button>
                <a class="provider-details-link" href="${detailsLink}">View details</a>
                <span class="provider-careplus-pill">Care+</span>
              </div>
            </div>
          `;
        }).join('');
      };

      const availabilityDays = [
        { key: 'monday', label: 'Monday' },
        { key: 'tuesday', label: 'Tuesday' },
        { key: 'wednesday', label: 'Wednesday' },
        { key: 'thursday', label: 'Thursday' },
        { key: 'friday', label: 'Friday' },
        { key: 'saturday', label: 'Saturday' },
        { key: 'sunday', label: 'Sunday' }
      ];
      const createDefaultSlot = () => ({ start: '08:00', end: '17:00' });
      let availabilityState = {};
      let availabilityNotes = null;
      let availabilitySnapshot = null;
      let availabilityUserId = null;
      let availabilityApiBase = null;

      const cloneAvailability = (value) => JSON.parse(JSON.stringify(value));

      const normalizeAvailabilityFromApi = (raw) => {
        const normalized = {};
        availabilityDays.forEach(({ key }) => {
          const dayData = raw && raw[key] ? raw[key] : null;
          let slots = [];
          if(Array.isArray(dayData)) {
            slots = dayData;
          } else if(dayData && Array.isArray(dayData.slots)) {
            slots = dayData.slots;
          } else if(dayData && typeof dayData === 'object') {
            slots = [dayData];
          }
          const slotList = slots.length
            ? slots.map((slot) => ({
              start: slot.start || slot.from || '08:00',
              end: slot.end || slot.to || '17:00'
            }))
            : [createDefaultSlot()];
          const enabled = dayData
            ? (typeof dayData.enabled === 'boolean' ? dayData.enabled : slots.length > 0)
            : false;
          normalized[key] = {
            enabled,
            slots: slotList
          };
        });
        return normalized;
      };

      const setAvailabilityFromProfile = (profile) => {
        const rawAvailability = profile?.availability || {};
        const parsed = typeof rawAvailability === 'string' ? JSON.parse(rawAvailability || '{}') : rawAvailability;
        const scheduleSource = parsed?.schedule && typeof parsed.schedule === 'object' ? parsed.schedule : parsed;
        availabilityNotes = parsed?.notes || null;
        availabilityState = normalizeAvailabilityFromApi(scheduleSource || {});
        availabilitySnapshot = {
          state: cloneAvailability(availabilityState),
          notes: availabilityNotes
        };
      };

      const buildAvailabilityPayload = () => {
        const schedule = {};
        availabilityDays.forEach(({ key }) => {
          const day = availabilityState[key];
          if(!day || !day.enabled) return;
          const slots = (day.slots || []).map((slot) => ({
            from: slot.start || slot.from || '',
            to: slot.end || slot.to || ''
          })).filter((slot) => slot.from || slot.to);
          if(slots.length) schedule[key] = slots;
        });
        return {
          schedule,
          notes: availabilityNotes || null
        };
      };

      const renderAvailabilityEditor = () => {
        const editor = document.getElementById('availabilityEditor');
        if(!editor) return;
        editor.innerHTML = availabilityDays.map(({ key, label }) => {
          const day = availabilityState[key];
          const disabledAttr = day.enabled ? '' : 'disabled';
          const rowClass = day.enabled ? 'availability-day' : 'availability-day is-disabled';
          const slotsMarkup = day.slots.map((slot, index) => {
            return `
              <div class="availability-slot" data-day="${key}" data-slot="${index}">
                <label class="sr-only" for="availability-${key}-start-${index}">Start time</label>
                <input type="time" id="availability-${key}-start-${index}" data-day="${key}" data-slot="${index}" data-field="start" value="${slot.start}" ${disabledAttr}>
                <span class="availability-slot-sep">â</span>
                <label class="sr-only" for="availability-${key}-end-${index}">End time</label>
                <input type="time" id="availability-${key}-end-${index}" data-day="${key}" data-slot="${index}" data-field="end" value="${slot.end}" ${disabledAttr}>
                <button class="availability-icon-btn availability-remove-slot" type="button" data-day="${key}" data-slot="${index}" ${disabledAttr} aria-label="Remove time slot">Ã</button>
              </div>
            `;
          }).join('');
          return `
            <div class="${rowClass}" data-day="${key}">
              <div class="availability-day-toggle">
                <input class="availability-checkbox" type="checkbox" id="availability-${key}" data-day="${key}" ${day.enabled ? 'checked' : ''}>
                <label for="availability-${key}">${label}</label>
              </div>
              <div class="availability-slots">
                ${slotsMarkup}
              </div>
              <div class="availability-day-actions">
                <button class="availability-icon-btn availability-add-slot" type="button" data-day="${key}" ${disabledAttr} aria-label="Add time slot">+</button>
              </div>
            </div>
          `;
        }).join('');
      };

      const initAvailabilityEditor = ({ profile, apiBase, userId } = {}) => {
        const editor = document.getElementById('availabilityEditor');
        if(!editor) return;
        if(apiBase) availabilityApiBase = apiBase;
        if(userId) availabilityUserId = userId;
        setAvailabilityFromProfile(profile || {});
        renderAvailabilityEditor();

        if(editor.dataset.ready === 'true') return;
        editor.dataset.ready = 'true';

        editor.addEventListener('change', (event) => {
          const target = event.target;
          if(!(target instanceof HTMLElement)) return;
          if(target.classList.contains('availability-checkbox')) {
            const dayKey = target.dataset.day;
            if(!dayKey) return;
            availabilityState[dayKey].enabled = target.checked;
            if(target.checked && availabilityState[dayKey].slots.length === 0) {
              availabilityState[dayKey].slots = [createDefaultSlot()];
            }
            const row = target.closest('.availability-day');
            if(row) row.classList.toggle('is-disabled', !target.checked);
            row?.querySelectorAll('input[type="time"], .availability-add-slot, .availability-remove-slot').forEach((el) => {
              el.disabled = !target.checked;
            });
          }
          if(target instanceof HTMLInputElement && target.type === 'time') {
            const dayKey = target.dataset.day;
            const slotIndex = Number(target.dataset.slot);
            const field = target.dataset.field;
            if(!dayKey || Number.isNaN(slotIndex) || !field) return;
            if(!availabilityState[dayKey].slots[slotIndex]) return;
            availabilityState[dayKey].slots[slotIndex][field] = target.value;
          }
        });

        editor.addEventListener('click', (event) => {
          const target = event.target;
          if(!(target instanceof HTMLElement)) return;
          const addBtn = target.closest('.availability-add-slot');
          if(addBtn) {
            const dayKey = addBtn.dataset.day;
            if(dayKey && availabilityState[dayKey].enabled) {
              availabilityState[dayKey].slots.push(createDefaultSlot());
              renderAvailabilityEditor();
            }
          }
          const removeBtn = target.closest('.availability-remove-slot');
          if(removeBtn) {
            const dayKey = removeBtn.dataset.day;
            const slotIndex = Number(removeBtn.dataset.slot);
            if(!dayKey || Number.isNaN(slotIndex)) return;
            if(availabilityState[dayKey].slots.length <= 1) {
              availabilityState[dayKey].slots[0] = createDefaultSlot();
            } else {
              availabilityState[dayKey].slots.splice(slotIndex, 1);
            }
            renderAvailabilityEditor();
          }
        });

        document.getElementById('availabilitySaveBtn')?.addEventListener('click', () => {
          const status = document.getElementById('availabilityStatus');
          if(!availabilityUserId || !availabilityApiBase){
            if(status) status.textContent = 'Please sign in to save availability.';
            return;
          }
          if(status) status.textContent = 'Saving...';
          fetch(`${availabilityApiBase}/forms/provider/${availabilityUserId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ availability: buildAvailabilityPayload() })
          })
            .then((res) => {
              if(!res.ok) throw new Error('Save failed');
              availabilitySnapshot = {
                state: cloneAvailability(availabilityState),
                notes: availabilityNotes
              };
              if(status) status.textContent = 'Availability saved to profile.';
            })
            .catch((_err) => {
              if(status) status.textContent = 'Save failed. Try again.';
            });
        });
        document.getElementById('availabilityCancelBtn')?.addEventListener('click', () => {
          if(availabilitySnapshot){
            availabilityState = cloneAvailability(availabilitySnapshot.state);
            availabilityNotes = availabilitySnapshot.notes;
            renderAvailabilityEditor();
          }
          const status = document.getElementById('availabilityStatus');
          if(status) status.textContent = 'Changes reverted.';
        });
      };

      window.addEventListener('DOMContentLoaded', async () => {
        const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';
        const userId = parseInt(localStorage.getItem('user_id'), 10);
        const userType = localStorage.getItem('user_type');
        if(!userId || userType !== 'provider') return;

        initAvailabilityEditor({ apiBase: API_BASE, userId });

        try {
          const resp = await fetch(`${API_BASE}/forms/provider/${userId}`);
          if(!resp.ok) throw new Error('Failed to load provider data');
          const data = await resp.json();
          const profile = data.profile || {};
          const name = profile.first_name || profile.name || '';

          if(name) {
            const welcomeName = document.getElementById('providerWelcomeName');
            if(welcomeName) welcomeName.textContent = `, ${name}`;
            const sidebarName = document.getElementById('providerSidebarName');
            if(sidebarName) sidebarName.textContent = `Signed in as ${name}`;
          }

          const stats = data.stats || {};
          const earnings = stats.earnings || stats.earnings_month || 0;
          const monthHours = computeMonthlyHours(data.sessions || [], data.requests || []);

          const earningsEl = document.getElementById('metricMonthlyEarnings');
          if(earningsEl) earningsEl.textContent = formatCurrency(earnings);

          const hoursEl = document.getElementById('metricMonthlyHours');
          if(hoursEl) hoursEl.textContent = formatHours(monthHours);
          renderUpcomingBookings(data.sessions || [], data.requests || []);
          renderAreaRequests(data.area_requests || data.areaRequests || []);
          renderDashboardInsights(data.sessions || [], data.requests || [], stats, data.insights || {});
          initAvailabilityEditor({ profile, apiBase: API_BASE, userId });
        } catch (err) {
          console.error('Failed to load provider metrics', err);
        }
      });
    </script>
  </body>
</html>
