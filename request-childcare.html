<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Request Childcare - Assured Hearts</title>
    <meta name="description" content="Confirm availability and request childcare by adding child details." />
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <div class="nav-auth">
          <a href="parent-dashboard.html" style="display: flex; align-items: center; gap: 6px; color: #06464E; text-decoration: none; font-weight: 600;">Dashboard</a>
        </div>
        <button id="mobileMenuBtn" class="mobile-menu" aria-label="Open menu">
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <header class="hero" style="padding: 64px 16px; background: linear-gradient(135deg, #f4fbfd 0%, #fff7f7 100%);">
      <div class="container" style="max-width: 900px;">
        <h1 style="text-align: center; margin-bottom: 12px;">Request Childcare</h1>
        <p class="lead" style="text-align: center; margin-bottom: 24px;">We found caregivers in your area. Add your child details to complete your request.</p>
      </div>
    </header>

    <main class="container" style="padding: 48px 24px; max-width: 900px;">
      <section id="availabilityCard" style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 id="availabilityTitle" style="margin: 0 0 8px 0; color: #06464E;">Caregivers are available near you</h2>
            <p id="availabilitySubtitle" style="margin: 0; color: #666; font-size: 14px;">Based on your recent search location.</p>
          </div>
          <span style="background: #eef7f2; color: #2d6b42; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 700;">Available</span>
        </div>
      </section>

      <section style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
        <h2 style="margin: 0 0 12px 0; color: #06464E;">Next Step</h2>
        <p style="margin: 0 0 20px 0; color: #666;">Submit your childcare request and we'll match you with available caregivers in your area.</p>
        
        <div style="margin-bottom: 20px;">
          <label for="childSelect" style="display: block; margin-bottom: 8px; color: #06464E; font-weight: 600; font-size: 14px;">Which child is this request for?</label>
          <select id="childSelect" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
            <option value="">Loading your children...</option>
          </select>
          <p style="margin: 8px 0 0 0; color: #999; font-size: 12px;">If you don't see your child, a new entry will be created when you submit.</p>
        </div>
        
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button id="submitRequestBtn" class="btn" style="padding: 12px 16px; background: linear-gradient(135deg, #67B3C2 0%, #06464E 100%); color: white; border: none; cursor: pointer; border-radius: 10px; font-weight: 700; font-size: 14px;">Submit Request →</button>
        </div>
        <p id="notAvailableMsg" style="display:none; margin-top: 12px; color: #8b6914; background: #fff9e6; padding: 10px 12px; border-radius: 8px;">Care is not yet confirmed for your area. Please search in <a href="find-childcare.html" style="color:#06464E; font-weight:600; text-decoration:none;">Find Childcare</a>.</p>
      </section>
    </main>

    <footer style="background: #06464E; color: white; padding: 32px 24px; text-align: center; margin-top: 48px;">
      <p style="margin: 0;">© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
      // Guard: require account and available care
      const userId = parseInt(localStorage.getItem('user_id')) || null;
      const available = localStorage.getItem('care_available') === 'true';
      const submitRequestBtn = document.getElementById('submitRequestBtn');
      const childSelect = document.getElementById('childSelect');
      const notMsg = document.getElementById('notAvailableMsg');
      const availabilityCard = document.getElementById('availabilityCard');
      const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';

      if(!userId){
        // Require login to access this page
        const showBanner = window.showBanner || function(msg, type){
          const div = document.createElement('div');
          div.id = 'globalBanner';
          const base = 'position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 12px 16px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-weight: 700; min-width: 280px; text-align: center;';
          const styles = { info: 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;' };
          div.setAttribute('style', base + (styles[type] || styles.info));
          div.textContent = msg;
          document.body.appendChild(div);
        };
        showBanner('Please sign in to request childcare.', 'info');
        setTimeout(() => window.location.href = 'account-signup.html', 1500);
      } else {
        // Load existing children
        fetch(`${API_BASE}/forms/parent/${userId}`)
          .then(res => res.json())
          .then(data => {
            const children = data.children || [];
            if(children.length > 0){
              childSelect.innerHTML = '<option value="">-- Select a child --</option>' + 
                children.map((child, idx) => `<option value="${child.id}">Child ${idx + 1}</option>`).join('');
            } else {
              childSelect.innerHTML = '<option value="">No children yet - a new entry will be created</option>';
            }
          })
          .catch(err => {
            console.warn('Failed to load children:', err);
            childSelect.innerHTML = '<option value="">Unable to load children</option>';
          });
      }

      if(!available){
        notMsg.style.display = 'block';
        availabilityCard.querySelector('span').textContent = 'Not Confirmed';
        availabilityCard.querySelector('span').style.background = '#fff9e6';
        availabilityCard.querySelector('span').style.color = '#8b6914';
        submitRequestBtn.addEventListener('click', function(e){
          e.preventDefault();
          window.location.href = 'find-childcare.html';
        });
      } else {
        // Handle request submission
        submitRequestBtn.addEventListener('click', async function(e){
          e.preventDefault();
          const location = localStorage.getItem('last_search_location') || '';
          const childId = childSelect.value;
          
          if(!location){
            showBanner('Please search for childcare in your area first.', 'info');
            setTimeout(() => window.location.href = 'find-childcare.html', 1500);
            return;
          }

          submitRequestBtn.disabled = true;
          submitRequestBtn.textContent = 'Submitting...';

          try {
            const res = await fetch(`${API_BASE}/forms/request`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user_id: userId, child_id: childId ? parseInt(childId) : null, location, notes: '' })
            });
            
            if(!res.ok) throw new Error('Failed to submit request');
            
            showBanner('Request submitted successfully!', 'success');
            setTimeout(() => window.location.href = 'parent-dashboard.html', 1500);
          } catch (err) {
            console.error('Request submission error:', err);
            showBanner('Failed to submit request. Please try again.', 'error');
            submitRequestBtn.disabled = false;
            submitRequestBtn.textContent = 'Submit Request →';
          }
        });
      }

      // Fetch and display caregiver count from API
      const lastLocation = localStorage.getItem('last_search_location');
      const availabilityTitle = document.getElementById('availabilityTitle');
      
      if(lastLocation){
        document.getElementById('availabilitySubtitle').textContent = `Based on your recent search: ${lastLocation}`;
        
        // Fetch real count from backend
        fetch(`${API_BASE}/search?city=${encodeURIComponent(lastLocation)}`)
          .then(res => res.json())
          .then(data => {
            const count = Number(data.caregivers || 0);
            if(count > 0){
              availabilityTitle.textContent = `${count} caregiver${count === 1 ? '' : 's'} available near ${lastLocation}`;
            } else {
              availabilityTitle.textContent = 'Checking availability...';
            }
          })
          .catch(err => {
            console.warn('Failed to fetch caregiver count:', err);
            availabilityTitle.textContent = 'Caregivers are available near you';
          });
      } else {
        availabilityTitle.textContent = 'Caregivers are available near you';
      }
    </script>
  </body>
</html>
