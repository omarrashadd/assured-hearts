<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Request Childcare - Assured Hearts</title>
    <meta name="description" content="Confirm availability and request childcare by adding child details." />
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <div class="nav-auth">
          <a href="parent-dashboard.html" style="display: flex; align-items: center; gap: 6px; color: #06464E; text-decoration: none; font-weight: 600;">Dashboard</a>
        </div>
        <button id="mobileMenuBtn" class="mobile-menu" aria-label="Open menu">
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <header class="hero" style="padding: 48px 16px; background: linear-gradient(135deg, #f4fbfd 0%, #fff7f7 100%); text-align:center;">
      <div class="container" style="max-width: 900px;">
        <h1 id="heroTitle" style="margin: 0 0 12px 0; color:#06464E;">Request Childcare</h1>
        <p id="heroSubtitle" class="lead" style="margin: 0; color:#4b5563;">Select your caregiver and complete your request.</p>
      </div>
    </header>

    <main class="container" style="padding: 32px 24px 48px 24px; max-width: 900px;">

      <section style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
        <h2 style="margin: 0 0 12px 0; color: #06464E;">Next Step</h2>
        <p style="margin: 0 0 20px 0; color: #666;">Submit your childcare request and we'll match you with available caregivers in your area.</p>
        
        <div id="providerSummary" style="display:none; margin-bottom:16px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; background:#f8fbfc;">
          <p id="providerSummaryText" style="margin:0; color:#06464E; font-weight:700; font-size:14px;"></p>
        </div>

        <div id="providerPicker" style="margin-bottom:20px;">
          <h3 style="margin:0 0 10px 0; color:#06464E; font-size:16px;">Select a caregiver</h3>
          <p style="margin:0 0 12px 0; color:#6b7280; font-size:13px;">Choose from your favorites or other caregivers in your area.</p>
          <div id="favoriteProviders" style="margin-bottom:12px; display:none;">
            <h4 style="margin:0 0 8px 0; color:#06464E; font-size:14px;">Favorites</h4>
            <div id="favoriteProvidersList" style="display:grid; gap:8px;"></div>
          </div>
          <div>
            <h4 style="margin:0 0 8px 0; color:#06464E; font-size:14px;">Other caregivers in your area</h4>
            <div id="otherProvidersList" style="display:grid; gap:8px;"></div>
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="childSelect" style="display: block; margin-bottom: 8px; color: #06464E; font-weight: 600; font-size: 14px;">Which child is this request for?</label>
          <div style="display: flex; gap: 8px;">
            <select id="childSelect" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
              <option value="">Loading your children...</option>
            </select>
            <button id="newChildBtn" type="button" style="padding: 10px 16px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 14px; font-weight: 600; color: #06464E;">+ New</button>
          </div>
        </div>

        <!-- Child Details Section (Hidden by default, shown when child selected or new clicked) -->
        <div id="childDetailsSection" style="display: none; margin-bottom: 20px; padding: 16px; background: #f8fbfc; border-radius: 8px; border: 1px solid #e5e7eb;">
          <h3 style="margin: 0 0 16px 0; color: #06464E; font-size: 16px;" id="childDetailTitle">Child Information</h3>
          
          <div style="display: grid; gap: 12px;">
            <div>
              <label for="detailChildName" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Child's name *</label>
              <input id="detailChildName" type="text" placeholder="Enter child's name" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div>
              <label for="detailChildAge" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Child's age</label>
              <input id="detailChildAge" type="number" min="0" max="17" placeholder="Age in years" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>

            <div>
              <label for="detailFrequency" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">How often do you need childcare?</label>
              <select id="detailFrequency" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">Select frequency</option>
                <option value="daily">Daily</option>
                <option value="few-times-week">A few times a week</option>
                <option value="weekly">Weekly</option>
                <option value="bi-weekly">Bi-weekly</option>
                <option value="monthly">Monthly</option>
                <option value="occasional">Occasional/as needed</option>
              </select>
            </div>

            <div>
              <label for="detailSchedule" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Preferred schedule</label>
              <textarea id="detailSchedule" rows="2" placeholder="E.g., Weekday mornings, Saturday evenings..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div>
              <label for="detailSpecialNeeds" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Any special requirements?</label>
              <textarea id="detailSpecialNeeds" rows="2" placeholder="Dietary needs, allergies, special accommodations..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit;"></textarea>
            </div>
          </div>
        </div>

        <div style="display:grid; gap:12px; margin-bottom:16px;">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:12px;">
            <label style="display:flex; flex-direction:column; gap:6px; color:#374151;">
              Date
              <input type="date" id="bookingDate" style="padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
            </label>
            <label style="display:flex; flex-direction:column; gap:6px; color:#374151;">
              Start time
              <select id="bookingStart" style="padding:10px 12px; border:1px solid #ddd; border-radius:8px; background:#fff;">
                <option value="">Select start time</option>
              </select>
            </label>
            <label style="display:flex; flex-direction:column; gap:6px; color:#374151;">
              End time
              <select id="bookingEnd" style="padding:10px 12px; border:1px solid #ddd; border-radius:8px; background:#fff;">
                <option value="">Select end time</option>
              </select>
            </label>
          </div>
          <label style="display:flex; flex-direction:column; gap:6px; color:#374151;">
            Location
            <input type="text" id="bookingLocation" placeholder="Address or area" style="padding:10px 12px; border:1px solid #ddd; border-radius:8px;">
          </label>
          <label style="display:flex; flex-direction:column; gap:6px; color:#374151;">
            Notes to caregiver (optional)
            <textarea id="requestNotes" rows="2" style="padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-family:inherit;" placeholder="Anything they should know?"></textarea>
          </label>
        </div>
        
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button id="submitRequestBtn" class="btn" style="padding: 12px 16px; background: linear-gradient(135deg, #67B3C2 0%, #06464E 100%); color: white; border: none; cursor: pointer; border-radius: 10px; font-weight: 700; font-size: 14px;">Submit Request →</button>
        </div>
        <p id="notAvailableMsg" style="display:none; margin-top: 12px; color: #8b6914; background: #fff9e6; padding: 10px 12px; border-radius: 8px;">Care is not yet confirmed for your area. Please search in <a href="find-childcare.html" style="color:#06464E; font-weight:600; text-decoration:none;">Find Childcare</a>.</p>
      </section>
    </main>

    <footer style="background: #06464E; color: white; padding: 32px 24px; text-align: center; margin-top: 48px;">
      <p style="margin: 0;">© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
      // Guard: require account and available care
      const userId = parseInt(localStorage.getItem('user_id')) || null;
      const available = localStorage.getItem('care_available') === 'true';
      const params = new URLSearchParams(window.location.search);
      const providerIdParam = params.get('provider_id');
      const providerNameParam = params.get('provider_name');
      const submitRequestBtn = document.getElementById('submitRequestBtn');
      const childSelect = document.getElementById('childSelect');
      const newChildBtn = document.getElementById('newChildBtn');
      const childDetailsSection = document.getElementById('childDetailsSection');
      const detailChildName = document.getElementById('detailChildName');
      const detailChildAge = document.getElementById('detailChildAge');
      const detailFrequency = document.getElementById('detailFrequency');
      const detailSchedule = document.getElementById('detailSchedule');
      const detailSpecialNeeds = document.getElementById('detailSpecialNeeds');
      const childDetailTitle = document.getElementById('childDetailTitle');
      const notMsg = document.getElementById('notAvailableMsg');
      const availabilityCard = document.getElementById('availabilityCard');
      const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';
      const providerSummary = document.getElementById('providerSummary');
      const providerSummaryText = document.getElementById('providerSummaryText');
      const bookingDate = document.getElementById('bookingDate');
      const bookingLocation = document.getElementById('bookingLocation');
      const requestNotes = document.getElementById('requestNotes');
      const favoriteProvidersList = document.getElementById('favoriteProvidersList');
      const otherProvidersList = document.getElementById('otherProvidersList');
      const favoriteProvidersWrap = document.getElementById('favoriteProviders');
      const bookingStart = document.getElementById('bookingStart');
      const bookingEnd = document.getElementById('bookingEnd');
      let selectedProviderId = providerIdParam ? parseInt(providerIdParam,10) : null;
      let selectedProviderName = providerNameParam || '';
      const favoriteIds = new Set(JSON.parse(localStorage.getItem('favorite_caregivers') || '[]').map(String));
      
      let allChildren = [];
      let isCreatingNew = false;
      function populateTimeSelect(selectEl){
        if(!selectEl) return;
        const times = [];
        for(let h=6; h<=23; h++){
          for(let m=0; m<60; m+=30){
            const hr = h.toString().padStart(2,'0');
            const min = m.toString().padStart(2,'0');
            const labelHr = (h % 12 === 0 ? 12 : h % 12);
            const ampm = h < 12 ? 'AM' : 'PM';
            times.push({ value: `${hr}:${min}`, label: `${labelHr}:${min} ${ampm}` });
          }
        }
        selectEl.innerHTML = '<option value="">Select time</option>' + times.map(t=> `<option value="${t.value}">${t.label}</option>`).join('');
      }
      populateTimeSelect(bookingStart);
      populateTimeSelect(bookingEnd);

      function renderProviderCard(p){
        const initial = (p.name || 'Caregiver').split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
        const city = p.city || p.province || '';
        const bio = p.bio || p.interest || 'Trusted caregiver in your area.';
        const isSelected = selectedProviderId && String(selectedProviderId) === String(p.id);
        const isFav = favoriteIds.has(String(p.id));
        return `
          <div style="border:1px solid #e5e7eb; border-radius:10px; padding:10px; display:grid; gap:6px; background:${isSelected?'#f0f9ff':'#fff'};">
            <div style="display:flex; align-items:center; gap:10px;">
              <div style="width:38px; height:38px; border-radius:50%; background:linear-gradient(135deg,#67B3C2 0%, #06464E 100%); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;">${initial}</div>
              <div>
                <div style="font-weight:700; color:#06464E;">${p.name || 'Caregiver'}</div>
                <div style="font-size:12px; color:#6b7280;">${city}</div>
              </div>
            </div>
            <p style="margin:0; color:#6b7280; font-size:13px;">${bio}</p>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="select-provider-btn" data-id="${p.id}" data-name="${p.name || 'Caregiver'}" style="padding:8px 10px; border-radius:8px; border:1px solid #06464E; background:${isSelected?'#06464E':'#fff'}; color:${isSelected?'#fff':'#06464E'}; font-weight:700; font-size:12px;">${isSelected?'Selected':'Select'}</button>
              <button class="fav-toggle-btn" data-id="${p.id}" style="padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; background:#fff; color:#6b7280; font-weight:700; font-size:12px;">${isFav?'★ Remove favorite':'☆ Add favorite'}</button>
            </div>
          </div>
        `;
      }

      function attachProviderEvents(){
        document.querySelectorAll('.select-provider-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            selectedProviderId = parseInt(btn.dataset.id,10);
            selectedProviderName = btn.dataset.name || 'Caregiver';
            if(providerSummary){
              providerSummary.style.display = 'block';
              providerSummaryText.textContent = `Booking request will be sent to ${selectedProviderName}`;
            }
            renderProvidersUI(window.__providerList || []);
          });
        });
        document.querySelectorAll('.fav-toggle-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.dataset.id;
            if(!id) return;
            if(favoriteIds.has(id)) favoriteIds.delete(id); else favoriteIds.add(id);
            localStorage.setItem('favorite_caregivers', JSON.stringify(Array.from(favoriteIds)));
            renderProvidersUI(window.__providerList || []);
          });
        });
      }

      function renderProvidersUI(list){
        window.__providerList = list;
        const favorites = list.filter(p => favoriteIds.has(String(p.id)));
        const others = list.filter(p => !favoriteIds.has(String(p.id)));
        if(favoriteProvidersWrap){
          favoriteProvidersWrap.style.display = favorites.length ? 'block' : 'none';
        }
        if(favoriteProvidersList){
          favoriteProvidersList.innerHTML = favorites.length ? favorites.map(renderProviderCard).join('') : '';
        }
        if(otherProvidersList){
          otherProvidersList.innerHTML = others.length ? others.map(renderProviderCard).join('') : '<p style="margin:0; color:#6b7280; font-size:13px;">No caregivers found.</p>';
        }
        attachProviderEvents();
      }

      async function loadProviders(){
        try{
          const resp = await fetch(`${API_BASE}/forms/providers`);
          if(!resp.ok) throw new Error('Failed providers');
          const data = await resp.json();
          const providers = (data.providers || []).map(p=>({
            id: String(p.user_id || p.id),
            name: p.name || 'Caregiver',
            city: p.city || '',
            province: p.province || '',
            bio: p.bio || '',
            rate: p.rate || ''
          }));
          if(providers.length){
            renderProvidersUI(providers);
            return;
          }
        }catch(err){
          console.warn('Provider fetch failed, using fallback', err);
        }
        const fallback = [
          { id:'101', name:'Amina Khalid', city:'Calgary', bio:'5 yrs exp · CPR · Islamic stories' },
          { id:'102', name:'Sara Malik', city:'Calgary', bio:'ECCE · Crafts' },
          { id:'103', name:'Nadia Rahman', city:'Calgary', bio:'ECE · Outdoor play' }
        ];
        renderProvidersUI(fallback);
      }

      loadProviders();

      // Define showBanner function
      const showBanner = window.showBanner || function(msg, type){
        const div = document.createElement('div');
        div.id = 'globalBanner';
        const base = 'position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 12px 16px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-weight: 700; min-width: 280px; text-align: center;';
        const styles = { 
          info: 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;',
          success: 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;',
          error: 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
        };
        div.setAttribute('style', base + (styles[type] || styles.info));
        div.textContent = msg;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      };

      if(!userId){
        // Require login to access this page
        showBanner('Please sign in to request childcare.', 'info');
        setTimeout(() => window.location.href = 'account-signup.html', 1500);
      } else {
        // Load existing children
        fetch(`${API_BASE}/forms/parent/${userId}`)
          .then(res => res.json())
          .then(data => {
            allChildren = data.children || [];
            if(allChildren.length > 0){
              childSelect.innerHTML = '<option value="">-- Select a child --</option>' + 
                allChildren.map((child) => `<option value="${child.id}">${child.first_name || child.name || 'Unnamed Child'}</option>`).join('');
            } else {
              childSelect.innerHTML = '<option value="">No children yet</option>';
            }
          })
          .catch(err => {
            console.warn('Failed to load children:', err);
            childSelect.innerHTML = '<option value="">Unable to load children</option>';
          });

        // When child is selected from dropdown
        childSelect.addEventListener('change', function(e){
          const selectedId = parseInt(e.target.value);
          if(selectedId){
            isCreatingNew = false;
            const child = allChildren.find(c => c.id === selectedId);
            if(child){
              populateChildDetails(child, true);
            }
          } else {
            childDetailsSection.style.display = 'none';
          }
        });

        // Handle new child button
        newChildBtn.addEventListener('click', function(e){
          e.preventDefault();
          isCreatingNew = true;
          childSelect.value = '';
          childDetailsSection.style.display = 'block';
          childDetailTitle.textContent = 'New Child Information';
          detailChildName.value = '';
          detailChildName.disabled = false; // Enable name editing for new child
          detailChildAge.value = '';
          detailChildAge.disabled = false; // Enable age editing for new child
          detailFrequency.value = '';
          detailSchedule.value = '';
          detailSpecialNeeds.value = '';
          detailChildName.focus();
        });
      }

      function populateChildDetails(child, isExisting){
        childDetailsSection.style.display = 'block';
        childDetailTitle.textContent = isExisting ? 'Child Information' : 'New Child Information';
        detailChildName.value = child.first_name || child.name || '';
        detailChildName.disabled = isExisting; // Disable name editing for existing children
        
        // Populate age from first element of ages array
        if(child.ages && Array.isArray(child.ages) && child.ages.length > 0){
          detailChildAge.value = child.ages[0];
        } else if(child.ages){
          const ages = JSON.parse(child.ages || '[]');
          detailChildAge.value = ages.length > 0 ? ages[0] : '';
        }
        detailChildAge.disabled = isExisting; // Disable age editing for existing children
        
        detailFrequency.value = child.frequency || '';
        detailSchedule.value = child.preferred_schedule || '';
        detailSpecialNeeds.value = child.special_needs || '';
      }

      if(!available){
        notMsg.style.display = 'block';
        availabilityCard.querySelector('span').textContent = 'Not Confirmed';
        availabilityCard.querySelector('span').style.background = '#fff9e6';
        availabilityCard.querySelector('span').style.color = '#8b6914';
        submitRequestBtn.addEventListener('click', function(e){
          e.preventDefault();
          window.location.href = 'find-childcare.html';
        });
      } else {
        // Handle request submission
        submitRequestBtn.addEventListener('click', async function(e){
          e.preventDefault();
          const baseLocation = localStorage.getItem('last_search_location') || '';
          const finalLocation = bookingLocation && bookingLocation.value ? bookingLocation.value : baseLocation;
          const childId = childSelect.value ? parseInt(childSelect.value) : null;
          const childName = isCreatingNew ? detailChildName.value.trim() : null;
          const dateVal = bookingDate.value;
          const startVal = bookingStart.value;
          const endVal = bookingEnd.value;
          const start_at = dateVal && startVal ? `${dateVal}T${startVal}` : null;
          const end_at = dateVal && endVal ? `${dateVal}T${endVal}` : null;
          
          if(!selectedProviderId){
            showBanner('Please select a caregiver to send your request to.', 'error');
            return;
          }

          if(!finalLocation){
            showBanner('Please search for childcare in your area first.', 'info');
            setTimeout(() => window.location.href = 'find-childcare.html', 1500);
            return;
          }

          if(!childId && !childName){
            showBanner('Please select a child or enter a new child\'s name.', 'error');
            return;
          }

            submitRequestBtn.disabled = true;
            submitRequestBtn.textContent = 'Submitting...';

            try {
              const payload = { 
                user_id: userId, 
                child_id: childId, 
              location: finalLocation, 
              notes: requestNotes.value || '',
              start_at,
              end_at,
              rate: null,
              provider_id: selectedProviderId ? parseInt(selectedProviderId,10) : null
            };
            // Only include childName if creating a new child
            if(childName) {
              payload.childName = childName;
            }
            console.log('Submitting request with payload:', payload);
            const res = await fetch(`${API_BASE}/forms/request`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            console.log('Response status:', res.status);
            let data = {};
            try {
              data = await res.json();
            } catch (jsonErr) {
              console.warn('Could not parse JSON response:', jsonErr);
              data = {};
            }
            console.log('Response data:', data);
            if(!res.ok) throw new Error(data.error || 'Failed to submit request');
            showBanner('Request submitted successfully!', 'success');
            setTimeout(() => window.location.href = 'parent-dashboard.html', 1500);
          } catch (err) {
            console.error('Request submission error:', err);
            showBanner(`Error: ${err.message}`, 'error');
            submitRequestBtn.disabled = false;
            submitRequestBtn.textContent = 'Submit Request →';
          }
        });
      }

      if(providerIdParam && providerSummary){
        providerSummary.style.display = 'block';
        providerSummaryText.textContent = `Booking request will be sent to ${providerNameParam || 'your selected caregiver'}`;
        const heroTitle = document.getElementById('heroTitle');
        const heroSubtitle = document.getElementById('heroSubtitle');
        if(heroTitle) heroTitle.textContent = `Booking with ${providerNameParam || 'your caregiver'}`;
        if(heroSubtitle) heroSubtitle.textContent = 'Confirm details to send your request.';
      } else if(selectedProviderName){
        providerSummary.style.display = 'block';
        providerSummaryText.textContent = `Booking request will be sent to ${selectedProviderName}`;
        const heroTitle = document.getElementById('heroTitle');
        const heroSubtitle = document.getElementById('heroSubtitle');
        if(heroTitle) heroTitle.textContent = `Booking with ${selectedProviderName}`;
        if(heroSubtitle) heroSubtitle.textContent = 'Confirm details to send your request.';
      }
      if(localStorage.getItem('last_search_location') && bookingLocation) bookingLocation.value = localStorage.getItem('last_search_location');
    </script>
  </body>
</html>
