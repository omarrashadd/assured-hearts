<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Request Childcare - Assured Hearts</title>
    <meta name="description" content="Confirm availability and request childcare by adding child details." />
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <div class="nav-auth">
          <a href="parent-dashboard.html" style="display: flex; align-items: center; gap: 6px; color: #06464E; text-decoration: none; font-weight: 600;">Dashboard</a>
        </div>
        <button id="mobileMenuBtn" class="mobile-menu" aria-label="Open menu">
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <header class="hero" style="padding: 64px 16px; background: linear-gradient(135deg, #f4fbfd 0%, #fff7f7 100%);">
      <div class="container" style="max-width: 900px;">
        <h1 style="text-align: center; margin-bottom: 12px;">Request Childcare</h1>
        <p class="lead" style="text-align: center; margin-bottom: 24px;">We found caregivers in your area. Add your child details to complete your request.</p>
      </div>
    </header>

    <main class="container" style="padding: 48px 24px; max-width: 900px;">
      <section id="availabilityCard" style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 id="availabilityTitle" style="margin: 0 0 8px 0; color: #06464E;">Caregivers are available near you</h2>
            <p id="availabilitySubtitle" style="margin: 0; color: #666; font-size: 14px;">Based on your recent search location.</p>
          </div>
          <span style="background: #eef7f2; color: #2d6b42; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 700;">Available</span>
        </div>
      </section>

      <section style="background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
        <h2 style="margin: 0 0 12px 0; color: #06464E;">Next Step</h2>
        <p style="margin: 0 0 20px 0; color: #666;">Submit your childcare request and we'll match you with available caregivers in your area.</p>
        
        <div style="margin-bottom: 20px;">
          <label for="childSelect" style="display: block; margin-bottom: 8px; color: #06464E; font-weight: 600; font-size: 14px;">Which child is this request for?</label>
          <div style="display: flex; gap: 8px;">
            <select id="childSelect" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
              <option value="">Loading your children...</option>
            </select>
            <button id="newChildBtn" type="button" style="padding: 10px 16px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 14px; font-weight: 600; color: #06464E;">+ New</button>
          </div>
        </div>

        <!-- Child Details Section (Hidden by default, shown when child selected or new clicked) -->
        <div id="childDetailsSection" style="display: none; margin-bottom: 20px; padding: 16px; background: #f8fbfc; border-radius: 8px; border: 1px solid #e5e7eb;">
          <h3 style="margin: 0 0 16px 0; color: #06464E; font-size: 16px;" id="childDetailTitle">Child Information</h3>
          
          <div style="display: grid; gap: 12px;">
            <div>
              <label for="detailChildName" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Child's name *</label>
              <input id="detailChildName" type="text" placeholder="Enter child's name" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div>
              <label for="detailNumChildren" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Number of children</label>
              <select id="detailNumChildren" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">Select</option>
                <option value="1">1 child</option>
                <option value="2">2 children</option>
                <option value="3">3 children</option>
                <option value="4">4 children</option>
                <option value="5">5+ children</option>
              </select>
            </div>

            <div id="childrenAgesContainer" style="display: none;"></div>

            <div>
              <label for="detailFrequency" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">How often do you need childcare?</label>
              <select id="detailFrequency" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">Select frequency</option>
                <option value="daily">Daily</option>
                <option value="few-times-week">A few times a week</option>
                <option value="weekly">Weekly</option>
                <option value="bi-weekly">Bi-weekly</option>
                <option value="monthly">Monthly</option>
                <option value="occasional">Occasional/as needed</option>
              </select>
            </div>

            <div>
              <label for="detailSchedule" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Preferred schedule</label>
              <textarea id="detailSchedule" rows="2" placeholder="E.g., Weekday mornings, Saturday evenings..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div>
              <label for="detailSpecialNeeds" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Any special requirements?</label>
              <textarea id="detailSpecialNeeds" rows="2" placeholder="Dietary needs, allergies, special accommodations..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit;"></textarea>
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button id="submitRequestBtn" class="btn" style="padding: 12px 16px; background: linear-gradient(135deg, #67B3C2 0%, #06464E 100%); color: white; border: none; cursor: pointer; border-radius: 10px; font-weight: 700; font-size: 14px;">Submit Request →</button>
        </div>
        <p id="notAvailableMsg" style="display:none; margin-top: 12px; color: #8b6914; background: #fff9e6; padding: 10px 12px; border-radius: 8px;">Care is not yet confirmed for your area. Please search in <a href="find-childcare.html" style="color:#06464E; font-weight:600; text-decoration:none;">Find Childcare</a>.</p>
      </section>
    </main>

    <footer style="background: #06464E; color: white; padding: 32px 24px; text-align: center; margin-top: 48px;">
      <p style="margin: 0;">© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
      // Guard: require account and available care
      const userId = parseInt(localStorage.getItem('user_id')) || null;
      const available = localStorage.getItem('care_available') === 'true';
      const submitRequestBtn = document.getElementById('submitRequestBtn');
      const childSelect = document.getElementById('childSelect');
      const newChildBtn = document.getElementById('newChildBtn');
      const childDetailsSection = document.getElementById('childDetailsSection');
      const detailChildName = document.getElementById('detailChildName');
      const detailNumChildren = document.getElementById('detailNumChildren');
      const childrenAgesContainer = document.getElementById('childrenAgesContainer');
      const detailFrequency = document.getElementById('detailFrequency');
      const detailSchedule = document.getElementById('detailSchedule');
      const detailSpecialNeeds = document.getElementById('detailSpecialNeeds');
      const childDetailTitle = document.getElementById('childDetailTitle');
      const notMsg = document.getElementById('notAvailableMsg');
      const availabilityCard = document.getElementById('availabilityCard');
      const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';
      
      let allChildren = [];
      let isCreatingNew = false;

      if(!userId){
        // Require login to access this page
        const showBanner = window.showBanner || function(msg, type){
          const div = document.createElement('div');
          div.id = 'globalBanner';
          const base = 'position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 12px 16px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-weight: 700; min-width: 280px; text-align: center;';
          const styles = { info: 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;' };
          div.setAttribute('style', base + (styles[type] || styles.info));
          div.textContent = msg;
          document.body.appendChild(div);
        };
        showBanner('Please sign in to request childcare.', 'info');
        setTimeout(() => window.location.href = 'account-signup.html', 1500);
      } else {
        // Load existing children
        fetch(`${API_BASE}/forms/parent/${userId}`)
          .then(res => res.json())
          .then(data => {
            allChildren = data.children || [];
            if(allChildren.length > 0){
              childSelect.innerHTML = '<option value="">-- Select a child --</option>' + 
                allChildren.map((child) => `<option value="${child.id}">${child.name || 'Unnamed Child'}</option>`).join('');
            } else {
              childSelect.innerHTML = '<option value="">No children yet</option>';
            }
          })
          .catch(err => {
            console.warn('Failed to load children:', err);
            childSelect.innerHTML = '<option value="">Unable to load children</option>';
          });

        // When child is selected from dropdown
        childSelect.addEventListener('change', function(e){
          const selectedId = parseInt(e.target.value);
          if(selectedId){
            isCreatingNew = false;
            const child = allChildren.find(c => c.id === selectedId);
            if(child){
              populateChildDetails(child, true);
            }
          } else {
            childDetailsSection.style.display = 'none';
          }
        });

        // Handle new child button
        newChildBtn.addEventListener('click', function(e){
          e.preventDefault();
          isCreatingNew = true;
          childSelect.value = '';
          childDetailsSection.style.display = 'block';
          childDetailTitle.textContent = 'New Child Information';
          detailChildName.value = '';
          detailNumChildren.value = '';
          childrenAgesContainer.innerHTML = '';
          childrenAgesContainer.style.display = 'none';
          detailFrequency.value = '';
          detailSchedule.value = '';
          detailSpecialNeeds.value = '';
          detailChildName.focus();
        });

        // Handle number of children change
        detailNumChildren.addEventListener('change', function(e){
          const numChildren = parseInt(e.target.value);
          if(numChildren > 0){
            childrenAgesContainer.style.display = 'block';
            childrenAgesContainer.innerHTML = '';
            for(let i = 1; i <= numChildren; i++){
              const div = document.createElement('div');
              div.style.marginBottom = '12px';
              div.innerHTML = `
                <label for="detailChild${i}Age" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Child ${i} age</label>
                <input id="detailChild${i}Age" type="number" min="0" max="17" placeholder="Age in years" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
              `;
              childrenAgesContainer.appendChild(div);
            }
          } else {
            childrenAgesContainer.style.display = 'none';
            childrenAgesContainer.innerHTML = '';
          }
        });
      }

      function populateChildDetails(child, isExisting){
        childDetailsSection.style.display = 'block';
        childDetailTitle.textContent = isExisting ? 'Child Information' : 'New Child Information';
        detailChildName.value = child.name || '';
        detailChildName.disabled = isExisting; // Disable name editing for existing children
        detailFrequency.value = child.frequency || '';
        detailSchedule.value = child.preferred_schedule || '';
        detailSpecialNeeds.value = child.special_needs || '';
        
        // Populate ages if they exist
        if(child.ages){
          const ages = Array.isArray(child.ages) ? child.ages : JSON.parse(child.ages || '[]');
          detailNumChildren.value = ages.length > 0 ? ages.length : '';
          if(ages.length > 0){
            childrenAgesContainer.style.display = 'block';
            childrenAgesContainer.innerHTML = '';
            ages.forEach((age, i) => {
              const div = document.createElement('div');
              div.style.marginBottom = '12px';
              div.innerHTML = `
                <label for="detailChild${i+1}Age" style="display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 13px;">Child ${i+1} age</label>
                <input id="detailChild${i+1}Age" type="number" min="0" max="17" value="${age}" placeholder="Age in years" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" ${isExisting ? 'disabled' : ''}>
              `;
              childrenAgesContainer.appendChild(div);
            });
          }
        }
      }

      if(!available){
        notMsg.style.display = 'block';
        availabilityCard.querySelector('span').textContent = 'Not Confirmed';
        availabilityCard.querySelector('span').style.background = '#fff9e6';
        availabilityCard.querySelector('span').style.color = '#8b6914';
        submitRequestBtn.addEventListener('click', function(e){
          e.preventDefault();
          window.location.href = 'find-childcare.html';
        });
      } else {
        // Handle request submission
        submitRequestBtn.addEventListener('click', async function(e){
          e.preventDefault();
          const location = localStorage.getItem('last_search_location') || '';
          const childId = childSelect.value;
          const childName = detailChildName.value.trim();
          
          if(!location){
            showBanner('Please search for childcare in your area first.', 'info');
            setTimeout(() => window.location.href = 'find-childcare.html', 1500);
            return;
          }

          if(!childId && !childName){
            showBanner('Please select a child or enter a new child\'s name.', 'error');
            return;
          }

          if(isCreatingNew && !childName){
            showBanner('Please enter your child\'s name.', 'error');
            return;
          }

          submitRequestBtn.disabled = true;
          submitRequestBtn.textContent = 'Submitting...';

          try {
            const res = await fetch(`${API_BASE}/forms/request`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                user_id: userId, 
                child_id: childId ? parseInt(childId) : null, 
                location, 
                notes: '',
                childName: childName || null
              })
            });
            
            if(!res.ok) throw new Error('Failed to submit request');
            
            showBanner('Request submitted successfully!', 'success');
            setTimeout(() => window.location.href = 'parent-dashboard.html', 1500);
          } catch (err) {
            console.error('Request submission error:', err);
            showBanner('Failed to submit request. Please try again.', 'error');
            submitRequestBtn.disabled = false;
            submitRequestBtn.textContent = 'Submit Request →';
          }
        });
      }

      // Fetch and display caregiver count from API
      const lastLocation = localStorage.getItem('last_search_location');
      const availabilityTitle = document.getElementById('availabilityTitle');
      
      if(lastLocation){
        document.getElementById('availabilitySubtitle').textContent = `Based on your recent search: ${lastLocation}`;
        
        // Fetch real count from backend
        fetch(`${API_BASE}/search?city=${encodeURIComponent(lastLocation)}`)
          .then(res => res.json())
          .then(data => {
            const count = Number(data.caregivers || 0);
            if(count > 0){
              availabilityTitle.textContent = `${count} caregiver${count === 1 ? '' : 's'} available near ${lastLocation}`;
            } else {
              availabilityTitle.textContent = 'Checking availability...';
            }
          })
          .catch(err => {
            console.warn('Failed to fetch caregiver count:', err);
            availabilityTitle.textContent = 'Caregivers are available near you';
          });
      } else {
        availabilityTitle.textContent = 'Caregivers are available near you';
      }
    </script>
  </body>
</html>
