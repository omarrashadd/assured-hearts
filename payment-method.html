06<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Add Payment Method - Assured Hearts</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body style="background:#f7f9fb;">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-links">
          <a href="parent-dashboard.html">Parent Dashboard</a>
          <a href="find-childcare.html">Find Childcare</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">Learning</a>
        </div>
      </div>
    </nav>

    <main class="container" style="max-width: 720px; padding: 36px 16px 64px 16px;">
      <section style="background:#fff; border-radius:16px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,0.08); border:1px solid #e5e7eb;">
        <h1 style="margin:0 0 8px 0; color:#06464e;">Add your payment method</h1>
        <p style="margin:0 0 16px 0; color:#4b5563;">Save a card once. We only charge if a caregiver accepts your request.</p>

        <div id="cardElement" style="padding:12px; border:1px solid #e5e7eb; border-radius:10px;"></div>
        <div id="cardError" style="margin-top:10px; color:#b91c1c; font-size:13px;"></div>

        <button id="saveCardBtn" class="btn" style="margin-top:16px; padding:12px 16px; background: linear-gradient(135deg, #67B3C2 0%, #06464E 100%); color: #fff; border:none; border-radius:10px; font-weight:700;">
          Save card
        </button>
        <div id="saveStatus" style="margin-top:10px; font-size:13px; color:#6b7280;"></div>
      </section>
    </main>

    <footer style="background:#06464E; color:white; padding:24px; text-align:center;">
      <p style="margin:0;">Â© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
      const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';
      const userId = parseInt(localStorage.getItem('user_id')) || null;
      const saveBtn = document.getElementById('saveCardBtn');
      const cardError = document.getElementById('cardError');
      const saveStatus = document.getElementById('saveStatus');
      const params = new URLSearchParams(window.location.search);
      const returnUrl = params.get('return') || 'parent-dashboard.html';

      const showBanner = window.showBanner || function(msg, type){
        const div = document.createElement('div');
        const base = 'position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 12px 16px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-weight: 700; min-width: 280px; text-align: center;';
        const styles = { 
          info: 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;',
          success: 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;',
          error: 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
        };
        div.setAttribute('style', base + (styles[type] || styles.info));
        div.textContent = msg;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      };

      if(!userId){
        showBanner('Please sign in to add a card.', 'info');
        setTimeout(() => window.location.href = 'account-signup.html', 1200);
      }

      const initStripe = async () => {
        try{
          const cfgRes = await fetch(`${API_BASE}/payments/config`);
          const cfg = await cfgRes.json();
          if(!cfg.publishableKey){
            throw new Error('Missing Stripe publishable key');
          }
          const stripe = Stripe(cfg.publishableKey);
          const elements = stripe.elements();
          const card = elements.create('card', {
            style: {
              base: { fontFamily: 'inherit', fontSize: '16px', color: '#1f2937' },
              invalid: { color: '#b91c1c' }
            }
          });
          card.mount('#cardElement');

          saveBtn.addEventListener('click', async () => {
            if(!userId) return;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            cardError.textContent = '';
            saveStatus.textContent = 'Creating setup intent...';
            try{
              const intentRes = await fetch(`${API_BASE}/payments/setup-intent`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
              });
              const intentData = await intentRes.json();
              if(!intentRes.ok) throw new Error(intentData.error || 'Failed to create setup intent');
              saveStatus.textContent = 'Saving your card...';

              const result = await stripe.confirmCardSetup(intentData.client_secret, {
                payment_method: { card }
              });
              if(result.error){
                throw result.error;
              }
              const paymentMethodId = result.setupIntent?.payment_method;
              if(!paymentMethodId){
                throw new Error('Payment method not returned by Stripe');
              }

              const attachRes = await fetch(`${API_BASE}/payments/setup-intent/attach`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, payment_method_id: paymentMethodId })
              });
              const attachData = await attachRes.json();
              if(!attachRes.ok) throw new Error(attachData.error || 'Failed to save payment method');

              saveStatus.textContent = 'Card saved. Redirecting...';
              showBanner('Card saved successfully.', 'success');
              setTimeout(() => window.location.href = returnUrl, 1200);
            }catch(err){
              cardError.textContent = err.message || 'Unable to save card.';
              saveStatus.textContent = '';
            } finally {
              saveBtn.disabled = false;
              saveBtn.textContent = 'Save card';
            }
          });
        }catch(err){
          cardError.textContent = err.message || 'Unable to load payment form.';
        }
      };

      initStripe();
    </script>
  </body>
</html>
