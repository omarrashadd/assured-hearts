<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pricing Calculator - Assured Hearts</title>
    <meta name="description" content="Adjust pricing rules and preview real-time checkout rates." />
    <link rel="stylesheet" href="style.css">
    <style>
      .pricing-hero {
        padding: 48px 16px;
        background: linear-gradient(135deg, #f4fbfd 0%, #fff7f7 100%);
        text-align: center;
      }
      .pricing-grid {
        display: grid;
        gap: 24px;
      }
      @media (min-width: 980px) {
        .pricing-grid {
          grid-template-columns: 1.15fr 0.85fr;
        }
      }
      .pricing-card {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      }
      .pricing-card h2 {
        margin: 0 0 6px 0;
        color: #06464E;
      }
      .pricing-section {
        margin-top: 18px;
        padding-top: 18px;
        border-top: 1px solid #e5e7eb;
      }
      .pricing-section:first-child {
        border-top: none;
        padding-top: 0;
        margin-top: 0;
      }
      .pricing-pill-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      }
      .pricing-pill {
        background: #f8fbfc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 13px;
        color: #374151;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .pricing-pill span {
        color: #6b7280;
        font-size: 12px;
      }
      .pricing-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .pricing-table th,
      .pricing-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #eef2f7;
        text-align: left;
      }
      .pricing-table th {
        color: #06464E;
        font-weight: 700;
        background: #f8fbfc;
      }
      .row-grid {
        display: grid;
        gap: 10px;
      }
      .row-grid.cols-3 {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
      .row-grid.cols-4 {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
      .row-grid input,
      .row-grid select {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d6dde5;
        font-size: 13px;
      }
      .tiny-btn {
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #fff;
        font-size: 12px;
        font-weight: 700;
        color: #06464E;
        cursor: pointer;
      }
      .tiny-btn.danger {
        color: #991b1b;
        border-color: #f5c6cb;
        background: #fff5f5;
      }
      .status-text {
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
      }
      .calc-box {
        background: #f8fbfc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 14px;
        display: grid;
        gap: 8px;
      }
      .calc-line {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 13px;
        color: #374151;
      }
      .calc-line strong {
        color: #06464E;
      }
      .calc-highlight {
        background: #eef7f2;
        border: 1px solid #c7e9d4;
        color: #14532d;
        font-weight: 700;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <div class="nav-auth">
          <a href="parent-dashboard.html" style="display: flex; align-items: center; gap: 6px; color: #06464E; text-decoration: none; font-weight: 600;">Dashboard</a>
        </div>
        <button id="mobileMenuBtn" class="mobile-menu" aria-label="Open menu">
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <header class="pricing-hero">
      <div class="container" style="max-width: 980px;">
        <h1 style="margin: 0 0 10px 0; color:#06464E;">Pricing Calculator</h1>
        <p class="lead" style="margin: 0; color:#4b5563;">Adjust pricing rules, preview hourly rates, and see the full fee breakdown before checkout.</p>
      </div>
    </header>

    <main class="container" style="padding: 32px 24px 48px 24px; max-width: 1100px;">
      <div class="pricing-grid">
        <section class="pricing-card">
          <h2>Pricing Settings</h2>
          <p style="margin: 0; color:#6b7280; font-size: 13px;">Base rate by age group + discounted platform fee + taxes on the base rate = customer hourly total.</p>

          <div class="pricing-section">
            <h3 style="margin: 0 0 8px 0; color:#06464E; font-size: 15px;">Base Rates by Location</h3>
            <div id="baseRatesTable"></div>
          </div>

          <div class="pricing-section">
            <h3 style="margin: 0 0 8px 0; color:#06464E; font-size: 15px;">Age Groups</h3>
            <div id="ageGroupsWrap"></div>
            <p class="status-text">IDs tie to base-rate columns. Keep them stable while adjusting ranges.</p>
          </div>

          <div class="pricing-section">
            <h3 style="margin: 0 0 8px 0; color:#06464E; font-size: 15px;">Membership Tiers (discount on platform fee)</h3>
            <div class="row-grid cols-3">
              <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
                Care+ Basic discount (%)
                <input id="discountBasicInput" type="number" step="0.1" min="0" max="100">
              </label>
              <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
                Care+ Plus discount (%)
                <input id="discountPlusInput" type="number" step="0.1" min="0" max="100">
              </label>
              <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
                Care+ Premium discount (%)
                <input id="discountPremiumInput" type="number" step="0.1" min="0" max="100">
              </label>
            </div>
            <p class="status-text">Standard members pay the full platform fee.</p>
          </div>

          <div class="pricing-section">
            <h3 style="margin: 0 0 8px 0; color:#06464E; font-size: 15px;">Fees</h3>
            <div class="row-grid cols-3">
              <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
                Platform fee (%)
                <input id="platformFeeInput" type="number" step="0.1" min="0" max="100">
              </label>
              <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
                Stripe fee (%)
                <input id="stripePercentInput" type="number" step="0.1" min="0" max="100">
              </label>
              <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
                Stripe fixed fee (cents)
                <input id="stripeFixedInput" type="number" step="1" min="0">
              </label>
            </div>
          </div>

          <div class="pricing-section">
            <h3 style="margin: 0 0 8px 0; color:#06464E; font-size: 15px;">Taxes by Province (GST/PST)</h3>
            <div class="row-grid cols-3" style="margin-bottom: 10px;">
              <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
                Tax applies to
                <select id="taxAppliesSelect">
                  <option value="base_rate">Hourly base rate</option>
                  <option value="total">Hourly base + platform fee</option>
                  <option value="platform_fee">Platform fee only</option>
                </select>
              </label>
            </div>
            <div id="taxRatesTable"></div>
          </div>

          <div class="pricing-section">
            <button id="savePricingBtn" class="btn" type="button" style="padding: 12px 16px; background: linear-gradient(135deg, #67B3C2 0%, #06464E 100%); color:#fff; border: none; border-radius: 10px; font-weight: 700;">Save Pricing Rules</button>
            <div id="configStatus" class="status-text"></div>
          </div>
        </section>

        <section class="pricing-card">
          <h2>Rate Preview</h2>
          <p style="margin: 0 0 12px 0; color:#6b7280; font-size: 13px;">Use this to preview exactly what checkout will charge.</p>

          <div class="row-grid cols-3" style="margin-bottom: 12px;">
            <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
              Province
              <select id="calcProvince"></select>
            </label>
            <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
              Child age
              <input id="calcAge" type="number" min="0" max="17" placeholder="Age">
            </label>
            <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
              Membership tier
              <select id="calcMembership">
                <option value="standard">Standard</option>
                <option value="basic">Care+ Basic</option>
                <option value="plus">Care+ Plus</option>
                <option value="premium">Care+ Premium</option>
              </select>
            </label>
          </div>
          <div class="row-grid cols-3" style="margin-bottom: 12px;">
            <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
              Start date
              <input id="calcDate" type="date">
            </label>
            <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
              Start time
              <input id="calcStart" type="time">
            </label>
            <label style="display: grid; gap: 6px; font-size: 13px; color:#374151;">
              Hours
              <input id="calcHours" type="number" min="0.5" step="0.5" value="2">
            </label>
          </div>

          <div class="calc-box" id="pricingBreakdown">
            <div class="calc-line"><span>Hourly rate</span><strong>—</strong></div>
            <div class="calc-line"><span>Provider fee (per hour)</span><strong>—</strong></div>
            <div class="calc-line"><span>Platform fee (per hour)</span><strong>—</strong></div>
            <div class="calc-line"><span>Tax (per hour)</span><strong>—</strong></div>
            <div class="calc-line"><span>Stripe fee (per booking)</span><strong>—</strong></div>
            <div class="calc-highlight">Total for booking: —</div>
          </div>
          <p id="calcStatus" class="status-text" style="margin-top: 10px;"></p>
          <p class="status-text" style="margin-top: 6px;">Curriculum is included with every booking.</p>
        </section>
      </div>
    </main>

    <footer style="background: #06464E; color: white; padding: 32px 24px; text-align: center; margin-top: 48px;">
      <p style="margin: 0;">© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
      const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';
      const PROVINCES = [
        { code: 'default', name: 'Default' },
        { code: 'AB', name: 'Alberta' },
        { code: 'BC', name: 'British Columbia' },
        { code: 'MB', name: 'Manitoba' },
        { code: 'NB', name: 'New Brunswick' },
        { code: 'NL', name: 'Newfoundland and Labrador' },
        { code: 'NS', name: 'Nova Scotia' },
        { code: 'NT', name: 'Northwest Territories' },
        { code: 'NU', name: 'Nunavut' },
        { code: 'ON', name: 'Ontario' },
        { code: 'PE', name: 'Prince Edward Island' },
        { code: 'QC', name: 'Quebec' },
        { code: 'SK', name: 'Saskatchewan' },
        { code: 'YT', name: 'Yukon' }
      ];
      const FALLBACK_AGE_GROUPS = [
        { id: 'infants-toddlers', label: 'Infants & Toddlers', min: 1, max: 3 },
        { id: 'early-childhood', label: 'Early Childhood', min: 4, max: 6 },
        { id: 'school-age', label: 'School-Age', min: 7, max: 12 }
      ];
      const FALLBACK_BASE_RATES = {
        'infants-toddlers': 2800,
        'early-childhood': 2600,
        'school-age': 2500
      };

      const baseRatesTable = document.getElementById('baseRatesTable');
      const ageGroupsWrap = document.getElementById('ageGroupsWrap');
      const taxRatesTable = document.getElementById('taxRatesTable');
      const configStatus = document.getElementById('configStatus');
      const savePricingBtn = document.getElementById('savePricingBtn');
      const discountBasicInput = document.getElementById('discountBasicInput');
      const discountPlusInput = document.getElementById('discountPlusInput');
      const discountPremiumInput = document.getElementById('discountPremiumInput');
      const platformFeeInput = document.getElementById('platformFeeInput');
      const stripePercentInput = document.getElementById('stripePercentInput');
      const stripeFixedInput = document.getElementById('stripeFixedInput');
      const taxAppliesSelect = document.getElementById('taxAppliesSelect');

      const calcProvince = document.getElementById('calcProvince');
      const calcAge = document.getElementById('calcAge');
      const calcMembership = document.getElementById('calcMembership');
      const calcDate = document.getElementById('calcDate');
      const calcStart = document.getElementById('calcStart');
      const calcHours = document.getElementById('calcHours');
      const pricingBreakdown = document.getElementById('pricingBreakdown');
      const calcStatus = document.getElementById('calcStatus');

      let pricingConfig = null;
      let calcTimer = null;

      function dollarsToCents(value) {
        const num = Number(value);
        if(!Number.isFinite(num)) return 0;
        return Math.round(num * 100);
      }

      function centsToDollars(cents) {
        const num = Number(cents);
        if(!Number.isFinite(num)) return '0.00';
        return (num / 100).toFixed(2);
      }

      function resolveAgeGroups(config) {
        const groups = Array.isArray(config?.age_groups) ? config.age_groups : [];
        if(groups.length) return groups;
        return FALLBACK_AGE_GROUPS.map(group => ({ ...group }));
      }

      function hasRateValues(entry) {
        if(Number.isFinite(Number(entry))) return true;
        if(!entry || typeof entry !== 'object') return false;
        return Object.values(entry).some(value => Number.isFinite(Number(value)));
      }

      function resolveRateCents(entry, groupId, fallbackEntry) {
        if(Number.isFinite(Number(entry))) return Math.round(Number(entry));
        const safe = entry && typeof entry === 'object' ? entry : {};
        const fallback = fallbackEntry && typeof fallbackEntry === 'object' ? fallbackEntry : {};
        const direct = safe[groupId];
        if(Number.isFinite(Number(direct))) return Math.round(Number(direct));
        const fallbackKey = safe.default ?? safe.basic ?? safe.curriculum;
        if(Number.isFinite(Number(fallbackKey))) return Math.round(Number(fallbackKey));
        const fallbackDirect = fallback[groupId] ?? fallback.default ?? fallback.basic ?? fallback.curriculum;
        if(Number.isFinite(Number(fallbackDirect))) return Math.round(Number(fallbackDirect));
        return 0;
      }

      function renderBaseRates(config) {
        const rates = config?.base_rates || {};
        const ageGroups = resolveAgeGroups(config);
        const defaultEntry = hasRateValues(rates?.default) ? rates.default : FALLBACK_BASE_RATES;
        const headerCols = ageGroups.map((group) => {
          const min = group.min ?? '';
          const max = group.max ?? '';
          const rangeLabel = min !== '' && max !== '' ? `${min}-${max}` : '';
          return `<th>${group.label || group.id} ${rangeLabel ? `<span style="color:#94a3b8; font-weight:500;">(${rangeLabel})</span>` : ''}</th>`;
        }).join('');
        const rows = PROVINCES.map((p) => {
          const entry = rates[p.code] || rates.default || defaultEntry;
          const cells = ageGroups.map((group) => {
            const value = centsToDollars(resolveRateCents(entry, group.id, defaultEntry));
            return `<td><input type="number" step="0.01" class="base-rate" data-group="${group.id}" value="${value}" style="width: 100%; padding:6px 8px; border:1px solid #d6dde5; border-radius:6px;"></td>`;
          }).join('');
          return `
            <tr data-location="${p.code}">
              <td>${p.name}</td>
              ${cells}
            </tr>
          `;
        }).join('');
        baseRatesTable.innerHTML = `
          <table class="pricing-table">
            <thead>
              <tr>
                <th>Location</th>
                ${headerCols}
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function renderAgeGroups(config) {
        if(!ageGroupsWrap) return;
        const groups = resolveAgeGroups(config);
        if(groups.length === 0){
          ageGroupsWrap.innerHTML = '<div class="status-text">No age groups configured yet.</div>';
          return;
        }
        const rows = groups.map((group) => {
          const min = group.min ?? '';
          const max = group.max ?? '';
          const label = group.label || group.id || '';
          return `
            <tr data-group-id="${group.id || ''}">
              <td>${group.id || ''}</td>
              <td><input type="text" class="age-label" value="${label}" style="width: 100%; padding:6px 8px; border:1px solid #d6dde5; border-radius:6px;"></td>
              <td><input type="number" class="age-min" min="0" step="1" value="${min}" style="width: 100%; padding:6px 8px; border:1px solid #d6dde5; border-radius:6px;"></td>
              <td><input type="number" class="age-max" min="0" step="1" value="${max}" style="width: 100%; padding:6px 8px; border:1px solid #d6dde5; border-radius:6px;"></td>
            </tr>
          `;
        }).join('');
        ageGroupsWrap.innerHTML = `
          <table class="pricing-table">
            <thead>
              <tr>
                <th>Group ID</th>
                <th>Label</th>
                <th>Min age</th>
                <th>Max age</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function renderTaxRates(config) {
        const rates = config?.tax_rates || {};
        const rows = PROVINCES.filter(p => p.code !== 'default').map((p) => {
          const entry = rates[p.code] ?? {};
          const gst = typeof entry === 'number' ? entry : (entry.gst ?? entry.gst_percent ?? 0);
          const pst = typeof entry === 'number' ? 0 : (entry.pst ?? entry.pst_percent ?? 0);
          return `
            <tr data-province="${p.code}">
              <td>${p.name}</td>
              <td><input type="number" step="0.1" min="0" max="30" class="tax-gst" value="${gst}" style="width: 100%; padding:6px 8px; border:1px solid #d6dde5; border-radius:6px;"></td>
              <td><input type="number" step="0.1" min="0" max="30" class="tax-pst" value="${pst}" style="width: 100%; padding:6px 8px; border:1px solid #d6dde5; border-radius:6px;"></td>
            </tr>
          `;
        }).join('');
        taxRatesTable.innerHTML = `
          <table class="pricing-table">
            <thead>
              <tr>
                <th>Province</th>
                <th>GST %</th>
                <th>PST %</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function populateCalculator() {
        if(calcProvince){
          calcProvince.innerHTML = PROVINCES.filter(p => p.code !== 'default').map(p => `<option value="${p.code}">${p.name}</option>`).join('');
        }
        if(calcDate && !calcDate.value){
          const today = new Date();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          calcDate.value = `${today.getFullYear()}-${month}-${day}`;
        }
        if(calcStart && !calcStart.value) calcStart.value = '09:00';
      }

      function applyConfigToUI(config) {
        renderBaseRates(config);
        renderAgeGroups(config);
        renderTaxRates(config);
        if(discountBasicInput) discountBasicInput.value = config?.membership_discounts?.basic ?? 0;
        if(discountPlusInput) discountPlusInput.value = config?.membership_discounts?.plus ?? 0;
        if(discountPremiumInput) discountPremiumInput.value = config?.membership_discounts?.premium ?? 0;
        platformFeeInput.value = config?.fees?.platform_fee_percent ?? 0;
        stripePercentInput.value = config?.fees?.stripe_percent ?? 0;
        stripeFixedInput.value = config?.fees?.stripe_fixed_cents ?? 0;
        taxAppliesSelect.value = config?.tax_applies_to || 'base_rate';
        populateCalculator();
      }

      function readConfigFromUI() {
        const baseRates = {};
        baseRatesTable.querySelectorAll('tbody tr').forEach((row) => {
          const location = row.dataset.location;
          const rateInputs = row.querySelectorAll('.base-rate');
          const values = {};
          rateInputs.forEach((input) => {
            const groupId = input.dataset.group;
            values[groupId] = dollarsToCents(input.value);
          });
          baseRates[location] = values;
        });

        const taxRates = {};
        taxRatesTable.querySelectorAll('tbody tr').forEach((row) => {
          const province = row.dataset.province;
          const gst = Number(row.querySelector('.tax-gst')?.value || 0);
          const pst = Number(row.querySelector('.tax-pst')?.value || 0);
          taxRates[province] = { gst, pst };
        });

        return {
          version: pricingConfig?.version || 2,
          currency: pricingConfig?.currency || 'cad',
          location_fallback: 'default',
          age_groups: (() => {
            const groups = [];
            ageGroupsWrap?.querySelectorAll('tbody tr').forEach((row) => {
              const id = row.dataset.groupId || row.dataset.groupID || '';
              if(!id) return;
              const label = row.querySelector('.age-label')?.value || id;
              const minRaw = row.querySelector('.age-min')?.value ?? '';
              const maxRaw = row.querySelector('.age-max')?.value ?? '';
              const minVal = minRaw === '' ? null : Number(minRaw);
              const maxVal = maxRaw === '' ? null : Number(maxRaw);
              groups.push({
                id,
                label,
                min: Number.isFinite(minVal) ? minVal : null,
                max: Number.isFinite(maxVal) ? maxVal : null
              });
            });
            return groups.length ? groups : (pricingConfig?.age_groups || []);
          })(),
          base_rates: baseRates,
          membership_discounts: {
            standard: 0,
            basic: Number(discountBasicInput?.value || 0),
            plus: Number(discountPlusInput?.value || 0),
            premium: Number(discountPremiumInput?.value || 0)
          },
          fees: {
            platform_fee_percent: Number(platformFeeInput.value || 0),
            stripe_percent: Number(stripePercentInput.value || 0),
            stripe_fixed_cents: Number(stripeFixedInput.value || 0)
          },
          tax_rates: taxRates,
          tax_applies_to: taxAppliesSelect.value || 'base_rate'
        };
      }

      function buildEndDate(dateVal, startVal, hoursVal) {
        if(!dateVal || !startVal || !hoursVal) return null;
        const [year, month, day] = dateVal.split('-').map(Number);
        const [hour, minute] = startVal.split(':').map(Number);
        const durationHours = Number(hoursVal);
        if(!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;
        if(!Number.isFinite(hour) || !Number.isFinite(minute)) return null;
        if(!Number.isFinite(durationHours)) return null;
        const startDate = new Date(year, month - 1, day, hour, minute);
        return new Date(startDate.getTime() + Math.round(durationHours * 60) * 60000);
      }

      function getCalculatorFactors() {
        const dateVal = calcDate?.value || '';
        const startVal = calcStart?.value || '';
        const hoursVal = Number(calcHours?.value || 1);
        const ageRaw = calcAge?.value || '';
        const ageVal = ageRaw === '' ? null : Number(ageRaw);
        const membershipTier = calcMembership?.value || 'standard';
        const endDate = buildEndDate(dateVal, startVal, hoursVal);
        const endAt = endDate
          ? `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2,'0')}-${String(endDate.getDate()).padStart(2,'0')}T${String(endDate.getHours()).padStart(2,'0')}:${String(endDate.getMinutes()).padStart(2,'0')}`
          : null;
        return {
          province: calcProvince?.value || '',
          age: ageVal,
          membership_tier: membershipTier,
          subscription_type: membershipTier,
          start_at: dateVal && startVal ? `${dateVal}T${startVal}` : null,
          end_at: endAt,
          hours: hoursVal
        };
      }

      async function updateCalculator() {
        if(!pricingConfig) return;
        const config = readConfigFromUI();
        const factors = getCalculatorFactors();
        try{
          const res = await fetch(`${API_BASE}/pricing/calculate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...factors, config })
          });
          const data = await res.json();
          if(!res.ok) throw new Error(data.error || 'Failed to calculate');
          const pricing = data.pricing;
          const hourlyTotal = pricing.total_hourly_cents;
          const providerFee = pricing.provider_fee_cents;
          const platformFee = pricing.platform_fee_cents;
          const taxCents = pricing.tax_cents;
          const stripeFee = pricing.stripe_fee_cents;
          const totalBooking = pricing.total_booking_cents;
          const tierLabel = pricing.membership_tier ? pricing.membership_tier.replace(/_/g, ' ') : 'standard';
          const ageLabel = pricing.age_group_label ? ` · ${pricing.age_group_label}` : '';
          pricingBreakdown.innerHTML = `
            <div class="calc-line"><span>Hourly rate</span><strong>$${centsToDollars(hourlyTotal)}</strong></div>
            <div class="calc-line"><span>Provider fee (per hour)</span><strong>$${centsToDollars(providerFee)}</strong></div>
            <div class="calc-line"><span>Platform fee (per hour)</span><strong>$${centsToDollars(platformFee)}</strong></div>
            <div class="calc-line"><span>Tax (per hour)</span><strong>$${centsToDollars(taxCents)}</strong></div>
            <div class="calc-line"><span>Stripe fee (per booking)</span><strong>$${centsToDollars(stripeFee)}</strong></div>
            <div class="calc-highlight">Total for booking: $${centsToDollars(totalBooking)}</div>
          `;
          calcStatus.textContent = `Using ${factors.hours} hour(s) in ${factors.province || 'your province'} · ${tierLabel}${ageLabel}.`;
        }catch(err){
          calcStatus.textContent = err.message || 'Unable to calculate pricing.';
        }
      }

      function scheduleCalc() {
        clearTimeout(calcTimer);
        calcTimer = setTimeout(updateCalculator, 200);
      }

      async function loadConfig() {
        try{
          const res = await fetch(`${API_BASE}/pricing/config`);
          const data = await res.json();
          pricingConfig = data.config || {};
          applyConfigToUI(pricingConfig);
          updateCalculator();
        }catch(err){
          configStatus.textContent = 'Failed to load pricing config.';
        }
      }

      savePricingBtn.addEventListener('click', async () => {
        const config = readConfigFromUI();
        configStatus.textContent = 'Saving...';
        try{
          const res = await fetch(`${API_BASE}/pricing/config`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ config })
          });
          const data = await res.json();
          if(!res.ok) throw new Error(data.error || 'Save failed');
          pricingConfig = data.config || config;
          configStatus.textContent = 'Pricing rules saved.';
          updateCalculator();
        }catch(err){
          configStatus.textContent = err.message || 'Unable to save pricing rules.';
        }
      });

      document.addEventListener('input', (event) => {
        if(event.target && event.target.matches('input, select, textarea')) {
          scheduleCalc();
        }
      });
      document.addEventListener('change', (event) => {
        if(event.target && event.target.matches('input, select, textarea')) {
          scheduleCalc();
        }
      });

      loadConfig();
    </script>
  </body>
</html>
