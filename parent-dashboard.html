<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Parent Dashboard - Assured Hearts</title>
    <meta name="description" content="Manage your family profile, bookings, and caregivers." />
    <link rel="stylesheet" href="style.css">
  </head>

  <body class="provider-dashboard parent-dashboard">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <button id="mobileMenuBtn" class="mobile-menu" aria-label="Open menu">
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <div id="mobileMenu" class="mobile-menu-panel hidden" aria-hidden="true">
      <button id="mobileMenuClose" class="mobile-menu-close" aria-label="Close menu">&times;</button>
      <nav class="mobile-nav">
        <a href="find-childcare.html">Find Childcare</a>
        <a href="become-provider.html">Join Our Care Network</a>
        <a href="care-process.html">Our Care Process</a>
        <a href="learning.html">At-Home Learning</a>
        <a href="parent-dashboard.html">Dashboard</a>
      </nav>
    </div>

    <main class="provider-shell">
      <aside class="provider-sidebar">
        <div class="provider-sidebar-header">
          <span class="provider-sidebar-eyebrow">Family Portal</span>
          <div class="provider-sidebar-title">Assured Hearts</div>
          <div id="parentSidebarName" class="provider-sidebar-name">Signed in</div>
        </div>

        <nav class="provider-nav" role="tablist" aria-label="Parent dashboard sections">
          <button id="tab-dashboard" class="provider-nav-item is-active" type="button" role="tab" aria-selected="true" aria-controls="panel-dashboard" data-panel="dashboard">Dashboard</button>
          <button id="tab-calendar" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-calendar" data-panel="calendar">Calendar</button>
          <button id="tab-inbox" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-inbox" data-panel="inbox">Inbox</button>
          <button id="tab-children" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-children" data-panel="children">My Children</button>
          <button id="tab-caregivers" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-caregivers" data-panel="caregivers">My Caregivers</button>
          <button id="tab-curriculum" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-curriculum" data-panel="curriculum">My Curriculum</button>
        </nav>

        <div class="provider-sidebar-footer">
          <div class="provider-upgrade-card">
            <div class="provider-upgrade-title">Upgrade to Care+ Family Access</div>
            <p class="provider-upgrade-copy">Unlock curriculum tools, priority matching, and family savings.</p>
            <a class="provider-upgrade-btn" href="shop.html">Upgrade</a>
          </div>
          <button id="parentLogout" class="provider-logout" type="button">Log out</button>
        </div>
      </aside>

      <section class="provider-content">
        <header class="provider-content-header">
          <div>
            <p class="provider-eyebrow">Dashboard</p>
            <h1 class="provider-title">Welcome back<span id="parentWelcomeName"></span></h1>
            <p class="provider-subtitle">Track bookings, manage your family, and message caregivers.</p>
          </div>
          <div class="provider-header-actions">
            <button id="openParentProfileBtn" class="provider-header-btn" type="button">My Profile</button>
          </div>
        </header>

        <div class="provider-panels">
          <section id="panel-dashboard" class="provider-panel is-active" role="tabpanel" aria-labelledby="tab-dashboard">
            <section class="provider-bookings-card parent-find-card">
              <div class="provider-card-head">
                <div>
                  <h2>Find a caregiver</h2>
                  <p class="provider-card-sub">Check availability in your city and explore trusted caregivers.</p>
                </div>
              </div>
              <div class="parent-find-form-wrap">
                <form id="heroFindForm" class="parent-find-form">
                  <div class="parent-find-inputs">
                    <button type="button" id="heroFindLocationBtn" class="parent-find-location-btn" title="Use current location">
                      <img src="Assets/findmylocation.png" alt="Use current location">
                    </button>
                    <select name="location" id="heroLocationInput" class="parent-find-select">
                      <option value="">Enter your location</option>
                      <option value="St. John's">St. John's, NL</option>
                      <option value="Halifax">Halifax, NS</option>
                      <option value="Saint John">Saint John, NB</option>
                      <option value="Charlottetown">Charlottetown, PE</option>
                      <option value="Quebec City">Quebec City, QC</option>
                      <option value="Montreal">Montreal, QC</option>
                      <option value="Toronto">Toronto, ON</option>
                      <option value="Ottawa">Ottawa, ON</option>
                      <option value="Hamilton">Hamilton, ON</option>
                      <option value="London">London, ON</option>
                      <option value="Winnipeg">Winnipeg, MB</option>
                      <option value="Calgary">Calgary, AB</option>
                      <option value="Edmonton">Edmonton, AB</option>
                      <option value="Red Deer">Red Deer, AB</option>
                      <option value="Lethbridge">Lethbridge, AB</option>
                      <option value="Regina">Regina, SK</option>
                      <option value="Saskatoon">Saskatoon, SK</option>
                      <option value="Prince Albert">Prince Albert, SK</option>
                      <option value="Moose Jaw">Moose Jaw, SK</option>
                      <option value="Yorkton">Yorkton, SK</option>
                      <option value="Swift Current">Swift Current, SK</option>
                      <option value="Vancouver">Vancouver, BC</option>
                      <option value="Victoria">Victoria, BC</option>
                      <option value="Surrey">Surrey, BC</option>
                      <option value="Burnaby">Burnaby, BC</option>
                      <option value="Kelowna">Kelowna, BC</option>
                      <option value="Whitehorse">Whitehorse, YT</option>
                      <option value="Yellowknife">Yellowknife, NT</option>
                      <option value="Iqaluit">Iqaluit, NU</option>
                    </select>
                    <button type="submit" class="parent-find-submit" aria-label="Search caregivers">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 8h14M8 1l7 7-7 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </form>
                <p class="parent-find-meta">Check availability before you request care.</p>
                <a class="parent-find-link" href="find-childcare.html">Browse caregivers near me</a>
              </div>
            </section>

            <div class="provider-dashboard-grid">
              <section class="provider-bookings-card parent-bookings-card">
                <div class="provider-card-head">
                  <div>
                    <h2>Upcoming bookings</h2>
                    <p class="provider-card-sub">Confirmed sessions with your caregivers.</p>
                  </div>
                  <span id="parentBookingsPill" class="provider-card-pill">0 upcoming</span>
                </div>
                <div class="parent-bookings-table">
                  <div class="parent-bookings-row parent-bookings-head">
                    <div class="parent-booking-cell">Caregiver</div>
                    <div class="parent-booking-cell">Caregiver contact</div>
                    <div class="parent-booking-cell">Hours booked</div>
                    <div class="parent-booking-cell">Care type</div>
                    <div class="parent-booking-cell">Time scheduled</div>
                    <div class="parent-booking-cell parent-booking-action">Action</div>
                  </div>
                  <div id="parentBookingsList" class="parent-bookings-body">
                    <div class="provider-bookings-empty">No upcoming bookings yet.</div>
                  </div>
                </div>
              </section>
            </div>
          </section>

          <section id="panel-calendar" class="provider-panel" role="tabpanel" aria-labelledby="tab-calendar" hidden>
            <div class="provider-panel-card">
              <h2>Calendar</h2>
              <p>Upcoming and recurring bookings.</p>
              <div id="parentCalendarList" class="parent-calendar-list">
                <div class="provider-bookings-empty">No upcoming bookings yet.</div>
              </div>
            </div>
          </section>

          <section id="panel-inbox" class="provider-panel" role="tabpanel" aria-labelledby="tab-inbox" hidden>
            <div class="provider-panel-card">
              <div class="provider-card-head">
                <div>
                  <h2>Inbox</h2>
                  <p class="provider-card-sub">Stay in touch with caregivers and support.</p>
                </div>
                <span id="parentMessagesUnread" class="provider-card-pill" style="display:none;">0 unread</span>
              </div>
              <div id="parentMessagesList" class="parent-messages-list">
                <div class="provider-bookings-empty">No messages yet.</div>
              </div>
              <button id="parentMessagesOpenBtn" class="provider-header-btn" type="button">Open messages</button>
            </div>
          </section>

          <section id="panel-children" class="provider-panel" role="tabpanel" aria-labelledby="tab-children" hidden>
            <div class="provider-panel-card">
              <div class="provider-card-head">
                <div>
                  <h2>My children</h2>
                  <p class="provider-card-sub">Manage child profiles and booking preferences.</p>
                </div>
                <div class="parent-action-row">
                  <a class="provider-header-btn" href="child-demographics.html">Add child</a>
                </div>
              </div>
              <div id="parentChildrenList" class="parent-children-grid">
                <div class="provider-bookings-empty">No children added yet.</div>
              </div>
            </div>
          </section>

          <section id="panel-caregivers" class="provider-panel" role="tabpanel" aria-labelledby="tab-caregivers" hidden>
            <div class="provider-panel-card">
              <div class="provider-card-head">
                <div>
                  <h2>My caregivers</h2>
                  <p class="provider-card-sub">Caregivers you have booked before.</p>
                </div>
              </div>
              <div id="parentCaregiversList" class="parent-caregivers-grid">
                <div class="provider-bookings-empty">No caregivers yet.</div>
              </div>
            </div>
          </section>

          <section id="panel-curriculum" class="provider-panel" role="tabpanel" aria-labelledby="tab-curriculum" hidden>
            <div class="provider-panel-card">
              <h2>My curriculum</h2>
              <p>Access curriculum tools, activities, and learning guides here.</p>
            </div>
          </section>

          <section id="panel-profile" class="provider-panel" role="tabpanel" aria-labelledby="tab-dashboard" hidden>
            <div class="provider-panel-card provider-profile-card">
              <div class="provider-card-head provider-profile-head">
                <div>
                  <h2>My profile</h2>
                  <p class="provider-card-sub">Update your family contact details and preferences.</p>
                </div>
                <button id="parentProfileBackBtn" class="provider-header-btn provider-header-btn-ghost" type="button">Back to Dashboard</button>
              </div>
              <form id="parentProfileForm" class="provider-profile-form">
                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Full name</span>
                    <input type="text" id="parentName" name="name" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Email (login)</span>
                    <input type="email" id="parentEmail" name="email" class="provider-input" readonly>
                  </label>
                  <label class="provider-form-field">
                    <span>Phone</span>
                    <input type="tel" id="parentPhone" name="phone" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Subscription</span>
                    <input type="text" id="parentSubscription" name="subscription_type" class="provider-input" readonly>
                  </label>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Address line 1</span>
                    <input type="text" id="parentAddress1" name="address_line1" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Address line 2</span>
                    <input type="text" id="parentAddress2" name="address_line2" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>City</span>
                    <input type="text" id="parentCity" name="city" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Province/State</span>
                    <input type="text" id="parentProvince" name="province" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Postal/ZIP</span>
                    <input type="text" id="parentPostal" name="postal_code" class="provider-input">
                  </label>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Emergency contact name</span>
                    <input type="text" id="parentEmergencyName" name="emergency_contact_name" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Emergency contact phone</span>
                    <input type="tel" id="parentEmergencyPhone" name="emergency_contact_phone" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Spouse contact name</span>
                    <input type="text" id="parentSpouseName" name="spouse_name" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Spouse contact phone</span>
                    <input type="tel" id="parentSpousePhone" name="spouse_phone" class="provider-input">
                  </label>
                </div>

                <div class="provider-form-actions">
                  <button class="provider-header-btn" type="submit">Save changes</button>
                  <span id="parentProfileStatus" class="provider-form-status"></span>
                </div>
              </form>
            </div>
          </section>
        </div>
      </section>
    </main>

    <footer style="background:#06464E; color:white; padding:32px 24px; text-align:center; margin-top:48px;">
      <p style="margin:0;">© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
      const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';
      const userId = parseInt(localStorage.getItem('user_id'), 10) || null;

      const showNotice = (message, type) => {
        if(typeof window.showBanner === 'function') {
          window.showBanner(message, type || 'info');
        } else {
          alert(message);
        }
      };

      const activateParentPanel = (panelId) => {
        const navItems = Array.from(document.querySelectorAll('.provider-nav-item'));
        const panels = Array.from(document.querySelectorAll('.provider-panel'));
        const navTarget = panelId === 'profile' ? 'dashboard' : panelId;
        navItems.forEach((btn) => {
          const isActive = btn.dataset.panel === navTarget;
          btn.classList.toggle('is-active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        panels.forEach((panel) => {
          const isActive = panel.id === `panel-${panelId}`;
          panel.classList.toggle('is-active', isActive);
          panel.hidden = !isActive;
        });
      };

      document.querySelectorAll('.provider-nav-item').forEach((btn) => {
        btn.addEventListener('click', () => {
          if(btn.dataset.panel) activateParentPanel(btn.dataset.panel);
        });
        btn.addEventListener('keydown', (event) => {
          if(event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            btn.click();
          }
        });
      });

      const initialPanel = window.location.hash.replace('#', '');
      activateParentPanel(initialPanel || 'dashboard');

      document.getElementById('openParentProfileBtn')?.addEventListener('click', () => {
        window.location.hash = 'profile';
        activateParentPanel('profile');
      });
      document.getElementById('parentProfileBackBtn')?.addEventListener('click', () => {
        window.location.hash = 'dashboard';
        activateParentPanel('dashboard');
      });

      const logoutHandler = () => {
        if(confirm('Are you sure you want to log out?')) {
          localStorage.removeItem('user_id');
          localStorage.removeItem('user_type');
          window.location.href = 'index.html';
        }
      };
      document.getElementById('parentLogout')?.addEventListener('click', logoutHandler);

      const toDate = (value) => {
        if(!value) return null;
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? null : date;
      };

      const minutesFromTime = (timeStr) => {
        if(!timeStr) return null;
        const parts = timeStr.split(':').map(Number);
        if(parts.length < 2 || parts.some((p) => Number.isNaN(p))) return null;
        return (parts[0] * 60) + parts[1];
      };

      const durationHours = (entry) => {
        if(entry.start_time && entry.end_time) {
          const start = minutesFromTime(entry.start_time);
          const end = minutesFromTime(entry.end_time);
          if(start === null || end === null) return 0;
          return Math.max(0, (end - start) / 60);
        }
        if(entry.start_at && entry.end_at) {
          const start = new Date(entry.start_at);
          const end = new Date(entry.end_at);
          if(Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return 0;
          return Math.max(0, (end - start) / (1000 * 60 * 60));
        }
        return 0;
      };

      const formatDateLabel = (date) => date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });

      const formatTimeLabel = (timeStr) => {
        if(!timeStr) return '';
        const parts = timeStr.split(':').map(Number);
        if(parts.length < 2 || parts.some((p) => Number.isNaN(p))) return timeStr;
        const base = new Date();
        base.setHours(parts[0], parts[1], 0, 0);
        return base.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' });
      };

      const formatScheduleLabel = (entry) => {
        if(entry.start_at && entry.end_at) {
          const start = toDate(entry.start_at);
          const end = toDate(entry.end_at);
          if(!start || !end) return 'TBD';
          return `${formatDateLabel(start)} ${start.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })} - ${end.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })}`;
        }
        if(entry.session_date) {
          const date = toDate(entry.session_date);
          if(!date) return 'TBD';
          if(entry.start_time && entry.end_time) {
            return `${formatDateLabel(date)} ${formatTimeLabel(entry.start_time)} - ${formatTimeLabel(entry.end_time)}`;
          }
          return formatDateLabel(date);
        }
        return 'TBD';
      };

      const formatCareType = (value) => {
        const raw = String(value || '').toLowerCase();
        if(raw.includes('curriculum')) return 'Curriculum';
        if(raw.includes('mixed')) return 'Mixed';
        if(raw.includes('standard')) return 'Standard';
        return 'Standard';
      };

      const renderUpcomingBookings = (sessions) => {
        const listEl = document.getElementById('parentBookingsList');
        const countEl = document.getElementById('parentBookingsPill');
        const kpiCount = document.getElementById('parentUpcomingCount');
        if(!listEl) return;
        const now = new Date();
        const upcoming = (sessions || []).filter((entry) => {
          const status = String(entry.status || '').toLowerCase();
          if(status.includes('cancel')) return false;
          const start = entry.start_at ? new Date(entry.start_at) : null;
          if(start) return start >= now;
          if(entry.session_date) {
            const date = toDate(entry.session_date);
            return date ? date >= new Date(now.toDateString()) : false;
          }
          return false;
        });
        if(countEl) countEl.textContent = `${upcoming.length} upcoming`;
        if(kpiCount) kpiCount.textContent = String(upcoming.length);
        if(upcoming.length === 0) {
          listEl.innerHTML = '<div class="provider-bookings-empty">No upcoming bookings yet.</div>';
          return;
        }
        listEl.innerHTML = upcoming.slice(0, 6).map((entry) => {
          const contactBits = [entry.provider_email, entry.provider_phone].filter(Boolean).join(' · ');
          const hours = durationHours(entry);
          const hoursLabel = hours ? `${hours.toFixed(1).replace(/\.0$/, '')} hrs` : 'TBD';
          const careType = formatCareType(entry.care_type);
          const providerName = entry.provider_name || 'Caregiver';
          const schedule = formatScheduleLabel(entry);
          const contactLabel = contactBits || 'Contact not available';
          const providerId = entry.provider_id || entry.provider_user_id || '';
          return `
            <div class="parent-bookings-row parent-bookings-item">
              <div class="parent-booking-cell" data-label="Caregiver">${providerName}</div>
              <div class="parent-booking-cell" data-label="Caregiver contact">
                <span class="parent-booking-contact">${contactLabel}</span>
              </div>
              <div class="parent-booking-cell" data-label="Hours booked">${hoursLabel}</div>
              <div class="parent-booking-cell" data-label="Care type">${careType}</div>
              <div class="parent-booking-cell" data-label="Time scheduled">${schedule}</div>
              <div class="parent-booking-cell parent-booking-action" data-label="Action">
                <button class="parent-booking-btn" data-id="${providerId}" data-name="${providerName}">Message</button>
              </div>
            </div>
          `;
        }).join('');

        listEl.querySelectorAll('.parent-booking-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const otherId = parseInt(btn.getAttribute('data-id'), 10);
            const otherName = btn.getAttribute('data-name') || 'Caregiver';
            if(otherId && window.showChatWidget) {
              window.showChatWidget(otherId, otherName);
            } else if(otherId && window.openChatThread) {
              window.openChatThread(otherId, otherName);
            }
          });
        });
      };

      const renderCalendar = (sessions) => {
        const listEl = document.getElementById('parentCalendarList');
        if(!listEl) return;
        if(!sessions || sessions.length === 0) {
          listEl.innerHTML = '<div class="provider-bookings-empty">No upcoming bookings yet.</div>';
          return;
        }
        const upcoming = sessions.slice().sort((a, b) => {
          const aDate = toDate(a.start_at || a.session_date);
          const bDate = toDate(b.start_at || b.session_date);
          return (aDate?.getTime() || 0) - (bDate?.getTime() || 0);
        });
        listEl.innerHTML = upcoming.slice(0, 8).map((entry) => {
          const providerName = entry.provider_name || 'Caregiver';
          const schedule = formatScheduleLabel(entry);
          return `
            <div class="parent-calendar-item">
              <div>
                <div class="parent-calendar-title">${providerName}</div>
                <div class="parent-calendar-sub">${schedule}</div>
              </div>
              <span class="parent-calendar-pill">${formatCareType(entry.care_type)}</span>
            </div>
          `;
        }).join('');
      };

      const renderChildren = (children) => {
        const listEl = document.getElementById('parentChildrenList');
        if(!listEl) return;
        if(!children || children.length === 0) {
          listEl.innerHTML = '<div class="provider-bookings-empty">No children added yet.</div>';
          return;
        }
        listEl.innerHTML = children.map((child) => {
          const name = [child.first_name, child.last_name].filter(Boolean).join(' ') || 'Child';
          const initials = name.split(' ').map((n) => n[0]).join('').slice(0, 2).toUpperCase();
          const ageLabel = child.age ? `${child.age} yrs` : 'Age not set';
          return `
            <div class="parent-child-card">
              <div class="parent-child-avatar">${initials}</div>
              <div class="parent-child-info">
                <div class="parent-child-name">${name}</div>
                <div class="parent-child-meta">${ageLabel}</div>
              </div>
              <div class="parent-child-actions">
                <button class="parent-child-btn parent-child-edit" data-id="${child.id}">Edit</button>
                <a class="parent-child-btn" href="request-childcare.html?child_id=${encodeURIComponent(child.id)}">Book with ${name.split(' ')[0] || 'child'}</a>
              </div>
            </div>
          `;
        }).join('');

        listEl.querySelectorAll('.parent-child-edit').forEach((btn) => {
          btn.addEventListener('click', () => {
            const childId = btn.getAttribute('data-id');
            if(childId) {
              localStorage.setItem('child_to_edit', childId);
              window.location.href = 'child-demographics.html';
            }
          });
        });
      };

      const renderCaregivers = (sessions) => {
        const listEl = document.getElementById('parentCaregiversList');
        if(!listEl) return;
        const caregivers = new Map();
        (sessions || []).forEach((entry) => {
          const id = entry.provider_id || entry.provider_user_id;
          if(!id) return;
          caregivers.set(id, {
            id,
            name: entry.provider_name || 'Caregiver',
            email: entry.provider_email || '',
            phone: entry.provider_phone || '',
            city: entry.provider_city || '',
            province: entry.provider_province || ''
          });
        });
        const items = Array.from(caregivers.values());
        const countEl = document.getElementById('parentCaregiverCount');
        if(countEl) countEl.textContent = String(items.length);
        if(items.length === 0) {
          listEl.innerHTML = '<div class="provider-bookings-empty">No caregivers yet.</div>';
          return;
        }
        listEl.innerHTML = items.map((c) => {
          const initials = c.name.split(' ').map((n) => n[0]).join('').slice(0, 2).toUpperCase();
          const location = [c.city, c.province].filter(Boolean).join(', ');
          const contact = [c.email, c.phone].filter(Boolean).join(' · ') || 'Contact not available';
          return `
            <div class="parent-caregiver-card">
              <div class="parent-caregiver-avatar">${initials}</div>
              <div class="parent-caregiver-info">
                <div class="parent-caregiver-name">${c.name}</div>
                <div class="parent-caregiver-meta">${location || 'Location not set'}</div>
                <div class="parent-caregiver-contact">${contact}</div>
              </div>
              <button class="parent-caregiver-btn" data-id="${c.id}" data-name="${c.name}">Message</button>
            </div>
          `;
        }).join('');

        listEl.querySelectorAll('.parent-caregiver-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const otherId = parseInt(btn.getAttribute('data-id'), 10);
            const otherName = btn.getAttribute('data-name') || 'Caregiver';
            if(otherId && window.showChatWidget) {
              window.showChatWidget(otherId, otherName);
            } else if(otherId && window.openChatThread) {
              window.openChatThread(otherId, otherName);
            }
          });
        });
      };

      const fillProfileForm = (profile) => {
        document.getElementById('parentSidebarName').textContent = profile?.name ? `Signed in as ${profile.name}` : 'Signed in';
        const firstName = profile?.name ? profile.name.split(' ')[0] : '';
        document.getElementById('parentWelcomeName').textContent = firstName ? `, ${firstName}` : '';
        if(profile?.name) localStorage.setItem('user_name', profile.name);
        const setVal = (id, value) => {
          const el = document.getElementById(id);
          if(el) el.value = value || '';
        };
        setVal('parentName', profile?.name);
        setVal('parentEmail', profile?.email);
        setVal('parentPhone', profile?.phone);
        setVal('parentAddress1', profile?.address_line1);
        setVal('parentAddress2', profile?.address_line2);
        setVal('parentCity', profile?.city);
        setVal('parentProvince', profile?.province);
        setVal('parentPostal', profile?.postal_code);
        setVal('parentEmergencyName', profile?.emergency_contact_name);
        setVal('parentEmergencyPhone', profile?.emergency_contact_phone);
        setVal('parentSpouseName', profile?.spouse_name);
        setVal('parentSpousePhone', profile?.spouse_phone);
        const subscription = profile?.subscription_type || (profile?.is_premium ? 'Care+ Premium' : 'Standard');
        setVal('parentSubscription', subscription);
      };

      const hookProfileSave = () => {
        const form = document.getElementById('parentProfileForm');
        const statusEl = document.getElementById('parentProfileStatus');
        if(!form) return;
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if(!userId) {
            showNotice('Please log in to update your profile.', 'info');
            return;
          }
          const payload = {
            name: document.getElementById('parentName')?.value?.trim() || null,
            phone: document.getElementById('parentPhone')?.value?.trim() || null,
            city: document.getElementById('parentCity')?.value?.trim() || null,
            province: document.getElementById('parentProvince')?.value?.trim() || null,
            address_line1: document.getElementById('parentAddress1')?.value?.trim() || null,
            address_line2: document.getElementById('parentAddress2')?.value?.trim() || null,
            postal_code: document.getElementById('parentPostal')?.value?.trim() || null,
            emergency_contact_name: document.getElementById('parentEmergencyName')?.value?.trim() || null,
            emergency_contact_phone: document.getElementById('parentEmergencyPhone')?.value?.trim() || null,
            spouse_name: document.getElementById('parentSpouseName')?.value?.trim() || null,
            spouse_phone: document.getElementById('parentSpousePhone')?.value?.trim() || null
          };
          if(statusEl) {
            statusEl.textContent = 'Saving...';
            statusEl.style.color = '#9ca3af';
          }
          try {
            const res = await fetch(`${API_BASE}/forms/parent/${userId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error || 'Save failed');
            fillProfileForm(data.profile || payload);
            if(statusEl) {
              statusEl.textContent = 'Saved';
              statusEl.style.color = '#34d399';
            }
            showNotice('Profile saved.', 'success');
          } catch (err) {
            if(statusEl) {
              statusEl.textContent = 'Save failed. Try again.';
              statusEl.style.color = '#f87171';
            }
            showNotice('Could not save profile. Please try again.', 'error');
          }
        });
      };

      const hookInboxPreview = () => {
        const listEl = document.getElementById('parentMessagesList');
        const unreadEl = document.getElementById('parentMessagesUnread');
        const openBtn = document.getElementById('parentMessagesOpenBtn');
        const apply = () => {
          const threads = window.latestThreads || {};
          const unread = window.latestUnread || 0;
          if(unreadEl){
            unreadEl.style.display = unread > 0 ? 'inline-flex' : 'none';
            unreadEl.textContent = `${unread} unread`;
          }
          if(listEl){
            const arr = Object.values(threads);
            if(arr.length === 0){
              listEl.innerHTML = '<div class="provider-bookings-empty">No messages yet.</div>';
            } else {
              const lastTwo = arr.slice(-2);
              listEl.innerHTML = lastTwo.map(t=>{
                const last = t.messages[t.messages.length-1];
                return `
                  <div class="parent-message-item">
                    <div class="parent-message-name">${t.other_name || 'User'}</div>
                    <div class="parent-message-body">${last ? last.body : ''}</div>
                  </div>
                `;
              }).join('');
            }
          }
        };
        apply();
        window.addEventListener('chat-updated', apply);
        if(openBtn){
          openBtn.addEventListener('click', ()=>{
            if(window.showChatWidget) window.showChatWidget();
          });
        }
      };

      const loadParentDashboard = async () => {
        if(!userId){
          showNotice('Please log in to view your dashboard.', 'info');
          setTimeout(() => window.location.href = 'account-signup.html', 1200);
          return;
        }
        try {
          const res = await fetch(`${API_BASE}/forms/parent/${userId}`);
          if(!res.ok) throw new Error('Failed to load dashboard');
          const data = await res.json();
          const profile = data.profile || {};
          const children = Array.isArray(data.children) ? data.children : [];
          const sessions = Array.isArray(data.sessions) ? data.sessions : [];
          fillProfileForm(profile);
          renderUpcomingBookings(sessions);
          renderCalendar(sessions);
          renderChildren(children);
          renderCaregivers(sessions);
        } catch (err) {
          console.error('Parent dashboard load failed', err);
          showNotice('Unable to load dashboard data.', 'error');
        }
      };

      window.addEventListener('DOMContentLoaded', () => {
        hookProfileSave();
        hookInboxPreview();
        loadParentDashboard();
      });
    </script>
  </body>
</html>
