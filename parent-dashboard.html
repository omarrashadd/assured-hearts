<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Parent Dashboard - Assured Hearts</title>
    <meta name="description" content="Manage your family profile, bookings, and caregivers." />
    <link rel="stylesheet" href="style.css">
  </head>

  <body class="provider-dashboard parent-dashboard">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-center-title" aria-hidden="true">Assured Hearts</div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <button id="topProfileBtn" class="provider-top-profile-btn provider-nav-item provider-nav-icon-btn" type="button" data-panel="profile" aria-label="My profile">
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-3.314 0-8 1.664-8 5v3h16v-3c0-3.336-4.686-5-8-5z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </nav>

    <div id="mobileMenu" class="mobile-menu-panel hidden" aria-hidden="true">
      <button id="mobileMenuClose" class="mobile-menu-close" aria-label="Close menu">&times;</button>
      <nav class="mobile-nav">
        <a href="find-childcare.html">Find Childcare</a>
        <a href="become-provider.html">Join Our Care Network</a>
        <a href="care-process.html">Our Care Process</a>
        <a href="learning.html">At-Home Learning</a>
        <a href="parent-dashboard.html">Dashboard</a>
      </nav>
    </div>

    <main class="provider-shell">
      <aside class="provider-sidebar">
        <div class="provider-sidebar-header">
          <span class="provider-sidebar-eyebrow">Family Portal</span>
          <div class="provider-sidebar-title">Assured Hearts</div>
          <div id="parentSidebarName" class="provider-sidebar-name">Signed in</div>
        </div>

        <nav class="provider-nav" role="tablist" aria-label="Parent dashboard sections">
          <button id="tab-dashboard" class="provider-nav-item is-active" type="button" role="tab" aria-selected="true" aria-controls="panel-dashboard" data-panel="dashboard" aria-label="Home">
            <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M3 11.2 12 4l9 7.2V20a1 1 0 0 1-1 1h-5.5v-6.5h-5V21H4a1 1 0 0 1-1-1z" fill="currentColor"/>
            </svg>
            <span class="nav-label">Home</span>
          </button>
          <button id="tab-calendar" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-calendar" data-panel="calendar" aria-label="Calendar">
            <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v13a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V6a2 2 0 0 1 2-2h1V3a1 1 0 0 1 1-1zm12 8H5v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1z" fill="currentColor"/>
            </svg>
            <span class="nav-label">Calendar</span>
          </button>
          <button id="tab-inbox" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-inbox" data-panel="inbox" aria-label="Messages">
            <svg class="nav-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M4 4h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H9l-5 5v-5H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z" fill="currentColor"/>
            </svg>
            <span class="nav-label">Messages</span>
            <span class="provider-nav-badge" aria-live="polite"></span>
          </button>
          <button id="tab-children" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-children" data-panel="children">My Children</button>
          <button id="tab-caregivers" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-caregivers" data-panel="caregivers">My Caregivers</button>
          <button id="tab-curriculum" class="provider-nav-item" type="button" role="tab" aria-selected="false" aria-controls="panel-curriculum" data-panel="curriculum">My Curriculum</button>
          <button id="tab-profile" class="provider-nav-item provider-nav-icon-btn provider-nav-profile" type="button" role="tab" aria-selected="false" aria-controls="panel-profile" data-panel="profile" aria-label="My profile">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5zm0 2c-3.314 0-8 1.664-8 5v3h16v-3c0-3.336-4.686-5-8-5z" fill="currentColor"/>
            </svg>
          </button>
        </nav>

        <div class="provider-sidebar-footer">
          <div class="provider-upgrade-card">
            <div class="provider-upgrade-title">Upgrade and save</div>
            <p class="provider-upgrade-copy">Upgrade from a Basic account and save up to 100% on service fees with a Care+ subscription.</p>
            <a class="provider-upgrade-btn" href="shop.html">Explore Care+ plans</a>
          </div>
          <div class="provider-sidebar-actions">
            <button id="parentLogout" class="provider-logout" type="button">Log out</button>
            <button id="parentCurriculumBtn" class="provider-curriculum-btn" type="button">My Curriculum</button>
          </div>
        </div>
      </aside>

      <section class="provider-content">
        <header class="provider-content-header">
          <div>
            <p class="provider-eyebrow">Dashboard</p>
            <h1 class="provider-title">Welcome back<span id="parentWelcomeName"></span></h1>
            <p class="provider-subtitle">Track bookings, manage your family, and message caregivers.</p>
          </div>
          <div class="provider-header-actions">
            <button id="openParentProfileBtn" class="provider-header-btn parent-profile-btn" type="button">My Profile</button>
          </div>
        </header>

        <div class="provider-panels">
          <section id="panel-dashboard" class="provider-panel is-active" role="tabpanel" aria-labelledby="tab-dashboard">
            <section class="parent-time-card">
              <div class="parent-time-header">
                <div class="parent-time-title">What time are you looking for childcare?</div>
                <div class="parent-time-sub">We’ll check your saved caregivers first.</div>
                <div class="parent-time-child">
                  <label for="savedAvailabilityChild">Child</label>
                  <select id="savedAvailabilityChild" aria-label="Select child for this booking">
                    <option value="">Who's this for?</option>
                  </select>
                  <span id="savedAvailabilityChildAge" class="parent-time-child-age">Age --</span>
                </div>
              </div>
              <form id="savedAvailabilityForm" class="parent-time-form">
                <div class="parent-time-field parent-time-field--full">
                  <span>Date</span>
                  <div class="parent-time-date-row" role="group" aria-label="Choose a date">
                    <button type="button" class="parent-date-btn" data-date="today">Today</button>
                    <button type="button" class="parent-date-btn" data-date="tomorrow">Tomorrow</button>
                    <span class="parent-date-or">or</span>
                    <input type="date" id="savedAvailabilityDate" required aria-label="Custom date">
                  </div>
                </div>
                <label class="parent-time-field">
                  <span>Start</span>
                  <select id="savedAvailabilityStart" required></select>
                </label>
                <label class="parent-time-field">
                  <span>End</span>
                  <select id="savedAvailabilityEnd" required></select>
                </label>
                <button type="submit" class="parent-time-submit">Search</button>
                <div id="savedAvailabilitySummary" class="parent-time-summary parent-time-field--full"></div>
              </form>
              <div class="parent-saved-results" aria-live="polite">
                <div id="parentPaymentNotice" class="parent-payment-notice is-hidden" role="status">
                  <div>
                    <strong>Payment method required.</strong> Add a card to send booking requests.
                  </div>
                  <button type="button" id="parentAddPaymentBtn" class="parent-provider-btn primary">Add card</button>
                </div>
                <div id="savedAvailabilityResults" class="parent-saved-results-list"></div>
              </div>
            </section>

            <section class="provider-bookings-card parent-find-card parent-search-card">
              <div class="provider-card-head">
                <div>
                  <h2>Browse More Muslim Caregivers</h2>
                </div>
              </div>
              <div class="parent-find-form-wrap">
                <form id="heroFindForm" class="parent-find-form">
                  <div class="parent-find-inputs">
                    <button type="button" id="heroFindLocationBtn" class="parent-find-location-btn" title="Use current location">
                      <img src="Assets/findmylocation.png" alt="Use current location">
                    </button>
                    <select name="location" id="heroLocationInput" class="parent-find-select">
                      <option value="">Enter your location</option>
                      <option value="St. John's">St. John's, NL</option>
                      <option value="Halifax">Halifax, NS</option>
                      <option value="Saint John">Saint John, NB</option>
                      <option value="Charlottetown">Charlottetown, PE</option>
                      <option value="Quebec City">Quebec City, QC</option>
                      <option value="Montreal">Montreal, QC</option>
                      <option value="Toronto">Toronto, ON</option>
                      <option value="Ottawa">Ottawa, ON</option>
                      <option value="Hamilton">Hamilton, ON</option>
                      <option value="London">London, ON</option>
                      <option value="Winnipeg">Winnipeg, MB</option>
                      <option value="Calgary">Calgary, AB</option>
                      <option value="Edmonton">Edmonton, AB</option>
                      <option value="Red Deer">Red Deer, AB</option>
                      <option value="Lethbridge">Lethbridge, AB</option>
                      <option value="Regina">Regina, SK</option>
                      <option value="Saskatoon">Saskatoon, SK</option>
                      <option value="Prince Albert">Prince Albert, SK</option>
                      <option value="Moose Jaw">Moose Jaw, SK</option>
                      <option value="Yorkton">Yorkton, SK</option>
                      <option value="Swift Current">Swift Current, SK</option>
                      <option value="Vancouver">Vancouver, BC</option>
                      <option value="Victoria">Victoria, BC</option>
                      <option value="Surrey">Surrey, BC</option>
                      <option value="Burnaby">Burnaby, BC</option>
                      <option value="Kelowna">Kelowna, BC</option>
                      <option value="Whitehorse">Whitehorse, YT</option>
                      <option value="Yellowknife">Yellowknife, NT</option>
                      <option value="Iqaluit">Iqaluit, NU</option>
                    </select>
                    <button type="submit" class="parent-find-submit" aria-label="Search caregivers">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 8h14M8 1l7 7-7 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </form>
                <p class="parent-find-meta">Check availability before you request care.</p>
                <a class="parent-find-link" href="find-childcare.html">Browse caregivers near me</a>
              </div>
            </section>

            <div class="provider-dashboard-grid">
              <section class="provider-bookings-card parent-bookings-card">
                <div class="provider-card-head">
                  <div>
                    <h2>Upcoming bookings</h2>
                    <p class="provider-card-sub">Confirmed sessions with your caregivers.</p>
                  </div>
                  <span id="parentBookingsPill" class="provider-card-pill">0 upcoming</span>
                </div>
                <div class="parent-bookings-table">
                  <div class="parent-bookings-row parent-bookings-head">
                    <div class="parent-booking-cell">Caregiver</div>
                    <div class="parent-booking-cell">Caregiver contact</div>
                    <div class="parent-booking-cell">Hours booked</div>
                    <div class="parent-booking-cell">Time scheduled</div>
                    <div class="parent-booking-cell parent-booking-action">Action</div>
                  </div>
                  <div id="parentBookingsList" class="parent-bookings-body">
                    <div class="provider-bookings-empty">No upcoming bookings yet.</div>
                  </div>
                </div>
              </section>
            </div>
          </section>

          <section id="panel-calendar" class="provider-panel" role="tabpanel" aria-labelledby="tab-calendar" hidden>
            <div class="provider-panel-card">
              <h2>Calendar</h2>
              <p>Upcoming and recurring bookings.</p>
              <div id="parentCalendarList" class="parent-calendar-list">
                <div class="provider-bookings-empty">No upcoming bookings yet.</div>
              </div>
            </div>
          </section>

          <section id="panel-inbox" class="provider-panel" role="tabpanel" aria-labelledby="tab-inbox" hidden>
            <div class="provider-panel-card">
              <div class="provider-card-head">
                <div>
                  <h2>Messages</h2>
                  <p class="provider-card-sub">Stay in touch with caregivers and support.</p>
                </div>
                <span id="parentMessagesUnread" class="provider-card-pill" style="display:none;">0 unread</span>
              </div>
              <div id="parentMessagesList" class="parent-messages-list">
                <div class="provider-bookings-empty">No messages yet.</div>
              </div>
              <button id="parentMessagesOpenBtn" class="provider-header-btn" type="button">Open messages</button>
            </div>
          </section>

          <section id="panel-children" class="provider-panel" role="tabpanel" aria-labelledby="tab-children" hidden>
            <div class="provider-panel-card">
              <div class="provider-card-head">
                <div>
                  <h2>My children</h2>
                  <p class="provider-card-sub">Manage child profiles and care details.</p>
                </div>
                <div class="parent-action-row">
                  <button id="parentAddChildBtn" class="provider-header-btn" type="button">Add child</button>
                </div>
              </div>
              <div id="parentChildFormCard" class="parent-child-form-card is-hidden" aria-live="polite">
                <div class="parent-child-form-head">
                  <div>
                    <h3 id="parentChildFormTitle">Add child</h3>
                    <p class="parent-child-form-sub">Birthday is used to calculate age for pricing.</p>
                  </div>
                  <button id="parentChildFormCancel" class="provider-header-btn provider-header-btn-ghost" type="button">Cancel</button>
                </div>
                <form id="parentChildForm" class="parent-child-form">
                  <input type="hidden" id="parentChildId">
                  <div class="parent-child-form-grid">
                    <label class="provider-form-field">
                      <span>First name</span>
                      <input type="text" id="parentChildFirst" class="provider-input" required>
                    </label>
                    <label class="provider-form-field">
                      <span>Last name</span>
                      <input type="text" id="parentChildLast" class="provider-input">
                    </label>
                    <label class="provider-form-field">
                      <span>Birthday</span>
                      <input type="date" id="parentChildBirthdate" class="provider-input" required>
                      <div id="parentChildAgeLive" class="parent-child-age-live">Age: --</div>
                    </label>
                    <label class="provider-form-field parent-child-form-wide">
                      <span>Special needs (optional)</span>
                      <textarea id="parentChildNeeds" class="provider-textarea" rows="3" placeholder="Allergies, accommodations, notes..."></textarea>
                    </label>
                  </div>
                  <div class="parent-child-form-actions">
                    <button class="provider-header-btn" type="submit">Save child</button>
                    <span id="parentChildFormStatus" class="provider-form-status"></span>
                  </div>
                </form>
              </div>
              <div id="parentChildrenList" class="parent-children-grid">
                <div class="provider-bookings-empty">No children added yet.</div>
              </div>
            </div>
          </section>

          <section id="panel-caregivers" class="provider-panel" role="tabpanel" aria-labelledby="tab-caregivers" hidden>
            <div class="provider-panel-card">
              <div class="provider-card-head">
                <div>
                  <h2>My caregivers</h2>
                  <p class="provider-card-sub">Caregivers you have booked or saved.</p>
                </div>
              </div>
              <div id="parentCaregiversList" class="parent-caregivers-grid">
                <div class="provider-bookings-empty">No caregivers yet.</div>
              </div>
            </div>
          </section>

          <section id="panel-curriculum" class="provider-panel" role="tabpanel" aria-labelledby="tab-curriculum" hidden>
            <div class="provider-panel-card">
              <h2>My curriculum</h2>
              <p>Access curriculum tools, activities, and learning guides here.</p>
            </div>
          </section>

          <section id="panel-profile" class="provider-panel" role="tabpanel" aria-labelledby="tab-profile" hidden>
            <div class="provider-panel-card provider-profile-card">
              <div class="provider-card-head provider-profile-head">
                <div>
                  <h2>My profile</h2>
                  <p class="provider-card-sub">Update your family contact details and preferences.</p>
                </div>
                <button id="parentProfileBackBtn" class="provider-header-btn provider-header-btn-ghost" type="button">Back to Dashboard</button>
              </div>
              <form id="parentProfileForm" class="provider-profile-form">
                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Full name</span>
                    <input type="text" id="parentName" name="name" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Email (login)</span>
                    <input type="email" id="parentEmail" name="email" class="provider-input" readonly>
                  </label>
                  <label class="provider-form-field">
                    <span>Phone</span>
                    <input type="tel" id="parentPhone" name="phone" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Subscription</span>
                    <input type="text" id="parentSubscription" name="subscription_type" class="provider-input" readonly>
                  </label>
                  <div class="provider-form-field provider-form-field-wide">
                    <span>Payment method</span>
                    <button type="button" id="parentPaymentMethodBtn" class="provider-header-btn provider-header-btn-ghost">Update payment method</button>
                    <small>Manage the card used for bookings.</small>
                  </div>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Address line 1</span>
                    <input type="text" id="parentAddress1" name="address_line1" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Address line 2</span>
                    <input type="text" id="parentAddress2" name="address_line2" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>City</span>
                    <input type="text" id="parentCity" name="city" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Province/State</span>
                    <input type="text" id="parentProvince" name="province" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Postal/ZIP</span>
                    <input type="text" id="parentPostal" name="postal_code" class="provider-input">
                  </label>
                </div>

                <div class="provider-form-grid">
                  <label class="provider-form-field">
                    <span>Emergency contact name</span>
                    <input type="text" id="parentEmergencyName" name="emergency_contact_name" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Emergency contact phone</span>
                    <input type="tel" id="parentEmergencyPhone" name="emergency_contact_phone" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Spouse contact name</span>
                    <input type="text" id="parentSpouseName" name="spouse_name" class="provider-input">
                  </label>
                  <label class="provider-form-field">
                    <span>Spouse contact phone</span>
                    <input type="tel" id="parentSpousePhone" name="spouse_phone" class="provider-input">
                  </label>
                </div>

                <div class="provider-form-actions">
                  <button class="provider-header-btn" type="submit">Save changes</button>
                  <span id="parentProfileStatus" class="provider-form-status"></span>
                </div>
              </form>
              <div class="dashboard-profile-links">
                <a href="care-process.html">Our Care Process</a>
                <a href="become-provider.html">Join Our Care Network</a>
                <a href="learning.html">At-Home Learning</a>
                <a href="terms-of-service.html">Terms of Service</a>
                <a href="privacy-policy.html">Privacy Policy</a>
                <a href="disclaimers.html">Disclaimers</a>
              </div>
            </div>
          </section>
        </div>
      </section>
    </main>

    <footer style="background:#06464E; color:white; padding:32px 24px; text-align:center; margin-top:48px;">
      <p style="margin:0;">© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script src="script.js"></script>
    <script>
      const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';
      const userId = parseInt(localStorage.getItem('user_id'), 10) || null;
      const savedCaregiversKey = userId ? `saved_caregivers_${userId}` : 'saved_caregivers_guest';

      const computeAgeFromBirthdate = (value) => {
        if(!value) return null;
        const birth = new Date(value);
        if(Number.isNaN(birth.getTime())) return null;
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if(monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())){
          age -= 1;
        }
        return age;
      };

      const showNotice = (message, type) => {
        if(typeof window.showBanner === 'function') {
          window.showBanner(message, type || 'info');
        } else {
          alert(message);
        }
      };

      const formatHomeAddress = (profile) => {
        if(!profile) return '';
        return [profile.address_line1, profile.city, profile.province, profile.postal_code]
          .filter(Boolean)
          .join(', ');
      };

      let parentHasPaymentMethod = false;
      const paymentNoticeEl = document.getElementById('parentPaymentNotice');
      const addPaymentBtn = document.getElementById('parentAddPaymentBtn');
      const paymentMethodBtn = document.getElementById('parentPaymentMethodBtn');
      const togglePaymentNotice = (show) => {
        if(!paymentNoticeEl) return;
        paymentNoticeEl.classList.toggle('is-hidden', !show);
      };
      const updatePaymentButtonLabel = () => {
        if(!paymentMethodBtn) return;
        paymentMethodBtn.textContent = parentHasPaymentMethod ? 'Update payment method' : 'Add payment method';
      };
      const goToPaymentMethod = (returnToProfile = false) => {
        const returnPath = returnToProfile ? 'parent-dashboard.html#profile' : 'parent-dashboard.html';
        const returnUrl = encodeURIComponent(returnPath);
        window.location.href = `payment-method.html?return=${returnUrl}`;
      };

      const refreshPaymentStatus = async () => {
        if(!userId) return false;
        try{
          const res = await fetch(`${API_BASE}/payments/status?user_id=${userId}`);
          const data = await res.json();
          if(res.ok){
            parentHasPaymentMethod = !!data.has_payment_method;
            updatePaymentButtonLabel();
            return parentHasPaymentMethod;
          }
        }catch(err){
          console.warn('Payment status check failed', err);
        }
        return parentHasPaymentMethod;
      };

      if(addPaymentBtn){
        addPaymentBtn.addEventListener('click', () => goToPaymentMethod(false));
      }
      if(paymentMethodBtn){
        paymentMethodBtn.addEventListener('click', () => goToPaymentMethod(true));
      }

      window.updateParentSavedCaregivers = async (savedIds = []) => {
        if(!userId) return;
        try{
          await fetch(`${API_BASE}/forms/parent/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ saved_caregivers: savedIds })
          });
          if(Array.isArray(savedIds)){
            window.parentSavedCaregivers = savedIds.map(String);
            localStorage.setItem(savedCaregiversKey, JSON.stringify(savedIds));
            if(Array.isArray(window.parentDashboardSessions)){
              renderCaregivers(window.parentDashboardSessions, savedIds);
            }
          }
        }catch(err){
          console.error('Failed to save caregivers list', err);
        }
      };

      const activateParentPanel = (panelId) => {
        const navItems = Array.from(document.querySelectorAll('.provider-nav-item'));
        const panels = Array.from(document.querySelectorAll('.provider-panel'));
        const navTarget = panelId;
        navItems.forEach((btn) => {
          const isActive = btn.dataset.panel === navTarget;
          btn.classList.toggle('is-active', isActive);
          btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        panels.forEach((panel) => {
          const isActive = panel.id === `panel-${panelId}`;
          panel.classList.toggle('is-active', isActive);
          panel.hidden = !isActive;
        });
      };

      document.querySelectorAll('.provider-nav-item').forEach((btn) => {
        btn.addEventListener('click', () => {
          const panel = btn.dataset.panel;
          if(!panel) return;
          const isMobile = window.matchMedia('(max-width: 719px)').matches;
          if(panel === 'inbox' && isMobile && typeof window.showChatWidget === 'function'){
            activateParentPanel(panel);
            window.showChatWidget();
            return;
          }
          if(isMobile && panel !== 'inbox' && typeof window.hideChatWidget === 'function'){
            window.hideChatWidget();
          }
          activateParentPanel(panel);
        });
        btn.addEventListener('keydown', (event) => {
          if(event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            btn.click();
          }
        });
      });

      const initialPanel = window.location.hash.replace('#', '');
      activateParentPanel(initialPanel || 'dashboard');

      window.focusBookingModule = (childId) => {
        activateParentPanel('dashboard');
        const card = document.querySelector('.parent-time-card');
        if(card){
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        const childSelect = document.getElementById('savedAvailabilityChild');
        if(childSelect && childId){
          childSelect.value = String(childId);
          childSelect.dispatchEvent(new Event('change'));
        }
      };

      document.getElementById('openParentProfileBtn')?.addEventListener('click', () => {
        window.location.hash = 'profile';
        activateParentPanel('profile');
      });
      document.getElementById('topProfileBtn')?.addEventListener('click', () => {
        window.location.hash = 'profile';
        activateParentPanel('profile');
      });
      document.getElementById('parentProfileBackBtn')?.addEventListener('click', () => {
        window.location.hash = 'dashboard';
        activateParentPanel('dashboard');
      });

      const logoutHandler = () => {
        if(confirm('Are you sure you want to log out?')) {
          localStorage.removeItem('user_id');
          localStorage.removeItem('user_type');
          window.location.href = 'index.html';
        }
      };
      document.getElementById('parentLogout')?.addEventListener('click', logoutHandler);
      document.getElementById('parentCurriculumBtn')?.addEventListener('click', () => {
        window.location.hash = 'curriculum';
        activateParentPanel('curriculum');
      });

      const toDate = (value) => {
        if(!value) return null;
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? null : date;
      };

      const minutesFromTime = (timeStr) => {
        if(!timeStr) return null;
        const parts = timeStr.split(':').map(Number);
        if(parts.length < 2 || parts.some((p) => Number.isNaN(p))) return null;
        return (parts[0] * 60) + parts[1];
      };

      const durationHours = (entry) => {
        if(entry.start_time && entry.end_time) {
          const start = minutesFromTime(entry.start_time);
          const end = minutesFromTime(entry.end_time);
          if(start === null || end === null) return 0;
          return Math.max(0, (end - start) / 60);
        }
        if(entry.start_at && entry.end_at) {
          const start = new Date(entry.start_at);
          const end = new Date(entry.end_at);
          if(Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return 0;
          return Math.max(0, (end - start) / (1000 * 60 * 60));
        }
        return 0;
      };

      const formatDateLabel = (date) => date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });

      const formatTimeLabel = (timeStr) => {
        if(!timeStr) return '';
        const parts = timeStr.split(':').map(Number);
        if(parts.length < 2 || parts.some((p) => Number.isNaN(p))) return timeStr;
        const base = new Date();
        base.setHours(parts[0], parts[1], 0, 0);
        return base.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' });
      };

      const formatScheduleLabel = (entry) => {
        if(entry.start_at && entry.end_at) {
          const start = toDate(entry.start_at);
          const end = toDate(entry.end_at);
          if(!start || !end) return 'TBD';
          return `${formatDateLabel(start)} ${start.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })} - ${end.toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' })}`;
        }
        if(entry.session_date) {
          const date = toDate(entry.session_date);
          if(!date) return 'TBD';
          if(entry.start_time && entry.end_time) {
            return `${formatDateLabel(date)} ${formatTimeLabel(entry.start_time)} - ${formatTimeLabel(entry.end_time)}`;
          }
          return formatDateLabel(date);
        }
        return 'TBD';
      };

      const renderUpcomingBookings = (sessions) => {
        const listEl = document.getElementById('parentBookingsList');
        const countEl = document.getElementById('parentBookingsPill');
        const kpiCount = document.getElementById('parentUpcomingCount');
        if(!listEl) return;
        const now = new Date();
        const upcoming = (sessions || []).filter((entry) => {
          const status = String(entry.status || '').toLowerCase();
          if(status.includes('cancel')) return false;
          const start = entry.start_at ? new Date(entry.start_at) : null;
          if(start) return start >= now;
          if(entry.session_date) {
            const date = toDate(entry.session_date);
            return date ? date >= new Date(now.toDateString()) : false;
          }
          return false;
        });
        if(countEl) countEl.textContent = `${upcoming.length} upcoming`;
        if(kpiCount) kpiCount.textContent = String(upcoming.length);
        if(upcoming.length === 0) {
          listEl.innerHTML = '<div class="provider-bookings-empty">No upcoming bookings yet.</div>';
          return;
        }
        listEl.innerHTML = upcoming.slice(0, 6).map((entry) => {
          const contactBits = [entry.provider_email, entry.provider_phone].filter(Boolean).join(' · ');
          const hours = durationHours(entry);
          const hoursLabel = hours ? `${hours.toFixed(1).replace(/\.0$/, '')} hrs` : 'TBD';
          const providerName = entry.provider_name || 'Caregiver';
          const schedule = formatScheduleLabel(entry);
          const contactLabel = contactBits || 'Contact not available';
          const providerId = entry.provider_id || entry.provider_user_id || '';
          return `
            <div class="parent-bookings-row parent-bookings-item">
              <div class="parent-booking-cell" data-label="Caregiver">${providerName}</div>
              <div class="parent-booking-cell" data-label="Caregiver contact">
                <span class="parent-booking-contact">${contactLabel}</span>
              </div>
              <div class="parent-booking-cell" data-label="Hours booked">${hoursLabel}</div>
              <div class="parent-booking-cell" data-label="Time scheduled">${schedule}</div>
              <div class="parent-booking-cell parent-booking-action" data-label="Action">
                <button class="parent-booking-btn" data-id="${providerId}" data-name="${providerName}">Message</button>
              </div>
            </div>
          `;
        }).join('');

        listEl.querySelectorAll('.parent-booking-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const otherId = parseInt(btn.getAttribute('data-id'), 10);
            const otherName = btn.getAttribute('data-name') || 'Caregiver';
            if(otherId && window.showChatWidget) {
              window.showChatWidget(otherId, otherName);
            } else if(otherId && window.openChatThread) {
              window.openChatThread(otherId, otherName);
            }
          });
        });
      };

      const renderCalendar = (sessions) => {
        const listEl = document.getElementById('parentCalendarList');
        if(!listEl) return;
        if(!sessions || sessions.length === 0) {
          listEl.innerHTML = '<div class="provider-bookings-empty">No upcoming bookings yet.</div>';
          return;
        }
        const upcoming = sessions.slice().sort((a, b) => {
          const aDate = toDate(a.start_at || a.session_date);
          const bDate = toDate(b.start_at || b.session_date);
          return (aDate?.getTime() || 0) - (bDate?.getTime() || 0);
        });
        listEl.innerHTML = upcoming.slice(0, 8).map((entry) => {
          const providerName = entry.provider_name || 'Caregiver';
          const schedule = formatScheduleLabel(entry);
          return `
            <div class="parent-calendar-item">
              <div>
                <div class="parent-calendar-title">${providerName}</div>
                <div class="parent-calendar-sub">${schedule}</div>
              </div>
            </div>
          `;
        }).join('');
      };

      const renderChildren = (children) => {
        const listEl = document.getElementById('parentChildrenList');
        if(!listEl) return;
        if(!children || children.length === 0) {
          listEl.innerHTML = '<div class="provider-bookings-empty">No children added yet.</div>';
          return;
        }
        window.parentChildrenList = children;
        const childSelect = document.getElementById('savedAvailabilityChild');
        if(childSelect){
          const ageLabel = document.getElementById('savedAvailabilityChildAge');
          childSelect.innerHTML = `<option value="">Who's this for?</option>${children.map((c) => {
            const label = [c.first_name, c.last_name].filter(Boolean).join(' ') || c.name || 'Child';
            const ageVal = computeAgeFromBirthdate(c.birthdate) ?? c.age ?? '';
            return `<option value="${c.id || ''}" data-age="${ageVal}">${label}</option>`;
          }).join('')}`;
          if(ageLabel) ageLabel.textContent = 'Age --';
          childSelect.onchange = () => {
            if(!ageLabel) return;
            const selected = childSelect.options[childSelect.selectedIndex];
            const ageVal = selected ? selected.getAttribute('data-age') : '';
            ageLabel.textContent = ageVal ? `Age ${ageVal}` : 'Age --';
          };
        }
        listEl.innerHTML = children.map((child) => {
          const name = [child.first_name, child.last_name].filter(Boolean).join(' ') || 'Child';
          const initials = name.split(' ').map((n) => n[0]).join('').slice(0, 2).toUpperCase();
          const derivedAge = computeAgeFromBirthdate(child.birthdate);
          const ageLabel = (derivedAge !== null ? derivedAge : child.age) ? `${derivedAge !== null ? derivedAge : child.age} yrs` : 'Age not set';
          return `
            <div class="parent-child-card">
              <div class="parent-child-avatar">${initials}</div>
              <div class="parent-child-info">
                <div class="parent-child-name">${name}</div>
                <div class="parent-child-meta">${ageLabel}</div>
              </div>
              <div class="parent-child-actions">
                <button class="parent-child-btn parent-child-edit" data-id="${child.id}">Edit</button>
                <button class="parent-child-btn parent-child-book" type="button" data-id="${child.id}">Book with ${name.split(' ')[0] || 'child'}</button>
              </div>
            </div>
          `;
        }).join('');

        listEl.querySelectorAll('.parent-child-edit').forEach((btn) => {
          btn.addEventListener('click', () => {
            const childId = btn.getAttribute('data-id');
            if(childId && typeof window.openChildForm === 'function') {
              const child = children.find(c => String(c.id) === String(childId));
              window.openChildForm(child);
            }
          });
        });
        listEl.querySelectorAll('.parent-child-book').forEach((btn) => {
          btn.addEventListener('click', () => {
            const childId = btn.getAttribute('data-id');
            if(typeof window.focusBookingModule === 'function') {
              window.focusBookingModule(childId);
            }
          });
        });
      };

      const setupChildForm = () => {
        const formCard = document.getElementById('parentChildFormCard');
        const form = document.getElementById('parentChildForm');
        if(!formCard || !form) return;
        const titleEl = document.getElementById('parentChildFormTitle');
        const cancelBtn = document.getElementById('parentChildFormCancel');
        const addBtn = document.getElementById('parentAddChildBtn');
        const statusEl = document.getElementById('parentChildFormStatus');
        const idInput = document.getElementById('parentChildId');
        const firstInput = document.getElementById('parentChildFirst');
        const lastInput = document.getElementById('parentChildLast');
        const birthInput = document.getElementById('parentChildBirthdate');
        const needsInput = document.getElementById('parentChildNeeds');
        const ageLive = document.getElementById('parentChildAgeLive');

        const resetForm = () => {
          if(idInput) idInput.value = '';
          if(firstInput) firstInput.value = '';
          if(lastInput) lastInput.value = '';
          if(birthInput) birthInput.value = '';
          if(needsInput) needsInput.value = '';
          if(ageLive) ageLive.textContent = 'Age: --';
          if(statusEl) statusEl.textContent = '';
          if(titleEl) titleEl.textContent = 'Add child';
        };

        const updateAgeLive = () => {
          if(!ageLive || !birthInput) return;
          const age = computeAgeFromBirthdate(birthInput.value);
          ageLive.textContent = age !== null ? `Age: ${age}` : 'Age: --';
        };
        birthInput?.addEventListener('change', updateAgeLive);

        window.openChildForm = (child) => {
          formCard.classList.remove('is-hidden');
          if(child){
            if(titleEl) titleEl.textContent = 'Edit child';
            if(idInput) idInput.value = child.id || '';
            if(firstInput) firstInput.value = child.first_name || '';
            if(lastInput) lastInput.value = child.last_name || '';
            if(birthInput) birthInput.value = child.birthdate || '';
            if(needsInput) needsInput.value = child.special_needs || '';
            updateAgeLive();
          } else {
            resetForm();
          }
        };

        const closeForm = () => {
          formCard.classList.add('is-hidden');
          resetForm();
        };
        cancelBtn?.addEventListener('click', closeForm);
        addBtn?.addEventListener('click', () => window.openChildForm());

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if(!userId){
            showNotice('Please log in to save child profiles.', 'info');
            return;
          }
          const payload = {
            user_id: userId,
            parent_id: userId,
            first_name: firstInput?.value?.trim() || null,
            last_name: lastInput?.value?.trim() || null,
            birthdate: birthInput?.value || null,
            age: computeAgeFromBirthdate(birthInput?.value || ''),
            specialNeeds: needsInput?.value?.trim() || null
          };
          if(statusEl){
            statusEl.textContent = 'Saving...';
            statusEl.style.color = '#9ca3af';
          }
          try{
            const editingId = idInput?.value ? parseInt(idInput.value, 10) : null;
            if(editingId){
              await fetch(`${API_BASE}/forms/child/${editingId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
            } else {
              await fetch(`${API_BASE}/forms/children`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
            }
            if(statusEl){
              statusEl.textContent = 'Saved';
              statusEl.style.color = '#34d399';
            }
            await loadParentDashboard();
            setTimeout(closeForm, 400);
          }catch(err){
            if(statusEl){
              statusEl.textContent = 'Save failed';
              statusEl.style.color = '#f87171';
            }
            console.error(err);
          }
        });
      };

      const fetchProviderProfile = async (providerId) => {
        if(!providerId) return null;
        try{
          const resp = await fetch(`${API_BASE}/forms/provider/${encodeURIComponent(providerId)}`);
          if(!resp.ok) return null;
          const data = await resp.json();
          const profile = data.profile || {};
          return {
            id: profile.provider_id || profile.id || providerId,
            name: profile.name || 'Caregiver',
            email: profile.email || '',
            phone: profile.phone || '',
            city: profile.city || '',
            province: profile.province || '',
            availability: profile.availability || null
          };
        }catch(err){
          console.warn('Failed to load saved caregiver profile', err);
          return null;
        }
      };

      const renderCaregivers = async (sessions, savedIds = []) => {
        const listEl = document.getElementById('parentCaregiversList');
        if(!listEl) return;
        const savedSet = new Set((savedIds || window.parentSavedCaregivers || []).map((id) => String(id)));
        const caregivers = new Map();
        (sessions || []).forEach((entry) => {
          const id = entry.provider_id || entry.provider_user_id;
          if(!id) return;
          caregivers.set(String(id), {
            id: String(id),
            name: entry.provider_name || 'Caregiver',
            email: entry.provider_email || '',
            phone: entry.provider_phone || '',
            city: entry.provider_city || '',
            province: entry.provider_province || ''
          });
        });
        const missingSaved = Array.from(savedSet).filter((id) => id && !caregivers.has(id));
        if(missingSaved.length > 0){
          const savedProfiles = await Promise.all(missingSaved.map(fetchProviderProfile));
          savedProfiles.filter(Boolean).forEach((profile) => {
            caregivers.set(String(profile.id), {
              id: String(profile.id),
              name: profile.name,
              email: profile.email,
              phone: profile.phone,
              city: profile.city,
              province: profile.province
            });
          });
        }
        const items = Array.from(caregivers.values()).sort((a, b) => {
          const aSaved = savedSet.has(String(a.id));
          const bSaved = savedSet.has(String(b.id));
          if(aSaved === bSaved) return 0;
          return aSaved ? -1 : 1;
        });
        const countEl = document.getElementById('parentCaregiverCount');
        if(countEl) countEl.textContent = String(items.length);
        if(items.length === 0) {
          listEl.innerHTML = '<div class="provider-bookings-empty">No caregivers yet.</div>';
          return;
        }
        listEl.innerHTML = items.map((c) => {
          const initials = c.name.split(' ').map((n) => n[0]).join('').slice(0, 2).toUpperCase();
          const location = [c.city, c.province].filter(Boolean).join(', ');
          const contact = [c.email, c.phone].filter(Boolean).join(' · ') || 'Contact not available';
          return `
            <div class="parent-caregiver-card">
              <div class="parent-caregiver-avatar">${initials}</div>
              <div class="parent-caregiver-info">
                <div class="parent-caregiver-name">${c.name}</div>
                <div class="parent-caregiver-meta">${location || 'Location not set'}</div>
                <div class="parent-caregiver-contact">${contact}</div>
              </div>
              <button class="parent-caregiver-btn" data-id="${c.id}" data-name="${c.name}">Message</button>
            </div>
          `;
        }).join('');

        listEl.querySelectorAll('.parent-caregiver-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const otherId = parseInt(btn.getAttribute('data-id'), 10);
            const otherName = btn.getAttribute('data-name') || 'Caregiver';
            if(otherId && window.showChatWidget) {
              window.showChatWidget(otherId, otherName);
            } else if(otherId && window.openChatThread) {
              window.openChatThread(otherId, otherName);
            }
          });
        });
      };

      const parseTimeToMinutes = (value) => {
        if(!value) return null;
        const raw = String(value).trim();
        const ampmMatch = raw.match(/(am|pm)/i);
        const clean = raw.replace(/[^0-9:]/g, '');
        const parts = clean.split(':');
        if(parts.length < 2) return null;
        let hours = parseInt(parts[0], 10);
        let mins = parseInt(parts[1], 10);
        if(Number.isNaN(hours) || Number.isNaN(mins)) return null;
        if(ampmMatch){
          const isPm = ampmMatch[0].toLowerCase() === 'pm';
          if(hours === 12) hours = isPm ? 12 : 0;
          else if(isPm) hours += 12;
        }
        return hours * 60 + mins;
      };

      const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];

      const isAvailableForWindow = (availability, dayKey, startMinutes, endMinutes) => {
        if(!availability || startMinutes === null || endMinutes === null) return false;
        const daysToCheck = dayKey ? [dayKey] : dayNames;
        return daysToCheck.some((day) => {
          const dayAvailability = availability[day];
          if(!dayAvailability) return false;
          const slots = Array.isArray(dayAvailability) ? dayAvailability : [dayAvailability];
          return slots.some(slot => {
            if(!slot || !slot.from || !slot.to) return false;
            const fromMinutes = parseTimeToMinutes(slot.from);
            const toMinutes = parseTimeToMinutes(slot.to);
            if(fromMinutes === null || toMinutes === null) return false;
            return startMinutes >= fromMinutes && endMinutes <= toMinutes;
          });
        });
      };

      const buildDateTime = (dateVal, timeVal) => {
        if(!dateVal || !timeVal) return null;
        if(timeVal === '24:00'){
          const date = new Date(`${dateVal}T00:00:00`);
          date.setDate(date.getDate() + 1);
          return `${date.toISOString().slice(0,10)}T00:00`;
        }
        return `${dateVal}T${timeVal}`;
      };

      const getBookingLocation = () => {
        if(window.parentHomeAddress) return window.parentHomeAddress;
        const profile = window.parentProfile || {};
        const homeAddress = formatHomeAddress(profile);
        if(homeAddress) return homeAddress;
        const locationInput = document.getElementById('heroLocationInput');
        if(locationInput && locationInput.value) return locationInput.value;
        return localStorage.getItem('parent_city') || localStorage.getItem('last_search_location') || '';
      };

      window.startDashboardBooking = async (providerId, providerName, triggerBtn) => {
        if(!userId){
          showNotice('Please log in to book caregivers.', 'info');
          setTimeout(() => window.location.href = 'account-signup.html', 1200);
          return;
        }
        if(!providerId){
          showNotice('Please choose a caregiver first.', 'info');
          return;
        }
        const dateInput = document.getElementById('savedAvailabilityDate');
        const startInput = document.getElementById('savedAvailabilityStart');
        const endInput = document.getElementById('savedAvailabilityEnd');
        const childSelect = document.getElementById('savedAvailabilityChild');
        const dateVal = dateInput?.value || '';
        const startVal = startInput?.value || '';
        const endVal = endInput?.value || '';
        const childId = childSelect?.value || '';
        if(!childId){
          showNotice('Please choose a child for this booking.', 'info');
          window.focusBookingModule && window.focusBookingModule();
          return;
        }
        if(!dateVal || !startVal || !endVal){
          showNotice('Please choose a date and time window first.', 'info');
          window.focusBookingModule && window.focusBookingModule(childId);
          return;
        }
        const startMinutes = parseTimeToMinutes(startVal);
        const endMinutes = parseTimeToMinutes(endVal);
        if(startMinutes === null || endMinutes === null || endMinutes <= startMinutes){
          showNotice('Please choose a valid time window.', 'info');
          return;
        }
        const start_at = buildDateTime(dateVal, startVal);
        const end_at = buildDateTime(dateVal, endVal);
        const location = getBookingLocation();
        if(!location){
          showNotice('Add your home address in My Profile before booking.', 'info');
          return;
        }

        const hasPayment = await refreshPaymentStatus();
        if(!hasPayment){
          togglePaymentNotice(true);
          showNotice('Payment method required to send a booking request.', 'info');
          return;
        }
        togglePaymentNotice(false);

        const selected = childSelect?.options?.[childSelect.selectedIndex];
        const ageVal = selected ? selected.getAttribute('data-age') : '';
        const payload = {
          user_id: userId,
          child_id: parseInt(childId, 10),
          provider_id: providerId ? parseInt(providerId, 10) : null,
          location,
          start_at,
          end_at,
          notes: '',
          child_age: ageVal ? Number(ageVal) : null
        };

        const originalLabel = triggerBtn ? triggerBtn.textContent : '';
        if(triggerBtn){
          triggerBtn.disabled = true;
          triggerBtn.textContent = 'Sending...';
        }
        try{
          const res = await fetch(`${API_BASE}/forms/request`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(()=> ({}));
          if(!res.ok){
            if(data && data.code === 'missing_payment_method'){
              togglePaymentNotice(true);
            }
            throw new Error(data.error || 'Failed to send request');
          }
          showNotice(`Request sent to ${providerName || 'caregiver'}. You will only be charged if they accept.`, 'success');
        }catch(err){
          console.error('Booking request failed', err);
          showNotice(err.message || 'Unable to send request.', 'error');
        }finally{
          if(triggerBtn){
            triggerBtn.disabled = false;
            triggerBtn.textContent = originalLabel || 'Book';
          }
        }
      };

      const hookSavedAvailabilitySearch = () => {
        const form = document.getElementById('savedAvailabilityForm');
        const dateInput = document.getElementById('savedAvailabilityDate');
        const startInput = document.getElementById('savedAvailabilityStart');
        const endInput = document.getElementById('savedAvailabilityEnd');
        const resultsEl = document.getElementById('savedAvailabilityResults');
        const summaryEl = document.getElementById('savedAvailabilitySummary');
        const locationInput = document.getElementById('heroLocationInput');
        if(!form || !dateInput || !startInput || !endInput || !resultsEl) return;
        const quickDateButtons = form.querySelectorAll('.parent-date-btn');
        const buildTimeOptions = (select, maxMinutes) => {
          if(!select) return;
          select.innerHTML = '<option value="">Select</option>';
          const start = 6 * 60;
          const end = maxMinutes;
          for(let minutes = start; minutes <= end; minutes += 30){
            const hours24 = Math.floor(minutes / 60);
            const mins = String(minutes % 60).padStart(2, '0');
            const value = `${String(hours24).padStart(2, '0')}:${mins}`;
            let label;
            if(hours24 === 24){
              label = `12:${mins} AM`;
            } else {
              const period = hours24 >= 12 ? 'PM' : 'AM';
              const hours12Raw = hours24 % 12;
              const hours12 = hours12Raw === 0 ? 12 : hours12Raw;
              label = `${hours12}:${mins} ${period}`;
            }
            const option = document.createElement('option');
            option.value = value;
            option.textContent = label;
            select.appendChild(option);
          }
        };
        buildTimeOptions(startInput, 23 * 60 + 30);
        buildTimeOptions(endInput, 24 * 60);
        const todayBtn = Array.from(quickDateButtons).find(btn => btn.dataset.date === 'today');
        if(todayBtn){ todayBtn.click(); }
        const toLocalDateString = (value) => {
          const yyyy = value.getFullYear();
          const mm = String(value.getMonth() + 1).padStart(2, '0');
          const dd = String(value.getDate()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}`;
        };
        const setQuickDate = (mode) => {
          const date = new Date();
          if(mode === 'tomorrow') date.setDate(date.getDate() + 1);
          dateInput.value = toLocalDateString(date);
          quickDateButtons.forEach(btn => {
            btn.classList.toggle('is-active', btn.dataset.date === mode);
          });
          updateSummary();
        };
        quickDateButtons.forEach(btn => {
          btn.addEventListener('click', () => setQuickDate(btn.dataset.date));
        });
        dateInput.addEventListener('change', () => {
          quickDateButtons.forEach(btn => btn.classList.remove('is-active'));
          updateSummary();
        });
        const updateSummary = () => {
          if(!summaryEl) return;
          const dateVal = dateInput.value;
          const startVal = startInput.value;
          const endVal = endInput.value;
          if(!dateVal || !startVal || !endVal){
            summaryEl.textContent = '';
            return;
          }
          const startMinutes = parseTimeToMinutes(startVal);
          const endMinutes = parseTimeToMinutes(endVal);
          if(startMinutes === null || endMinutes === null || endMinutes <= startMinutes){
            summaryEl.textContent = '';
            return;
          }
          const hours = (endMinutes - startMinutes) / 60;
          const hoursLabel = Number.isInteger(hours) ? `${hours} hours` : `${hours.toFixed(1)} hours`;
          const dateLabel = new Date(`${dateVal}T00:00:00`).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
          summaryEl.textContent = `You are booking for ${hoursLabel} on ${dateLabel}.`;
        };
        startInput.addEventListener('change', updateSummary);
        endInput.addEventListener('change', updateSummary);
        const ensureLocation = () => {
          if(!locationInput || locationInput.value) return;
          const fallbackCity = localStorage.getItem('parent_city') || localStorage.getItem('last_search_location') || '';
          if(!fallbackCity) return;
          const match = Array.from(locationInput.options || []).find(option =>
            option.value === fallbackCity || option.textContent.includes(fallbackCity)
          );
          if(match) locationInput.value = match.value;
        };
        const childSelect = document.getElementById('savedAvailabilityChild');
        const populateChildSelect = () => {
          if(!childSelect) return;
          const children = Array.isArray(window.parentChildrenList) ? window.parentChildrenList : [];
          childSelect.innerHTML = `<option value="">Who's this for?</option>${children.map(c => {
            const label = c.name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || 'Child';
            const ageVal = computeAgeFromBirthdate(c.birthdate) ?? c.age ?? '';
            return `<option value="${c.id || ''}" data-age="${ageVal}">${label}</option>`;
          }).join('')}`;
          const ageLabel = document.getElementById('savedAvailabilityChildAge');
          if(ageLabel) ageLabel.textContent = 'Age --';
          childSelect.onchange = () => {
            if(!ageLabel) return;
            const selected = childSelect.options[childSelect.selectedIndex];
            const ageVal = selected ? selected.getAttribute('data-age') : '';
            ageLabel.textContent = ageVal ? `Age ${ageVal}` : 'Age --';
          };
        };
        populateChildSelect();

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const dateVal = dateInput.value;
          const startVal = startInput.value;
          const endVal = endInput.value;
          if(!dateVal || !startVal || !endVal){
            showNotice('Please choose a date and time window.', 'info');
            return;
          }
          const startMinutes = parseTimeToMinutes(startVal);
          const endMinutes = parseTimeToMinutes(endVal);
          if(startMinutes === null || endMinutes === null || endMinutes <= startMinutes){
            resultsEl.innerHTML = '<div class="parent-provider-empty">Please enter a valid time window.</div>';
            return;
          }
          const dayKey = dayNames[new Date(`${dateVal}T00:00:00`).getDay()];
          window.parentSelectedTimeRange = { startMinutes, endMinutes, date: dateVal };
          window.parentSelectedDate = dateVal;

          const savedIds = (window.parentSavedCaregivers || []).map(String);
          if(savedIds.length === 0){
            resultsEl.innerHTML = `
              <div class="parent-provider-empty">
                You don’t have saved caregivers yet.<br>
                Would you like to browse more Muslim caregivers in your area?
                <div class="parent-empty-actions">
                  <button type="button" class="parent-provider-btn primary" id="searchAllCaregiversBtn">Yes, show caregivers</button>
                  <button type="button" class="parent-provider-btn ghost" id="dismissSavedSearchBtn">Not now</button>
                </div>
              </div>
            `;
            const btn = document.getElementById('searchAllCaregiversBtn');
            if(btn){
              btn.addEventListener('click', () => {
                ensureLocation();
                if(locationInput && locationInput.value && document.getElementById('heroFindForm')){
                  document.getElementById('heroFindForm').requestSubmit();
                } else {
                  showNotice('Choose a city on the right to search all caregivers.', 'info');
                }
              });
            }
            const dismiss = document.getElementById('dismissSavedSearchBtn');
            dismiss && dismiss.addEventListener('click', () => {
              resultsEl.innerHTML = '';
            });
            return;
          }

          const profiles = await Promise.all(savedIds.map(fetchProviderProfile));
          const available = profiles.filter(Boolean).filter(p => {
            const availability = typeof p.availability === 'string' ? JSON.parse(p.availability || '{}') : (p.availability || {});
            const schedule = availability && availability.schedule ? availability.schedule : availability;
            return isAvailableForWindow(schedule, dayKey, startMinutes, endMinutes);
          });

          if(available.length === 0){
            resultsEl.innerHTML = `
              <div class="parent-provider-empty">
                No saved caregivers are available at that time.<br>
                ${childSelect && childSelect.value ? `For: ${childSelect.options[childSelect.selectedIndex].textContent}` : ''}
                Would you like to browse more Muslim caregivers in your area?
                <div class="parent-empty-actions">
                  <button type="button" class="parent-provider-btn primary" id="searchAllCaregiversBtn">Yes, show caregivers</button>
                  <button type="button" class="parent-provider-btn ghost" id="dismissSavedSearchBtn">Not now</button>
                </div>
              </div>
            `;
            const btn = document.getElementById('searchAllCaregiversBtn');
            if(btn){
              btn.addEventListener('click', () => {
                ensureLocation();
                if(locationInput && locationInput.value && document.getElementById('heroFindForm')){
                  document.getElementById('heroFindForm').requestSubmit();
                } else {
                  showNotice('Choose a city on the right to search all caregivers.', 'info');
                }
              });
            }
            const dismiss = document.getElementById('dismissSavedSearchBtn');
            dismiss && dismiss.addEventListener('click', () => {
              resultsEl.innerHTML = '';
            });
            return;
          }

          const rows = available.map((p) => {
            const displayName = p.name || 'Caregiver';
            const initials = displayName.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
            const profileLink = `caregiver-profile.html?provider_id=${encodeURIComponent(p.id)}`;
            return `
              <div class="parent-provider-row" data-profile="${profileLink}">
                <div class="parent-provider-main">
                  <div class="parent-provider-avatar">${initials}</div>
                  <div class="parent-provider-body">
                    <div class="parent-provider-name">${displayName}</div>
                    <div class="parent-provider-meta">From your saved caregivers · Available for your selected time</div>
                  </div>
                </div>
                <div class="parent-provider-actions">
                  <button type="button" class="parent-provider-btn primary" data-action="book" data-provider="${p.id}" data-name="${displayName}">Book</button>
                  <button type="button" class="parent-provider-btn ghost" data-action="message" data-provider="${p.id}" data-name="${displayName}">Message</button>
                </div>
              </div>
            `;
          }).join('');

          resultsEl.innerHTML = `
            <div class="parent-results-title" style="margin-bottom:8px;">From your saved caregivers</div>
            <div class="parent-results-list">${rows}</div>
          `;

          resultsEl.querySelectorAll('.parent-provider-row').forEach(row=>{
            row.addEventListener('click', (evt)=>{
              if(evt.target.closest('button') || evt.target.closest('a')) return;
              const profile = row.dataset.profile;
              if(profile) window.location.href = profile;
            });
          });
          resultsEl.querySelectorAll('.parent-provider-btn[data-action="message"]').forEach(btn=>{
            btn.addEventListener('click', (evt)=>{
              evt.preventDefault();
              const pid = btn.dataset.provider;
              const name = btn.dataset.name || 'Caregiver';
              if(window.showChatWidget && pid) window.showChatWidget(pid, name);
            });
          });
          resultsEl.querySelectorAll('.parent-provider-btn[data-action="book"]').forEach(btn=>{
            btn.addEventListener('click', async (evt)=>{
              evt.preventDefault();
              const pid = btn.dataset.provider;
              const name = btn.dataset.name || 'Caregiver';
              if(typeof window.startDashboardBooking === 'function') {
                await window.startDashboardBooking(pid, name, btn);
              }
            });
          });
        });
      };

      const fillProfileForm = (profile) => {
        window.parentProfile = profile || {};
        window.parentHomeAddress = formatHomeAddress(profile);
        parentHasPaymentMethod = !!profile?.stripe_payment_method_id;
        updatePaymentButtonLabel();
        const rawSubscription = String(profile?.subscription_type || '').trim();
        const normalizedType = rawSubscription ? (() => {
          const lower = rawSubscription.toLowerCase();
          if(lower.includes('standard') || lower.includes('basic')) return 'Basic';
          return rawSubscription;
        })() : (profile?.is_premium ? 'Care+ Premium' : 'Basic');
        const sidebarNameEl = document.getElementById('parentSidebarName');
        if(sidebarNameEl){
          if(profile?.name){
            sidebarNameEl.textContent = `Signed in as ${profile.name}`;
            const typePill = document.createElement('span');
            typePill.className = 'provider-card-pill provider-account-pill';
            typePill.textContent = normalizedType;
            sidebarNameEl.appendChild(document.createTextNode(' '));
            sidebarNameEl.appendChild(typePill);
          } else {
            sidebarNameEl.textContent = 'Signed in';
          }
        }
        const firstName = profile?.name ? profile.name.split(' ')[0] : '';
        document.getElementById('parentWelcomeName').textContent = firstName ? `, ${firstName}` : '';
        if(profile?.name) localStorage.setItem('user_name', profile.name);
        if(profile?.city) localStorage.setItem('parent_city', profile.city);
        const setVal = (id, value) => {
          const el = document.getElementById(id);
          if(el) el.value = value || '';
        };
        setVal('parentName', profile?.name);
        setVal('parentEmail', profile?.email);
        setVal('parentPhone', profile?.phone);
        setVal('parentAddress1', profile?.address_line1);
        setVal('parentAddress2', profile?.address_line2);
        setVal('parentCity', profile?.city);
        setVal('parentProvince', profile?.province);
        setVal('parentPostal', profile?.postal_code);
        setVal('parentEmergencyName', profile?.emergency_contact_name);
        setVal('parentEmergencyPhone', profile?.emergency_contact_phone);
        setVal('parentSpouseName', profile?.spouse_name);
        setVal('parentSpousePhone', profile?.spouse_phone);
        const subscription = profile?.subscription_type || (profile?.is_premium ? 'Care+ Premium' : 'Standard');
        setVal('parentSubscription', subscription);
        const locationSelect = document.getElementById('heroLocationInput');
        if(locationSelect && profile?.city){
          const match = Array.from(locationSelect.options).find(option =>
            option.value === profile.city || option.textContent.includes(profile.city)
          );
          if(match) locationSelect.value = match.value;
        }
      };

      const hookProfileSave = () => {
        const form = document.getElementById('parentProfileForm');
        const statusEl = document.getElementById('parentProfileStatus');
        if(!form) return;
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if(!userId) {
            showNotice('Please log in to update your profile.', 'info');
            return;
          }
          const payload = {
            name: document.getElementById('parentName')?.value?.trim() || null,
            phone: document.getElementById('parentPhone')?.value?.trim() || null,
            city: document.getElementById('parentCity')?.value?.trim() || null,
            province: document.getElementById('parentProvince')?.value?.trim() || null,
            address_line1: document.getElementById('parentAddress1')?.value?.trim() || null,
            address_line2: document.getElementById('parentAddress2')?.value?.trim() || null,
            postal_code: document.getElementById('parentPostal')?.value?.trim() || null,
            emergency_contact_name: document.getElementById('parentEmergencyName')?.value?.trim() || null,
            emergency_contact_phone: document.getElementById('parentEmergencyPhone')?.value?.trim() || null,
            spouse_name: document.getElementById('parentSpouseName')?.value?.trim() || null,
            spouse_phone: document.getElementById('parentSpousePhone')?.value?.trim() || null
          };
          if(statusEl) {
            statusEl.textContent = 'Saving...';
            statusEl.style.color = '#9ca3af';
          }
          try {
            const res = await fetch(`${API_BASE}/forms/parent/${userId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error || 'Save failed');
            fillProfileForm(data.profile || payload);
            if(statusEl) {
              statusEl.textContent = 'Saved';
              statusEl.style.color = '#34d399';
            }
            showNotice('Profile saved.', 'success');
          } catch (err) {
            if(statusEl) {
              statusEl.textContent = 'Save failed. Try again.';
              statusEl.style.color = '#f87171';
            }
            showNotice('Could not save profile. Please try again.', 'error');
          }
        });
      };

      const hookInboxPreview = () => {
        const listEl = document.getElementById('parentMessagesList');
        const unreadEl = document.getElementById('parentMessagesUnread');
        const openBtn = document.getElementById('parentMessagesOpenBtn');
        const apply = () => {
          const threads = window.latestThreads || {};
          const unread = window.latestUnread || 0;
          if(unreadEl){
            unreadEl.style.display = unread > 0 ? 'inline-flex' : 'none';
            unreadEl.textContent = `${unread} unread`;
          }
          if(listEl){
            const arr = Object.values(threads);
            if(arr.length === 0){
              listEl.innerHTML = '<div class="provider-bookings-empty">No messages yet.</div>';
            } else {
              const lastTwo = arr.slice(-2);
              listEl.innerHTML = lastTwo.map(t=>{
                const last = t.messages[t.messages.length-1];
                return `
                  <div class="parent-message-item">
                    <div class="parent-message-name">${t.other_name || 'User'}</div>
                    <div class="parent-message-body">${last ? last.body : ''}</div>
                  </div>
                `;
              }).join('');
            }
          }
        };
        apply();
        window.addEventListener('chat-updated', apply);
        if(openBtn){
          openBtn.addEventListener('click', ()=>{
            if(window.showChatWidget) window.showChatWidget();
          });
        }
      };

      const loadParentDashboard = async () => {
        if(!userId){
          showNotice('Please log in to view your dashboard.', 'info');
          setTimeout(() => window.location.href = 'account-signup.html', 1200);
          return;
        }
        try {
          const res = await fetch(`${API_BASE}/forms/parent/${userId}`);
          if(!res.ok) throw new Error('Failed to load dashboard');
          const data = await res.json();
          const profile = data.profile || {};
          const children = Array.isArray(data.children) ? data.children : [];
          const sessions = Array.isArray(data.sessions) ? data.sessions : [];
          const savedFromProfile = Array.isArray(profile.saved_caregivers)
            ? profile.saved_caregivers.map(String)
            : [];
          let savedLocal = [];
          try{
            savedLocal = JSON.parse(localStorage.getItem(savedCaregiversKey) || '[]').map(String);
          }catch(_err){
            savedLocal = [];
          }
          const mergedSaved = savedFromProfile.length ? savedFromProfile : savedLocal;
          window.parentSavedCaregivers = mergedSaved;
          localStorage.setItem(savedCaregiversKey, JSON.stringify(mergedSaved));
          if(!savedFromProfile.length && savedLocal.length){
            updateParentSavedCaregivers(savedLocal);
          }
          window.parentDashboardSessions = sessions;
          fillProfileForm(profile);
          await refreshPaymentStatus();
          togglePaymentNotice(false);
          renderUpcomingBookings(sessions);
          renderCalendar(sessions);
          renderChildren(children);
          await renderCaregivers(sessions, mergedSaved);
        } catch (err) {
          console.error('Parent dashboard load failed', err);
          showNotice('Unable to load dashboard data.', 'error');
        }
      };

      window.addEventListener('DOMContentLoaded', () => {
        hookProfileSave();
        hookInboxPreview();
        setupChildForm();
        loadParentDashboard();
        hookSavedAvailabilitySearch();
      });
    </script>
  </body>
</html>
