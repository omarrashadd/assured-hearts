<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Refer a Friend - Assured Hearts</title>
    <meta name="description" content="Invite friends to Assured Hearts and help them find trusted childcare." />
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><a href="index.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;"><img src="Assets/assured Hearts Logo.png" alt="Assured Hearts Logo"><span>Assured Hearts</span></a></div>
        <div class="nav-links">
          <a href="find-childcare.html">Find Childcare</a>
          <a href="become-provider.html">Join Our Care Network</a>
          <a href="care-process.html">Our Care Process</a>
          <a href="learning.html">At-Home Learning</a>
        </div>
        <div class="nav-auth">
          <a href="parent-dashboard.html" class="btn-auth signup">Dashboard</a>
        </div>
        <button id="mobileMenuBtn" class="mobile-menu" aria-label="Open menu">
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <div id="mobileMenu" class="mobile-menu-panel hidden" aria-hidden="true">
      <button id="mobileMenuClose" class="mobile-menu-close" aria-label="Close menu">&times;</button>
      <nav class="mobile-nav">
        <a href="find-childcare.html">Find Childcare</a>
        <a href="become-provider.html">Join Our Care Network</a>
        <a href="care-process.html">Our Care Process</a>
        <a href="learning.html">At-Home Learning</a>
        <a href="parent-dashboard.html">Dashboard</a>
      </nav>
    </div>

    <header class="hero" style="padding: 56px 16px; background: linear-gradient(135deg, #f4fbfd 0%, #fff7f7 100%);">
      <div class="container" style="max-width: 900px; text-align: center;">
        <h1 style="margin: 0 0 12px 0;">Share Assured Hearts</h1>
        <p class="lead" style="margin: 0; color: #4b5563;">Invite friends to join and help them find trusted childcare in their area.</p>
      </div>
    </header>

    <main class="container" style="max-width: 900px; padding: 32px 16px;">
      <section style="background: #fff; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.06); padding: 24px; display: grid; gap: 20px;">
        <div>
          <h2 style="margin: 0 0 8px 0; color: #06464E;">Send an invite</h2>
          <p style="margin: 0 0 16px 0; color: #6b7280; font-size: 14px;">We’ll email your friend a simple invite with a link to create their account.</p>
          <form id="referralForm" style="display: grid; gap: 12px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
              <label style="display: flex; flex-direction: column; gap: 6px; color: #374151;">
                Your name
                <input type="text" name="senderName" required placeholder="Your name" style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px; color: #374151;">
                Your email
                <input type="email" name="senderEmail" required placeholder="you@example.com" style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
              </label>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
              <label style="display: flex; flex-direction: column; gap: 6px; color: #374151;">
                Friend's name
                <input type="text" name="friendName" required placeholder="Friend's name" style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px; color: #374151;">
                Friend's email
                <input type="email" name="friendEmail" required placeholder="friend@example.com" style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
              </label>
            </div>
            <label style="display: flex; flex-direction: column; gap: 6px; color: #374151;">
              Message (optional)
              <textarea name="message" rows="3" placeholder="I’ve been using Assured Hearts to find caregivers. Thought you might like it too!" style="padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit;"></textarea>
            </label>
            <button type="submit" class="btn" style="background: linear-gradient(135deg, #67B3C2 0%, #06464E 100%); color: #fff; padding: 14px 16px; border: none; border-radius: 10px; font-weight: 700;">Send invite</button>
          </form>
          <div id="referralStatus" style="margin-top: 12px; display: none; font-weight: 600;"></div>
          <div style="margin-top: 4px; color: #6b7280; font-size: 13px;">Referrals sent: <span id="referralCount">0</span></div>
        </div>

        <div style="background: #f8fbfc; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; display: grid; gap: 10px;">
          <h3 style="margin: 0; color: #06464E;">Share your link</h3>
          <p style="margin: 0; color: #6b7280; font-size: 14px;">Copy your personal link to share via text or social.</p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input id="referralLink" type="text" readonly value="https://assuredhearts.com/join?ref=yourname" style="flex: 1; min-width: 240px; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px;">
            <button id="copyReferralLink" class="btn secondary" type="button" style="padding: 12px 14px; border: 1px solid #06464E; background: #fff; color: #06464E; border-radius: 8px; font-weight: 700;">Copy</button>
          </div>
        </div>
      </section>
    </main>

    <footer style="background: #06464E; color: white; padding: 24px; text-align: center;">
      <p style="margin: 0;">© 2025 Assured Hearts. All rights reserved.</p>
    </footer>

    <script>
      // Simple referral form handler (client-side only)
      const referralForm = document.getElementById('referralForm');
      const statusEl = document.getElementById('referralStatus');
      const referralCountEl = document.getElementById('referralCount');
      const API_BASE = window.API_BASE || 'https://assured-hearts-backend.onrender.com';

      // Initialize count from backend if logged in
      (async ()=>{
        const userId = parseInt(localStorage.getItem('user_id'), 10);
        if(!userId || Number.isNaN(userId)) return;
        try{
          const resp = await fetch(`${API_BASE}/forms/parent/${userId}`);
          if(resp.ok){
            const data = await resp.json();
            const fromProfile = data?.profile?.referrals_count;
            if(fromProfile !== undefined && fromProfile !== null){
              localStorage.setItem('referrals_sent_count', String(fromProfile));
            }
          }
        }catch(_err){
          // ignore
        } finally {
          const stored = parseInt(localStorage.getItem('referrals_sent_count') || '0', 10);
          if(referralCountEl) referralCountEl.textContent = isNaN(stored) ? '0' : String(stored);
        }
      })();

      referralForm?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const current = parseInt(localStorage.getItem('referrals_sent_count') || '0', 10) || 0;
        const nextLocal = current + 1;
        const userId = parseInt(localStorage.getItem('user_id'), 10);
        const submitSuccess = ()=>{
          localStorage.setItem('referrals_sent_count', String(nextLocal));
          if(referralCountEl) referralCountEl.textContent = String(nextLocal);
          if(statusEl){
            statusEl.style.display = 'block';
            statusEl.style.color = '#155724';
            statusEl.textContent = 'Invite sent! We’ll email your friend with your message.';
          }
          referralForm.reset();
        };
        if(!userId || Number.isNaN(userId)){
          if(statusEl){
            statusEl.style.display = 'block';
            statusEl.style.color = '#b45309';
            statusEl.textContent = 'Please sign in so we can save your referral.';
          }
          submitSuccess();
          return;
        }
        // Sync to backend
        fetch(`${API_BASE}/forms/referral`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId })
        }).then(async res => {
          const json = await res.json().catch(()=>({}));
          if(res.ok && json.referrals_count !== undefined){
            localStorage.setItem('referrals_sent_count', String(json.referrals_count));
            if(referralCountEl) referralCountEl.textContent = String(json.referrals_count);
          } else if(statusEl){
            statusEl.style.display = 'block';
            statusEl.style.color = '#b91c1c';
            statusEl.textContent = json.error || 'Failed to record referral. Please try again.';
          }
          submitSuccess();
        }).catch(()=>{
          if(statusEl){
            statusEl.style.display = 'block';
            statusEl.style.color = '#b91c1c';
            statusEl.textContent = 'Network error saving referral.';
          }
          submitSuccess();
        });
      });

      // Copy link
      const copyBtn = document.getElementById('copyReferralLink');
      copyBtn?.addEventListener('click', ()=>{
        const link = document.getElementById('referralLink');
        if(!link) return;
        link.select();
        document.execCommand('copy');
        copyBtn.textContent = 'Copied!';
        setTimeout(()=> copyBtn.textContent = 'Copy', 1200);
      });
    </script>
    <script src="script.js"></script>
  </body>
</html>
